Natural Text
Short version: If we use  with  in Python 3 as a replacement for , then the dictionary has to be populated before the creation of the class. However,  requires the class to be known before the creation of the method. How can we add a method to the dictionary of a new class in Python 3?In Python 2, I was used to define new classes with . Here is a minimal working example (for Python 2), where I define a new class  with a method : was removed from the Python 3 C API. I read that  can be used as replacement, for example in the answer of the following question: What is the PyClass_New equivalent in Python 3?However, it appears that the dictionary that  takes for last argument is copied during the creation of the new class: indeed, the fields that are set to  before calling  are available in the instances of the class, but not the fields that are set after the call.That prevents us from using  as above because the class has to be known before creating the method, but the method has to be added to  before creating the class.This dependency loop can be solved by using , since the latter does not take a reference for a class. I obtained thus the following working example (for Python 3, I only give the code for , the preambule and the callback is the same as in the first example).However, I wonder whether I could achieve to write a solution closer to the Python 2 version, using : it should be possible to dynamically change the class after its creation for adding the new method, but I don't figure out how to do that.
You're not actually using the C API for creating types.The normal way to define a type through the C API is by defining your object's layout as a C struct and declaring a global  with  fields defining its properties. This is documented under Extending and Embedding the Python Interpreter: Defining New Types.  is not involved.Using  with  would be analogous to creating a type by calling  manually in Python. In this case, the type's dict should not contain method objects. Just like if you were doing it in Python, the dict should contain Python function objects, and method objects will be created dynamically on attribute access.


Answer URL
https://docs.python.org/3/extending/newtypes.html
