Natural Text
Using Python 3.6.1, Requests 2.13.0, I am getting strange encoding of the URL being requested. I have a URL with Chinese characters in the query string, for example , which should %-encode to  or even , but for some reason it is %-encoding to . This is not correct. I've been using http://r12a.github.io/apps/conversion/ page to help me work the encodings. I've also used JavaScript  and PHP  and don't get anything near what I see the Requests library doing.Am I doing something wrong such that the encoding is so far off?UPDATE:I looked into Mojibake encoding and dug into the Requests library a little more and found out what the problem is, but I'm still not sure how to fix it.I'm making a call against an internal server, using a simple  call. The call goes to the server and gets a redirect response. The redirect page has a  in the header and the URL listed in it is correct. The  header leaving the server is ok; it is encoded as UTF-8 and the  header has a  on it. However, when I debug the redirect response in Python I note that the header on the response object is incorrect, it doesn't seem to be decoded correctly. The  property contains this in : . As said above, it should be decoded as: . So, that strange URL query string get's % encoded by Requests and set back to the server, which then rejects that URL (obviously).Is there something I can do to prevent Requests from messing this up? Or get it to correctly decode the  header? Web browsers don't seem to have trouble with this.
You have a Mojibake encoding. The bytes encoded are those of the Latin-1 interpretation of the UTF-8 bytes:You can reverse the process by manually encoding to Latin-1 again, then decoding from UTF-8:or you could use the  library to automate fixing the wrong encoding ( usually does a much better job, especially when Windows codepages are involved in the Mojibake):You said this about the source of the URL:The location header leaving the server is ok; it is encoded as UTF-8That's your problem, right there. HTTP headers are always encoded as Latin-1(*). The server MUST set the Location header to a fully percent-encoded URL, so that all UTF-8 bytes are represented as  escape sequences. These are just ASCII characters, perfectly save in a Latin-1 context. If your server sends the header as un-escaped UTF-8 bytes, then HTTP clients (including ) will decode that as Latin-1 instead resulting in the exact Mojibake problem you observed. And because the URL contains invalid URL characters,  escapes the Mojibake result to the percent-encoded version. (*) Actually, the  header should be an   as per RFC2396 which is always ASCII (7-bit) clean data, but because some other HTTP headers allow for 'descriptive' text, Latin-1 (ISO-8859-1) is the accepted default encoding for header data. See the  rule in section 2.2 of the HTTP/1.1 RFC, and the  module that ultimately decodes the headers for  follows this RFC in this regard when decoding non-ASCII data in any header. You can provide non-Latin-1 data only if wrapped as per the Message Header Extensions RFC 2047, but this doesn't apply to the  header.


Answer URL
https://docs.python.org/3/library/http.client.html
