Natural Text
I am using Python's mock library along with unittest. I am writing unit tests for a class that uses a function of an external library in one of its methods. Depending on the case, this function returns different values.So let's say I wanna test class A:In my test class, in order to use the values returned by the function from the external library, I create a patch, and only import class A after defining the patch. However, I need to use this function in all my test methods, and in each method it returns different values.My test class is as follows:I have 10 tests and only 1 (the first one) passes when I run all of them together, for the rest, I get  error. However, if I run each one of them individually, they all pass.I have tried using  in each method, but the outcome was the same. I also tried creating only once the patch in the  method, starting it, reassigning the side_effect within each method, and stopping in , but it didn't work.Any ideas on what might work in this case?Thanks!
The caveat is, the second time you import a module, it would not be loaded again, you get the same module object as the first time you imported.When you first run "test_1",  replaced by a  object, let's name it . Then your "module" get imported for the first time, python will load it, means, execute code inside "module", which will bind name "function_foo" to object "mock_a" in the namespace of "module", save "module" object to . This time your test will pass, and  of  get consumed.Next is "test_2",  replaced by a  object, name it to . Then import "module", this time it would not be loaded again, but populate from , you get the same module object as in "test_1". In the namespace of this module object, name "function_foo" is still bound to object , not the newly created . Because  of  has already consumed,  error raised.You should apply patch to where a name is looked up, but not where it is defined:  Read more detail on the "Where to patch" section of the manual of .


Answer URL
https://docs.python.org/3/reference/import.html#the-module-cache
https://docs.python.org/3/library/unittest.mock.html#where-to-patch
