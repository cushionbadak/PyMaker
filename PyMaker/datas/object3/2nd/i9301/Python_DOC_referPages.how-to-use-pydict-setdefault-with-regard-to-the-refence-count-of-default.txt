Natural Text
I'm wondering about how to use  without creating a reference count catastrophe.The documentation doesn't say anything about a stolen reference and some testing shows that it doesn't "steal the reference" of . But it increfs it if and only if the key wasn't present in the dictionary.That seems really complicated to me because it's just too easy to get wrong. I currently use it like this:At the end the dictionary and I own a reference for  and  was cleanly deleted, right?Is there a better way to deal with the situation without explicitly checking if  that I missed? Is it really that complicated or did I miss the obvious and easy way?
It doesn't really matter whether  - whatever happens you take ownership of  (by increfing it) and release ownership of  (by decrefing it, assuming you don't want to use it for anything else).if  is present in the dictionary then  isn't used, so its refcount stays at 1, and it gets destroyed with decref.  is returned with a refcount of 1 (because it's stored in the dictionary) and we increment it because we're using it too so  now has a refcount of 2.If  isn't present then  is stored in the dictionary (refcount now 2) used and returned.  and   are the same. We increment  (refcount 3) the decref  (refcount 2).Either way we end in the same place.


Answer URL
https://docs.python.org/3/c-api/dict.html#c.PyDict_SetDefault
