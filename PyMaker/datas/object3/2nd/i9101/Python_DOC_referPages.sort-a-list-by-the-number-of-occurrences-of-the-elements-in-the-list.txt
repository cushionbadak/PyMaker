Natural Text
I want to sort a list by the number of occurrences of the elements in the list.When I use this form:    the result is not what I want: .But, when I write like it using :    the result is right: .what's the reason for this behavior?
This is by design and intentional. CPython temporarily "disallows" access to the list while the list is being sorted in place, the behavior is documented here:CPython implementation detail: While a list is being sorted, the  effect of attempting to mutate, or even inspect, the list is  undefined. The C implementation of Python makes the list appear empty  for the duration, and raises ValueError if it can detect that the list  has been mutated during a sort.You can inspect that by printing  inside the key function - you'll get an empty list:But, if you do that for :It is also documented inside the  implementation:
It seems that  is changed during the in-place sort process, so you cannot rely on the value of  during the sort process.Making a copy also works.Confirmed by this line in python documentationCPython implementation detail: While a list is being sorted, the effect of attempting to mutate, or even inspect, the list is undefined. The C implementation of Python makes the list appear empty for the duration, and raises ValueError if it can detect that the list has been mutated during a sort.
I believe it's because  is modifying the list in place underneath while computing.  doesn't modify the list and returns therefore a correct result.
The built-in  creates a list out of the sequence provided and then sorts that based on the key argument (omitting error checking):This essentially translates to something like what Jean provided in his answer:By making that copy  and referencing  in the  function, this removes the restriction imposed by  which can't peek in itself.


Answer URL
https://docs.python.org/3/library/stdtypes.html#list.sort
https://docs.python.org/3/library/stdtypes.html#list
