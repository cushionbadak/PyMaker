Natural Text
I have a question on how to properly use  on PyList in C. So let say I have a function called  which accepts a string linked list as its input argument and returns a Python list if everything goes well, or  if there is an error.Below is the minimalistic example:Have I used  correctly in this case?My particular question is:If a few elements have been appended to the list before an error occur, my code will decrement the reference to the list directly (inside ) while the elements inside the list technically still have refcount of 1. Should I instead decrement each element's reference first before I finally decrement the reference to the list?Thank you.
After creating the , it has a refcount of 1. Each  is born with a refcount of 1 and appending it to the list increases that to 2 (because the  and your function reference it). So it's correct to  after the , as your function no longer uses the  itself.Inside both error paths (, ), ing the -object will free the object (because it's refcount is now 0). The -object will walk it's members and  every one of them, reducing the refcount of each  to 0, freeing them.Long story short: Your code is correct. The elements inside the list must have a refcount of (at least) 1, because the list is referring to them. It's the 's exclusive responsibility to  it's members.As an exercise, you may try reducing the strings' refcounts yourself. The interpreter will most likely crash (maybe at ), because when the list is freed, the strings' refcounts go to -1, triggering an assertion.


Answer URL
https://docs.python.org/3/c-api/intro.html#reference-count-details
