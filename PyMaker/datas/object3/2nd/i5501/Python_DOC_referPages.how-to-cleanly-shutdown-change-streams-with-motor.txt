Natural Text
TL; DRThis was indeed a bug in Motor 1.2.0 that was promptly fixed by A. Jesse Jiryu Davis and is available in version 1.2.1 or greater of the driver.Original QuestionI wrote a program to monitor changes to a MongoDB collection using its new Change Stream feature, on Python 3. Here's the MCVE:When I kill the program with CRTL+C, it raises three different exceptions.Is there a way to make that program close silently?I'm testing with Python 3.6.4, Motor 1.2 and pymongo 3.6.0 on macOS Sierra.
I think your code is correct, problem on 's side.While investigating I found two problems:If at the moment you close loop connection is not established, you'll get  error since loop closed before async callbacks done. It seems not to be related to async generators or streams, but to any  usage. async iteration mechanism (_next function) is written without thinking of case when it cancelled. Try of setting exception to cancelled future leads to .This code demonstrates two problems and possible workarounds:It finishes without warnings/exceptions (on my machine at least) due to added fixes.I don't recommend you to use hacks above! It's only to demonstrate problem places and possible solutions. I'm not sure it does everything properly.Instead I advice you to create issue at motor user group / Jira appending there your snippet and probably my answer and wait until bug would be fixed.


Answer URL
https://docs.python.org/3/library/asyncio-eventloop.html#asyncio.AbstractEventLoop.shutdown_asyncgens
