Natural Text
The following code tries to create-then-import two modules:On Windows, both imports work under Python 2 (2.7), but not under Python 3 (3.5 and 3.6):Adding time.sleep(5) before each import printX call makes it work.Why is that?Note: This is a simpler version of an issue I'm trying to figure out.
I think I know what is going on. The new Python 3 import machinery caches the filenames it finds in directories. It will reload the cache when the mtime, the modification time, of the directory changes.See the importlib._bootstrap_external.FileFinder.find_spec() method implementation, which contains:Here _path_stat is just a os.stat() call, but localised to avoid imports. The _fill_cache() method executes the os.listdir() call.On some Windows filesystems, the resolution of mtime is notoriously low, up to 2 seconds. For your case, the resolution is apparently still low enough for the cache to not be updated by the time you try to load the second module. Although the NTFS filesystem can record times in 100ns increments, in practice the limiting factor there appears to be the Windows system clock, which I understand is usually limited to a resolution of 15ms. So if you write print2.py within 15ms of writing print1.py, then Python won't notice.Python does give you the means to clear this cache; use the importlib.invalidate_caches() method; this will reset the _path_mtime attribute on the FileFinder instance back to -1, forcing a new _fill_cache() call.As the function's documentation states:This function should be called if any modules are created/installed while your program is running to guarantee all finders will notice the new moduleâ€™s existence.


Answer URL
https://docs.python.org/3/library/importlib.html#importlib.invalidate_caches
