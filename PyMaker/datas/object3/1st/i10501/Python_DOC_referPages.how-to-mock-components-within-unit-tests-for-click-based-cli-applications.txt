Natural Text
I'm not sure if this is the best fit for here or the Programmers Stack Exchange, but I'll try here first and cross-post this over there if it's not appropriate.I've recently developed a web service and I'm trying to create a Python-based command-line interface to make it easier to interact with. I've been using Python for a while for simple scripting purposes but I'm inexperienced at creating full-blown packages, including CLI applications.I've researched different packages to help with creating CLI apps and I've settled on using click. What I'm concerned about is how to structure my application to make it thoroughly testable before I actually go about putting it all together, and how I can use click to help with that.I have read click's documentation on testing as well as examined the relevant part of the API and while I've managed to use this for testing simple functionality (verifying --version and --help work when passed as arguments to my CLI), I'm not sure how to handle more advanced test cases.I'll provide a specific example of what I'm trying to test right now. I'm planning for my application to have the following sort of architecture......where the CommunicationService encapsulates all logic involved in connecting and directly communicating with the web service over HTTP. My CLI provides defaults for the web service hostname and port but should allow users to override these either through explicit command-line arguments, writing config files or setting environment variables:I want to test that if the user specifies different hostnames and ports, then Controller will instantiate a CommunicationService using these settings and not the defaults.I imagine that the best way to do this would be something along these lines:If I can get advice on how to properly handle this case, I should hopefully be able to pick it up and use the same technique for making every other part of my CLI testable.For what it's worth, I'm currently using pytest for my tests and this is the extent of the tests I've got so far:
I think I've found one way of doing it. I stumbled across Python's unittest.mock module, and after a bit of playing around with it I ended up with the following.In my 'comms' module, I define CommunicationService:This is a production class and the print statement will eventually get replaced with the actual communication logic.In my main module, I make my top-level command instantiate this communication service and try to establish communications:And then the fun part. In my test suite I define this test case:This temporarily replaces the CommunicationService.establish_communication method with an instance of MagicMock, which will perform no real logic but will record how many times it's called, with what arguments, etc. I can then invoke my CLI and make assertions about how it tried to establish communications based on the supplied command-line arguments.Having worked with projects written primarily in statically-typed languages like Java and C#, it never would have occurred to me that I could just monkey patch methods of my existing production classes, rather than create mock versions of those classes and find a way to substitute those in. It's pretty convenient.Now if I were to accidentally make it so that my CLI ignored explicit user-provided overrides for the hostname and port......then I have my handy test case to alert me:


Answer URL
https://docs.python.org/3/library/unittest.mock.html
