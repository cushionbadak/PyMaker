Natural Text
I am trying to parse an RSS feed. Entries in the feed have date elements like:Using feedparser, I try to do:But the problem is that I seem to be getting the wrong time stored in the database. In this particular case, the datetime is stored as:... when I would expect 14:00 - the correct UTC time.I assume the problem is in our django settings, where we have:Because when I switch to:... the datatime is stored as correct UTC time:Is there any way to keep the django settings as they are, but to parse and store this datetime correctly, without the django timezone setting affecting it?EDIT:Maybe it's more clear like this...
feedparser's entry.published_parsed is always a utc time tuple whatever the input time string is. To get timezone-aware datetime object:where utc is a tzinfo object such as datetime.timezone.utc, pytz.utc, or just your custom tzinfo (for older python versions).You shouldn't pass utc time to mktime() that expects a local time. Same error: Have a correct datetime with correct timezone.Make sure USE_TZ=True so that django uses aware datetime objects everywhere. Given a timezone-aware datetime object, django should save it to db correctly whatever your TIME_ZONE or timezone.get_current_timezone() are. 
Have you tried using datetime.utcfromtimestamp() instead of datetime.fromtimestamp()?As a secondary solution, you can get the unparsed data (I believe it's available as entry.published?) and just use python-dateutil to parse the string, then convert it to pytz.utc timezone like this.
UseFeedparser can parse a large range of date formats, you can find them here.As you can see in feedparser/feedparser/datetimes/__init__.py, the built-in function from Feedparser _parse_date does the following:Parses a variety of date formats into a 9-tuple in GMTThis means that in parsed_entry.published_parsed you have a time.struct_time object in GMT timezone.When you convert it to a datetime object usingthe problem is that mktime assumes that the passed tuple is in local time, which is not, it's GMT/UTC! Other than that you don't properly localize the datetime object at the end of the conversion.You need to replace that conversion with the following, remembering that Feedparser returns a GMT struct_time, and localize that with the timezone you like (UTC for the sake of simplicity).You use calendar.timegm, which gives the number of seconds between epoch and the date passed as a parameter, assuming that the passed object is in UTC/GMT (we know from Feedparser it is)You use utcfromtimestamp to obtain a naive datetime object (which we know represents a datetime in UTC, but Python does not at this moment)With pytz.utc.localize you properly localize in UTC the datetime object.Example:As long as you are consistent, it doesn't matter if you use fromtimestamp or utcfromtimestamp. If you use fromtimestamp you need to tell Python that the datetime object you created has the local timezone. Supposing you are in Europe/Berlin, this is also fine:Were parsed_entry.published_parsed also in local timezone, mktime must be used in place of calendar.timegm.As an alternative you can parse yourself the data string you get from Feedparser parsed_entry['published']You can check that the following returns True:The Django TIME_ZONE setting doesn't actually matter, because it's used only for visualization purposes or to automatically convert naive datetimes.When USE_TZ is True, this is the default time zone that Django will use to display datetimes in templates and to interpret datetimes entered in forms.What is important is to always use properly localized datetimes, no matter which time zone is used. As long as they are not in naive format, they will be properly handled by Django.


Answer URL
https://docs.python.org/3/library/datetime.html#datetime.timezone.utc
