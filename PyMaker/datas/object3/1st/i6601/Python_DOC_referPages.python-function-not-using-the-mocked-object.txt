Natural Text
Coming from a PHP background I have encountered the following issue in writing Python unit tests:I have function foo that uses a Client object in order to get a response from some other API:For this I have created the following unit test in another python file.I don't understand why foo isn't using the mocked [1,2,3] list and instead tries to connect to the actual API path in order to pull the real data.What am I missing?
You are doing 3 things wrong:You are patching the wrong location. You need to patch the yyyy.Client global, because that's how you imported that name.The code-under-test is not calling Client(), it uses a different method, so the call path is different.You are calling the code-under-test outside the patch lifetime. Call your code in the with block.Let's cover this in detail:When you use from xxxx import Client, you bind a new reference Client in the yyyy module globals to that object. You want to replace that reference, not xxxx.Client. After all, the code-under-test accesses Client as a global in it's own module. See the Where to patch section of the unittest.mock documentation.You are not calling Client in the code. You are using a class method (.get_client_auth()) on it. You also then use the return value as a context manager, so what is assigned to client is the return value of the __enter__ method on the context manager:You need to mock that chain of methods:You need to call the code under test within the with block, because only during that block will the code be patched. The with statement uses the patch(...) result as a context manager. When the block is entered, the patch is actually applied to the module, and when the block exits, the patch is removed again.Last, but not least, when trying to debug such situations, you can print out the Mock.mock_calls attribute; this should tell you what was actually called on the object. No calls made? Then you didn't patch the right location yet, forgot to start the patch, or called the code-under-test when the patch was no longer in place.However, if your patch did correctly apply, then MockClient.mock_calls will look something like:
You need to patch the Client object in the file where it is going to be used, and not in its source file. By the time, your test code is ran, the Client object would already have been imported into the file where you are hitting the API.Moreover, since you're patching a context manager you need to provide a stub.


Answer URL
https://docs.python.org/3/library/unittest.mock.html#where-to-patch
https://docs.python.org/3/library/unittest.mock.html#unittest.mock.Mock.mock_calls
