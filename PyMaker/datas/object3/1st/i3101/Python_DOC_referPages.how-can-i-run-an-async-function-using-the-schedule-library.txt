Natural Text
I'm writing a discord bot using discord.py rewrite, and I want to run a function every day at a certain time.  I'm not experienced with async functions at all and I can't figure out how to run one without using "await."  This is only a piece of my code which is why some things may not be defined.Using the schedule.every().day.at("00:00").do() function, I get this error when I put await send_channel() in the paramaters of .do():self.job_func = functools.partial(job_func, *args, **kwargs)  TypeError: the first argument must be callableBut when I don't use await, and I just have send_channel() as parameters, I get this error:RuntimeWarning: coroutine 'send_channel' was never awaitedI'm not super good at programming so if someone could try to dumb it down for me that would be awesome.Thanks
What you're doing doesn't work because do takes a function (or another callable), but you're trying to await or call a function, and then pass it the result.await send_channel() blocks until the send finishes and then gives you None, which isn't a function. send_channel() returns a coroutine that you can await later to do some work, and that isn't a function either.If you passed it just send_channel, well, that is a function, but it's an ascynio coroutine function, which schedule won't know how to run.Also, rather than trying to integrate schedule into the asyncio event loop, and figure out how to wrap async jobs up as schedule tasks and vice versa and so on, it would far easier to just give schedule its own thread.There's a FAQ entry on this:How to continuously run the scheduler without blocking the main thread?Run the scheduler in a separate thread. Mrwhick wrote up a nice solution in to this problem here (look for run_continuously()).The basic idea is simple. Change your timer function to this:Do this at the start of your program, before you even start your asyncio event loop.At exit time, to stop the scheduler thread:Now, to add a task, it doesn't matter whether you're in your top-level code, or in an async coroutine, or in a scheduler task, you just add it like this:Now, back to your first problem. The task you want to run isn't a normal function, it's an asyncio coroutine, which has to be run on the main thread as part of the main event loop.But that's exactly what call_soon_threadsafe is for. What you want to call is:To ask scheduler to run that, you just pass bot.loop.call_soon_threadsafe as the function and send_channel as the argument.So, putting it all together:
This is an old question, but I recently ran into the same issue. You can use run_coroutine_threadsafe to schedule a coroutine to the event loop (rather than a callback):


Answer URL
https://docs.python.org/3/library/asyncio-dev.html#concurrency-and-multithreading
https://docs.python.org/3/library/asyncio-task.html#asyncio.run_coroutine_threadsafe
