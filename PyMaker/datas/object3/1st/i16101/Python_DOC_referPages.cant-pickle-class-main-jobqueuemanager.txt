Natural Text
I am encountering a picklability problem in this code (also attached below). I have read relevant posts [1] [2] but I can not find usefull correspodences. Could you please give an explanation or solution of this error?Below these is the part of the code that returns the error:Thanks!PS: Python 2.7.7, Win 7 
As best as I can tell, to make this pattern work on Windows, you need to create a picklable queue.Queue. You can do that by creating a child class of Queue that defines __setstate__ and __getstate__, and have it only pickle the pieces of state that we actually need to send between processes, and leave the other stuff (unpicklable internal locks) out.The other changes we need to make are to move the custom Manager class definitions to the top-level, and to not use lambda functions as the argument to callable. Instead, we use a partial and a top-level function, because that can be pickled. Here's the final code:
You need to have Queue.Queue pickleable, as well as your lambda functions, and your JobQueueManager.To do that, I think you can be very lazy about it, and all you need to do is to get the dill package and import dill.I didn't test on windows, but it should work as below. dill is available here: https://github.com/uqfoundation.
The multiprocessing library gives you a solution out of the box - multiprocessing.Queue which should be automatically picklable everywhere, even on Windows (and works as far back as 2.7).Trying to make Queue.Queue picklable seems like a bad idea to me.  You aren't going to get one queue that you can use from two different processes - you're going to get an independent copy of that queue in the other process.  If you wanted to have a copy of the current state of the queue in another process, it'd be much less work to extract all the elements in the queue as a plain old list which pickles for free (if all the elements are picklable), send the list over, and then reconstitute a new Queue.Queue on the other side.Also, as I imagine you have discovered by now, you cannot pickle local lambdas - how would that even work?  Instead, create a function global to that namespace, and send that global function over, with the required data.
Try:Moving the definition of the class to where pickle can find it should allow pickling. Pickle will look in the __main__ module for the class, but with your code, it cannot find it, as it is inside the function.However, as pointed out in the comments, the manager shouldn't need to be pickled, so another object must be dragging it in, such as a function containing the manager in its globals.


Answer URL
https://docs.python.org/3/library/pickle.html#object.__getstate__
