Natural Text
I am trying to use weakref.finalize to handle the destruction of objects according to https://docs.python.org/3.6/library/weakref.html#comparing-finalizers-with-del-methodsHowever, the objects are never collected by Python's garbage collector, so I cannot test what I am doing. weakref.finalize is only called, when the script finishes (see atexit).But I cannot find out, what blocks garbage collect.See the following example:objgraph only shows the weak references which should not matter (I only added it afterwards to check for references). gc.get_referrers shows a dictionary, is this related to globals or locals?Solution according to @user2357112's answer:
You've got two issues here. First, in the finalize call:The callback and arguments shouldn't own references to the object being finalized. Since you've made obj one of the callback arguments directly, the object can't be collected:Note: It is important to ensure that func, args and kwargs do not own any references to obj, either directly or indirectly, since otherwise obj will never be garbage collected. In particular, func should not be a bound method of obj.You might wonder how you're supposed to access the object, then. The answer is that you're not supposed to access the object. The object is supposed to be dead.The second issue is that in the following line:w_fp is the weak reference object, not its referent. You should be using w_fp().


Answer URL
https://docs.python.org/3/library/weakref.html#weakref.finalize
