Natural Text
I have written a python package which I have managed to make fully compatible with both python 2.7 and python 3.4, with one exception that is stumping me so far. The package includes a command line script, and in my unit tests I use this code to run the script's main routine while overriding sys.argv to pass command line arguments for argparse, and capturing the script's stdout for comparison:This works well in python 3.4, but in python 2.7 it generates an error:I haven't managed to figure out a way to capture stdout from arbitrary functions which is portable between python 2.7 and python 3.4.As an aside, I have to admit that I don't understand decorations, context managers or the "yield" keyword very well at all. The inspiration for my runmain() function came from:http://schinckel.net/2013/04/15/capture-and-test-sys.stdout-sys.stderr-in-unittest.testcase/Incidentally, my complete package where this code comes from is here:https://github.com/NF6X/pyImageDiskAt the moment, its unit tests are partially broken under python 2.7 because of this issue. Can anybody help me figure out how to solve this stdout redirection problem in a portable, pythonic manner, preferably without adding any more external dependencies?
You replaced the Python 2 bytes-only sys.stdout with one that only takes Unicode. You'll have to adjust your strategy on the Python version here, and use a different object:and remove the io. prefix in your context manager:The cStringIO.StringIO object is the Python 2 equivalent of io.BytesIO; it requires that you write plain bytestrings, not aunicode objects.You can also use io.BytesIO in Python 2, but then you want to test if sys.stdout is a io.TextIOBase subclass; if it is not, replace the object with a binary BytesIO, object, otherwise use a StringIO object:
Have your tried? (Can be left in your code under Python 3.x)Else what I have in my code to make it compatible when using io.StringIO:Looking at your code then:Could be changed to:


Answer URL
https://docs.python.org/3/library/io.html#io.TextIOBase
