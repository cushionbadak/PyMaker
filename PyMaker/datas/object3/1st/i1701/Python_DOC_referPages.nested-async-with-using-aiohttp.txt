Natural Text
I would like to create a scheduler class that uses aiohttp to make API calls. I tried this:but this just results in an error: RuntimeError: Session is closed. A second approach for the __aenter__ function:works well. Is this a good construct? It doesn't adhere to examples of how to use aiohttp. Also wondering why the first approach isn't working?
You can't use with inside a function and have the context manager remain open, no. The with with aiohttp.ClientSession() as session: block exits as soon as you use return to exit the __aenter__ coroutine!For the specific case, entering a aiohttp.ClientSession() context manager does nothing but return self. So for that type, just creating the instance and storing it in self.session, and awaiting on self.session.close() suffices here, yes.The general pattern for a nested asynchronous context manager is to await the __aenter__ and __aexit__ methods of a nested async context manager from your own such methods (and perhaps pass along the exception information):Technically speaking, you should first assure that there is an actual __aexit__ attribute before entering a nested context manager:See the official PEP that added the concept.
You can manage that dependency externally:When that async with chain becomes too ridiculous you can use AsyncExitStack:


Answer URL
https://docs.python.org/3/library/contextlib.html#contextlib.AsyncExitStack
