Natural Text
I work with a number of json-like dicts. pprint is handy for structuring them. Is there a way to cause all ints in a pprint output to be printed in hex rather than decimal?For example, rather than:I'd rather see:I have tried customizing PrettyPrinter, but to no avail, was I able to cause the above, having PrettyPrinter.format() handle integers only seems to work for some of the integers:the above class producesThe list contents are not correctly formatted.
You can alter the output of pprint, but you need to re-implement the saferepr() function, not just subclass the pprint.PrettyPrinter() class.What happens is that (an internal version of) the saferepr() function is used for all objects, and that function itself then recursively handles turning objects into representations (using only itself, not the PrettyPrinter() instance), so any customisation has to happen there. Only when the result of saferepr() becomes too large (too wide for the configured width) will the PrettyPrinter class start breaking up container output into components to put on separate lines; the process of calling saferepr() is then repeated for the component elements.So PrettyPrinter.format() is only responsible for handling the top-level object, and every recursive object that is a) inside a supported container type (dict, list, tuple, string and the standard library subclasses of these) and b) where the representation of the parent container produced by .format() exceeded the display width.To be able to override the implementation, we need to understand how the .format() method and the saferepr() implementation interact, what arguments they take and what they need to return.PrettyPrinter.format() is passed additional arguments, context, maxlevels and level:context is used to detect recursion (the default implementation returns the result of _recursion(object) if id(object) in context is true.when maxlevels is set and level >= maxlevels is true, the default implementation returns ... as the contents of a container.The method is also supposed to return a tuple of 3 values; the representation string and two flags. You can safely ignore the meaning of those flags, they are actually never used in the current implementation. They are meant to signal if the produced representation is 'readable' (uses Python syntax that can be passed to eval()) or was recursive (the object contained circular references). But the  PrettyPrinter.isreadable() and PrettyPrinter.isrecursive() methodsactually completely bypass .format(); these return values seem to be a hold-over from a refactoring that broke the relationship between .format() and those two methods. So just return a representation string and whatever two boolean values you like..format() really just delegates to an internal implementation of saferepr() that then does several thingshandle recursion detection with context, and depth handling for maxlevels and levelrecurse over dictionaries, lists and tuples (and their subclasses, as long as their __repr__ method is still the default implementation)for dictionaries, sort the key-value pairs. This is trickier than it appears in Python 3, but this is solved with a custom _safe_tuple sorting key that approximates Python 2's sort everything behaviour. We can re-use this.To implement a recursive replacement, I prefer to use @functools.singledispatch() to delegate handling of different types. Ignoring custom __repr__ methods, handling depth issues, recursion, and empty objects, can also be handled by a decorator:This hand-full can handle anything the base pprint implementation can, and it will produce hex integers in any supported container. Just create an instance of the HexIntPrettyPrinter() class and call .pprint() on that:Side note: as of Python 3.7 you can drop the (<type>) call part of the @saferepr.registation(<type>) decorators; the type is picked up from the annotations instead.


Answer URL
https://docs.python.org/3/library/pprint.html#pprint.saferepr
https://docs.python.org/3/library/pprint.html#pprint.PrettyPrinter.format
https://docs.python.org/3/library/functools.html#functools.singledispatch
