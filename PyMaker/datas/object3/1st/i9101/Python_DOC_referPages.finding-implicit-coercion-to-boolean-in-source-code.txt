Natural Text
How can I find all implicit conversions to boolean in source code? This includes conditional statements like if x, loops like while x, operators like x or y, etc.; but not if x == 0 or if len(x) == 0, etc. I don't mind using a static analyzer, or IDE, or a regular expression, or a python library designed for this purpose. Of course there will be some false positives, when x is actually boolean; that's fine.Use case: I found bugs caused by coercion to boolean. For example, a variable x was supposed to be an integer or None and was incorrectly tested with if not x implying if x is None. I want to make all boolean conversions explicit (e.g., replacing if not x with if x is None or if x == 0, etc.). Of course, it would have to be done manually, but at least identifying the locations where implicit conversion occurs would be helpful.
I'd suggest you take a look at the standard ast module. Here is some trivial code:And here is the output:Eli Bendersky has written an article on working with AST's, and he includes some sample code for visiting the nodes of an AST. You would want to do a visit where you looked for particular constructions. In the example above, you'd be looking for (sub)expressions beneath an If node where an operand was either directly treated as a boolean, or treated as the sole operand to a Not() node.Finding every possible case could be quite complex. But I think you can easily find the "simple" cases (if x, if not x, if x or y) with a page or two of code.EDIT: Here's some code that (I think) does what you want. And here's the output:
My first idea was to decorate the built-in bool function, but for some reason, this did not work with Python 3.4.Therefore, I propose a solution, when the full set of the potentially used classes is known: basically decorate the __bool__ method of every class.I just assumed that classes was an iterable containing the targeted classes. You can probably populate it dynamically.If you execute this code at the startup, every boolean coercion will print "Coercion to boolean".Just a short test:
Actually, there's a typing library that does precisely this. It works for both python 2 and python 3.See mypy, use command --strict-boolean.I move the accepted answer to this one, even though @AustinHastings has a very useful answer about how one could do it using ast, because I want people to be aware of mypy - it's a great tool (not likely to be abandoned any time soon, with 100+ contributors, including Guido).


Answer URL
https://docs.python.org/3/reference/grammar.html
