Natural Text
Code keeps throwing a segmentation fault when I import the module from Python. Not too sure why this is happening as I'm really new to C and C Extensions. I'm not sure if I'm doing my setup.py code correctly either. I think the error is related to my returning the pos_list variable and math.h not being included properly. When I removed the math.h sin and cos stuff and switched to Py_BuildValue a simple integer, it works.
There may be multiple problems here, but, assuming the module boilerplate is correct (you haven't included it), and your setup.py is correct to actually build the code (it isn't as posted), and you're calling this in the obvious way, there's at least one likely segfault here:As PyTuple_Pack documents:Return a new tuple object of size n, or NULL on failure. The tuple values are initialized to the subsequent n C arguments pointing to Python objects.You're not passing it pointers to Python objects, you're passing it doubles. So, it will try to interpret each double as a pointer, which is very likely to segfault.1You either need to construct two Python float objects with PyFloat_FromDouble, or Py_BuildValue to convert them on the fly:A completed and cleaned-up version with this fix seems to work.1. If you don't know enough C, but want to know why it crashes: Assuming 64-bit here, you're asking it to interpret the 64 bits of the double as a pointer. For, say, -2.0, that's a pointer to 0xC000000000000000. Which is likely to not be in allocated memory, much less a pointer to a valid PyObject struct whose pointers themselves point to allocated memory, and even if all such pages are allocated, it's likely that one of them pages will be readonly so, e.g., a reference count increment fails.


Answer URL
https://docs.python.org/3/c-api/tuple.html#c.PyTuple_Pack
https://docs.python.org/3/c-api/float.html#c.PyFloat_FromDouble
https://docs.python.org/3/c-api/arg.html#c.Py_BuildValue
