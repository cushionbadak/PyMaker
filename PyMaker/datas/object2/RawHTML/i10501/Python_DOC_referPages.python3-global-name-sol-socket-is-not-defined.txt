<div class="post-text" itemprop="text">
<p>when I use <code>gevent</code>, I can not use <code>requests</code>, is my useage wrong?</p>
<pre><code>from gevent import monkey; monkey.patch_all()
import gevent, requests
requests.get('https://haofly.net')
</code></pre>
<p>it raise the error:</p>
<pre><code>Traceback (most recent call last):
File "&lt;stdin&gt;", line 1, in &lt;module&gt;
File "/usr/local/lib/python3.3/site-packages/requests/api.py", line 70, in get
  return request('get', url, params=params, **kwargs)
File "/usr/local/lib/python3.3/site-packages/requests/api.py", line 56, in request
  return session.request(method=method, url=url, **kwargs)
File "/usr/local/lib/python3.3/site-packages/requests/sessions.py", line 475, in request
  resp = self.send(prep, **send_kwargs)
File "/usr/local/lib/python3.3/site-packages/requests/sessions.py", line 596, in send
  r = adapter.send(request, **kwargs)
  File "/usr/local/lib/python3.3/site-packages/requests/adapters.py", line 423, in send
    timeout=timeout
  File "/usr/local/lib/python3.3/site-packages/requests/packages/urllib3/connectionpool.py", line 595, in urlopen
    chunked=chunked)
File "/usr/local/lib/python3.3/site-packages/requests/packages/urllib3/connectionpool.py", line 352, in _make_request
  self._validate_conn(conn)
File "/usr/local/lib/python3.3/site-packages/requests/packages/urllib3/connectionpool.py", line 831, in _validate_conn
  conn.connect()
File "/usr/local/lib/python3.3/site-packages/requests/packages/urllib3/connection.py", line 289, in connect
  ssl_version=resolved_ssl_version)
File "/usr/local/lib/python3.3/site-packages/requests/packages/urllib3/util/ssl_.py", line 308, in ssl_wrap_socket
  return context.wrap_socket(sock, server_hostname=server_hostname)
File "/usr/local/lib/python3.3/site-packages/gevent/_ssl3.py", line 60, in wrap_socket
  _context=self)
File "/usr/local/lib/python3.3/site-packages/gevent/_ssl3.py", line 143, in __init__
  if sock.getsockopt(SOL_SOCKET, SO_TYPE) != SOCK_STREAM:
NameError: global name 'SOL_SOCKET' is not defined
</code></pre>
<p>The version of my Python is 3.3</p>
<p>If I add <code>ssl=False</code> to <code>monkey.patch_all()</code>, it returns:</p>
<pre><code>Traceback (most recent call last):
  File "&lt;stdin&gt;", line 1, in &lt;module&gt;
  File "/usr/local/lib/python3.3/site-packages/requests/api.py", line 70, in get
    return request('get', url, params=params, **kwargs)
  File "/usr/local/lib/python3.3/site-packages/requests/api.py", line 56, in request
    return session.request(method=method, url=url, **kwargs)
  File "/usr/local/lib/python3.3/site-packages/requests/sessions.py", line 475, in request
    resp = self.send(prep, **send_kwargs)
  File "/usr/local/lib/python3.3/site-packages/requests/sessions.py", line 596, in send
    r = adapter.send(request, **kwargs)
  File "/usr/local/lib/python3.3/site-packages/requests/adapters.py", line 423, in send
    timeout=timeout
  File "/usr/local/lib/python3.3/site-packages/requests/packages/urllib3/connectionpool.py", line 595, in urlopen
    chunked=chunked)
  File "/usr/local/lib/python3.3/site-packages/requests/packages/urllib3/connectionpool.py", line 352, in _make_request
    self._validate_conn(conn)
  File "/usr/local/lib/python3.3/site-packages/requests/packages/urllib3/connectionpool.py", line 831, in _validate_conn
    conn.connect()
  File "/usr/local/lib/python3.3/site-packages/requests/packages/urllib3/connection.py", line 289, in connect
    ssl_version=resolved_ssl_version)
  File "/usr/local/lib/python3.3/site-packages/requests/packages/urllib3/util/ssl_.py", line 308, in ssl_wrap_socket
    return context.wrap_socket(sock, server_hostname=server_hostname)
  File "/usr/local/lib/python3.3/ssl.py", line 245, in wrap_socket
    _context=self)
  File "/usr/local/lib/python3.3/ssl.py", line 335, in __init__
    server_hostname)
TypeError: _wrap_socket() argument 1 must be _socket.socket, not SSLSocket
</code></pre>
</div>
<div class="post-text" itemprop="text">
<p>This is really a bug in gevent. It is trying to import a <a href="https://docs.python.org/3/library/socket.html#constants" rel="nofollow"><code>socket</code> constant</a> from the <code>ssl</code> library.</p>
<p>That specific constant <em>happens</em> to be imported into the <code>ssl</code> library because that library makes use of it. But it is only there because a fix for <a href="http://bugs.python.org/issue19422" rel="nofollow">issue 19422</a> required it to be imported in to the <code>ssl</code> module. The fix for that bug was included in Python 3.3.4, and you have version 3.3.3 and you thus don't have that specific constant available in the <code>ssl</code> module as well.</p>
<p>You could just fix it by adding <code>from socket import SOL_SOCKET, SO_TYPE</code> in <code>gevent/_ssl3.py</code> (located in the <code>/usr/local/lib/python3.3/site-packages</code> directory on your system). Or you can upgrade to Python 3.3.4 or newer. </p>
<p>I've filed this as <a href="https://github.com/gevent/gevent/issues/856" rel="nofollow">issue #856</a> with the <code>gevent</code> project.</p>
</div>
<div class="post-text" itemprop="text">
<p>Install the Python 3.5 version can fix this problem.</p>
</div>
<span class="comment-copy">Interesting. That name would have been found on the <code>ssl</code> module and imported. I see Python 3.3 is supported; what version of openssl do you have installed?</span>
<span class="comment-copy">@MartijnPieters	 you mean the linux package openssl? my openssl is openssl-1.0.1e-48.el6_8.1.x86_64, CentOS 6.8</span>
<span class="comment-copy">The issue is that apparently <code>from ssl import SOL_SOCKET</code> fails for your installation. Why that is I don't fully understand. Perhaps you have a shadow <code>ssl</code> module somewhere? <code>import ssl; print(ssl.__file__)</code> should print a system location, for example.</span>
<span class="comment-copy">@MartijnPieters when <code>import ssl; print(ssl.__file__)</code>, it says the location,but <code>cat /usr/local/lib/python3.3/ssl.py | grep SOL_SOCKET</code> return nothing, there is no <code>SQL_SOCKET</code> in my ssl.py, how it happend</span>
<span class="comment-copy">@MartijnPieters Oh, I found that my install package of my 3.3 contain ssl.py, but it do not contain the <code>SOL_SOCKET</code>, but I download it from <code>http://www.python.org/ftp/python/3.3.3/Python-3.3.3.tar.xz</code></span>
