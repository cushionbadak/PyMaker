<div class="post-text" itemprop="text">
<p>I have a Flask app running inside a Docker container running under a swarm. When I use <code>url_for</code> to create an external url for the API, it returns the docker service name rather than the absolute path.</p>
<p>Ex.</p>
<pre class="lang-py prettyprint-override"><code>endpoint = url_for('api_v1.get_me_the_data', sn=123, 
                _external=True, _scheme="https")
</code></pre>
<p>returns something like <code>https://app-primary:8000/api/v1/devices/123</code>. </p>
<p>Other details:</p>
<ul>
<li>running using Gunicorn behind an Nginx reverse proxy</li>
</ul>
<p>I've tried playing with the <code>SERVER_NAME</code>, but no dice. Is there an easy way to fix this? Or should I write a wrapper function for <code>url_for</code>?</p>
</div>
<div class="post-text" itemprop="text">
<p>As you have the python application inside a container and also behind Nginx, then you might need to go with <a href="http://werkzeug.pocoo.org/docs/0.14/contrib/fixers/#werkzeug.contrib.fixers.ProxyFix" rel="nofollow noreferrer">ProxyFix</a>, it will do two things:</p>
<ul>
<li>Getting the Client IP instead of nginx container IP by reading <code>REMOTE_ADDR</code></li>
<li>Setting the Hostname by reading <code>HTTP_HOST</code></li>
</ul>
<p>Next you need to make sure that nginx sends these Headers:</p>
<pre><code>proxy_set_header Host            $host;
proxy_set_header X-Real-IP $remote_addr;
proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
</code></pre>
</div>
<span class="comment-copy">How was your attempt with <code>SERVER_NAME</code> ? was it equal to the actual domain name ? was it inside flask config ?</span>
<span class="comment-copy">Inside the flask config, as "localhost:5000" when running locally</span>
<span class="comment-copy">I don't see an issue with having the docker service name in the url as long as you are behind nginx, unless you mean that nginx is remote not in a container within the same network</span>
<span class="comment-copy">Yea, it works great for internal routing, but it's not terribly useful to return this as a url to a customer as a response from an API. Basically, for paginating results, I return the next and prev url's, but they're not going to be too happy with this result, they need the <code>app-primary</code> to be converted to the actual domain. I can write a wrapper function, but was wondering if this is a common issue for people...</span>
<span class="comment-copy">I see, So if you make it something like this <code>current_app.config['SERVER_NAME'] = 'example.com'</code> and keeping <code>external true</code>, it wont work, right ? note that it should be before creating  context</span>
