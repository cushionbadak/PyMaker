<div class="post-text" itemprop="text">
<p>After following the example <a href="https://docs.python.org/3/library/unittest.mock-examples.html#mocking-a-dictionary-with-magicmock" rel="nofollow noreferrer">Mocking a Dictionary with MagicMock</a> I have the following mock setup:</p>
<pre><code>mock_writer = Mock()
mock_reader = Mock()
mock_format = Mock()
mock_option = Mock()
mock_load = MagicMock()

test_dict = {"Bus_No": Mock(), "Team_No": Mock()}

def getitem(name):
    return test_dict[name]

mock_load.__getitem__.side_effect = getitem

mock_option.load.return_value = mock_load
mock_format.option.return_value = mock_option
mock_reader.format.return_value = mock_format
mock_reader.write.return_value = mock_writer
mock_spark = Mock()
mock_spark.read.return_value = mock_reader

Driver(mock_spark).run()
</code></pre>
<p>And here is the driver class:</p>
<pre><code>def __init__(self, spark):
    self.spark = spark

def run(self):

    partition_names = ["Bus_No", "Team_No"]

    df = self.spark.read\
        .format("com.databricks.spark.avro")\
        .option("avroSchema", schema)\
        .load("{0}{1}*.avro".format(job.SourcePath, os.path.sep))

    partition_columns = [df[x] for x in partition_names]
</code></pre>
<p>And then it returns this error:</p>
<pre><code>partition_columns = [df[x] for x in partition_names]
TypeError: 'Mock' object has no attribute '__getitem__'
</code></pre>
</div>
<div class="post-text" itemprop="text">
<p>Turns out that because <code>read</code> is not a method I should not be using <code>return_value</code> from <code>mock_spark.read</code>. Here's the change:</p>
<pre><code>mock_spark.read = mock_reader
</code></pre>
</div>
<span class="comment-copy">What's the self.spark object you're referring to?</span>
<span class="comment-copy">It's a reference to the <code>mock_spark</code> object. The mock is passed into the <code>__init__</code> method of the class where it is assigned to <code>self.spark</code>.</span>
