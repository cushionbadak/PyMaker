<div class="post-text" itemprop="text">
<p>I have read <a href="https://stackoverflow.com/questions/129507/how-do-you-test-that-a-python-function-throws-an-exception">this</a> Q&amp;A, and already try to catch exception on my code that raise an IntegrityError exception, this way :</p>
<pre><code>self.assertRaises(IntegrityError, db.session.commit())
</code></pre>
<p>But somehow my unit test still failed and stop with IntegrityError exception. I expect it to say OK as I already expect to have exception in my unit test.
This was cause by code that tries to insert row having the same unique field values.</p>
<p>Any idea?</p>
</div>
<div class="post-text" itemprop="text">
<p>One of these will to the trick:</p>
<pre><code># ... only if version &gt;= 2.7
with self.assertRaises(IntegrityError):
    db.session.commit()
</code></pre>
<p>Or:</p>
<pre><code>self.assertRaises(IntegrityError, db.session.commit)
</code></pre>
<p>The difference between your example and the correct way is:</p>
<pre><code># Your example: You call db.session.commit(), this will raise an exception before
# assertRaises is called
self.assertRaises(IntegrityError, db.session.commit())

# Correct way: Pass what should be called to assertRaises, 
# let assertRaises invoke it and check for exception
self.assertRaises(IntegrityError, db.session.commit)
</code></pre>
<p>I prefer to use <a href="http://docs.python.org/3/library/unittest.html#unittest.TestCase.assertRaises" rel="noreferrer">assertRaises</a> as a context manager (using <code>with</code>).</p>
</div>
<span class="comment-copy">Phew.. this solved and brighten my day! Thanks! :) Right, I was thinking earlier that the argument accept function name, not call of the function. But, somehow I miss that when I do the actual code. But, why do you prefer to use a context manager? Isn't with this single line the result will be the same?</span>
<span class="comment-copy">Added comment,I just use context manager as you pointed out, and I think the other benefit is that we can expand/refine our code much more in that indented block. I am still new in python, so that's what I am getting :)</span>
<span class="comment-copy">I agree. I think using assertRaises as a context manager makes the test code clearer.</span>
