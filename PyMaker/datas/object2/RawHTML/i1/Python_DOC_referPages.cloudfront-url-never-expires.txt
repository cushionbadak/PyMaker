<div class="post-text" itemprop="text">
<p>Scenerio:
I am trying to generate cloudfront signed urls to objects in s3.</p>
<p>STEPS:<br/>
 1. created an object in s3 bucket and made it public.<br/>
 2. created a cloudfront distribution pointing to that s3 bucket.<br/>
 3. generated the signed url using the code below</p>
<p>The following is the code to generate cloudfront signed urls from their <a href="https://boto3.amazonaws.com/v1/documentation/api/latest/reference/services/cloudfront.html#generate-a-signed-url-for-amazon-cloudfront" rel="nofollow noreferrer">docs</a>.</p>
<pre><code>import datetime

from cryptography.hazmat.backends import default_backend
from cryptography.hazmat.primitives import hashes
from cryptography.hazmat.primitives import serialization
from cryptography.hazmat.primitives.asymmetric import padding
from botocore.signers import CloudFrontSigner


def rsa_signer(message):
    with open('path/to/key.pem', 'rb') as key_file:
        private_key = serialization.load_pem_private_key(
        key_file.read(),
        password=None,
        backend=default_backend()
       )
    return private_key.sign(message, padding.PKCS1v15(), hashes.SHA1())

key_id = 'AKIAIOSFODNN7EXAMPLE'
url = 'https://d2949o5mkkp72v.cloudfront.net/hello.txt'
expire_date = datetime.datetime(2017, 1, 1)

cloudfront_signer = CloudFrontSigner(key_id, rsa_signer)

# Create a signed url that will be valid until the specfic expiry date
# provided using a canned policy.
signed_url = cloudfront_signer.generate_presigned_url(url, date_less_than=expire_date)
print(signed_url)
</code></pre>
<p>output:</p>
<pre><code>https://d2949o5mkkp72v.cloudfront.net/hello.txt?Expires=1483228800&amp;Signature=some_signature&amp;Key-Pair-Id=AKIAIOSFODNN7EXAMPLE
</code></pre>
<p>The above url is pointing to a date back in time but I am still able to access the object via this URL. Also I can access the object by truncating the Signature and Key-Pair-Id query params.</p>
<p>What could have gone wrong here?</p>
</div>
<div class="post-text" itemprop="text">
<p>I found the solution to the problem. The error was actually not in the code but in the configuration of cloudfront distribution.</p>
<p>The following configuration was missing:
<a href="https://i.stack.imgur.com/Z29r7.png" rel="nofollow noreferrer"><img alt="cloudfront signed url config option" src="https://i.stack.imgur.com/Z29r7.png"/></a></p>
<p>Hopefully it helps :)</p>
</div>
