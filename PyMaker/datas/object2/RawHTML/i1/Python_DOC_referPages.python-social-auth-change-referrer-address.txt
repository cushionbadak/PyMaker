<div class="post-text" itemprop="text">
<p>I have an Azure Application Gateway (lets say example.com), behind which I have a few Azure App Services (example1.com, example2.com, etc).</p>
<p>I am using python social auth to authenticate my django app. The issue is that when I click login from example.com, and it forwards that request to example1.com, the login request happens from example1.com. </p>
<p>If I specify a OAuth callback addresses as </p>
<blockquote>
<p>example.com/complete/azuread-oauth2,  </p>
<p>example1.com/complete/azuread-oauth2, and</p>
<p>example2.com/complete/azuread-oauth2,</p>
</blockquote>
<p>it doesn't work, social auth gives me the error:</p>
<pre><code>raise AuthStateForbidden(self)
social_core.exceptions.AuthStateForbidden: Wrong state parameter given.
</code></pre>
<p>This might be because of the referrer site being example.com, but the actual request going from example1.com, though I am not sure. Is there any way to fix it so that the redirection doesnt happen to example1.com, and I can hide example1.com behind example.com?</p>
</div>
<div class="post-text" itemprop="text">
<p>The <code>python-social-auth</code> Django strategy uses <a href="https://docs.djangoproject.com/en/2.1/ref/request-response/#django.http.HttpRequest.build_absolute_uri" rel="nofollow noreferrer"><code>request.build_absolute_uri(...)</code></a> method, which depends on <a href="https://docs.djangoproject.com/en/2.1/ref/request-response/#django.http.HttpRequest.get_host" rel="nofollow noreferrer"><code>request.get_host(...)</code></a> in order to retrieve the current host the URL should be point to.</p>
<p>When your setups is behind a proxy (or behaves like that), you need to ensure that the destination server knows the originating host source in order to setup the proper URL. Check the <code>get_host()</code> documentation, it lists the different options that must be set to make that possible.</p>
</div>
<span class="comment-copy">Thanks Omab! I set the USE_X_FORWARDED_HOST setting in django and changed the HTTP_X_FORWARDED_HOST header, and it worked! The App Service was removing the header from the Azure Gateway for some reason, so I had to hardcode the host name, but atleast it works now.</span>
<span class="comment-copy">This still fails when I run django with Debug=False. Trying to figure out why that is</span>
