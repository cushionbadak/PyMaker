<div class="post-text" itemprop="text">
<p>What's the correct way to use HTTPAdapter with Async programming and calling out to a method? All of these requests are being made to the same domain.</p>
<p>I'm doing some async programming in Celery using eventlet and testing the load on one of my sites. I have a method that I call out to which makes the request to the url. </p>
<p>def get_session(url):
    # gets session returns source
    headers, proxies = header_proxy()
    # set all of our necessary variables to None so that in the event of an error
    # we can make sure we dont break
    response = None
    status_code = None
    out_data = None
    content = None</p>
<pre><code>try:
    # we are going to use request-html to be able to parse the
    # data upon the initial request

    with HTMLSession() as session:
        # you can swap out the original request session here
        # session = requests.session()
        # passing the parameters to the session
        session.mount('https://', HTTPAdapter(max_retries=0, pool_connections=250, pool_maxsize=500))
        response = session.get(url, headers=headers, proxies=proxies)
        status_code = response.status_code
        try:
            # we are checking to see if we are getting a 403 error on all requests. If so,
            # we update the status code
            code = response.html.xpath('''//*[@id="accessDenied"]/p[1]/b/text()''')
            if code:
                status_code = str(code[0][:-1])
            else:
                pass
        except Exception as error:
            pass
            # print(error)
        # assign the content to content
        content = response.content
except Exception as error:
    print(error)
    pass
</code></pre>
<p>If I leave out the <code>pool_connections</code> and <code>pool_maxsize</code> parameters, and run the code, I get an error indicating that I do not have enough open connections. However, I don't want to unnecessarily open up a large number of connections if I dont need to. </p>
</div>
<div class="post-text" itemprop="text">
<p>based on this... <a href="https://laike9m.com/blog/requests-secret-pool_connections-and-pool_maxsize,89/" rel="nofollow noreferrer">https://laike9m.com/blog/requests-secret-pool_connections-and-pool_maxsize,89/</a> Im going to guess that this applies to the host and not so much the async task. Therefore, I set the max number to the max number of connections that can be reused per host. If I hit a domain several times, the connection is reused.</p>
</div>
<span class="comment-copy">How does this relate to Celery?</span>
<span class="comment-copy">async done in celery with eventlet. <code>Celery worker -l info -n apple --concurrency=100 --pool=eventlet</code></span>
<span class="comment-copy">updated to state how I am using celery, thanks!</span>
