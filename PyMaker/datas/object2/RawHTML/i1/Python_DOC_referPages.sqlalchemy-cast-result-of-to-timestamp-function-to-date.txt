<div class="post-text" itemprop="text">
<p>I have a database of test records with one column 'test_time' defined as datetime. I want to query how many distinct dates there are as I want to dump test results to csv according to dates. I now have the following:</p>
<pre><code>distinct_dates = list(session.query(Test_Table.test_time).distinct())
</code></pre>
<p>But this gives me a list of datetime not date. Certainly I can convert it in Python but when I am using sqlite. I did this <code>SELECT DISTINCT DATE(test_time) FROM Test_Table</code>. I cannot come up with the equivalent in sqlalchemy. </p>
</div>
<div class="post-text" itemprop="text">
<p>That would be by using the <a href="https://docs.sqlalchemy.org/en/latest/core/sqlelement.html#sqlalchemy.sql.expression.cast" rel="nofollow noreferrer"><code>cast()</code></a> expression:</p>
<pre><code>from sqlalchemy import cast, Date

distinct_dates = session.query(cast(Test_Table.test_time, Date)).distinct().all()
</code></pre>
<p>or the <a href="https://docs.sqlalchemy.org/en/latest/core/sqlelement.html#sqlalchemy.sql.expression.ColumnElement.cast" rel="nofollow noreferrer">shortcut method</a>:</p>
<pre><code>distinct_dates = session.query(Test_Table.test_time.cast(Date)).distinct().all()
</code></pre>
<p>and if using SQLite, give this a shot:</p>
<pre><code>distinct_dates = session.query(func.DATE(Test_Table.test_time)).distinct().all()
</code></pre>
</div>
<span class="comment-copy">Without looking at the sourcecode I would imagine this ends up using the DATE() expression in sql... there is a possibility it doesn't do that, but I have faith in sqlalchemy.</span>
<span class="comment-copy">I tried <code>cast</code> before. But sqlalchemy always throws me this exception: <code>ValueError: Couldn't parse date string '2013' - value is not a string.</code></span>
<span class="comment-copy">I seemed to have figured out why. I am using sqlite. I turned on echo of sqlalchemy and the actual query is <code>SELECT DISTINCT CAST(test_table.test_time AS DATE) AS anon_1 FROM test_table</code>. And it seems that sqlite does not support DATE. Instead of returning whole date, it returns only year. Thanks!</span>
<span class="comment-copy">However, if I run the raw query <code>SELECT DISTINCT DATE(test_table.test_time) AS test_date FROM test_table</code>, it will give me whole dates. This <a href="http://sqlite.1065341.n5.nabble.com/CAST-td23755.html" rel="nofollow noreferrer">link</a> talked about the weirdness about casting sqlite datetime to date.</span>
<span class="comment-copy">interesting, there should be an expression that will get this done...</span>
