<div class="post-text" itemprop="text">
<p>I am trying to find an efficient way of multiplying each column combination within a pandas dataframe.  I have managed to achieve this with itertools, however when the size of the dataframe increases it dramatically slows down.  I am going to need to perform this on a dataframe with a size of about (100,1000)</p>
<p>Example of working code with smaller dataframe below,</p>
<pre><code>import numpy as np
import pandas as pd
from itertools import combinations_with_replacement

df = pd.DataFrame(np.random.randn(3, 10))
new_df = pd.DataFrame()

for p in combinations_with_replacement(df.columns,2):
        title = p
        new_df[title] = df[p[0]]*df[p[1]]  
</code></pre>
<p>Does anybody have any suggestions on how this could be achieved?</p>
</div>
<div class="post-text" itemprop="text">
<p>Combining index view and <code>array.prod(axis)</code>, this runs ~100 times faster:</p>
<pre><code>def f1():
    #with loop
    new_df = pd.DataFrame()
    for p in combinations_with_replacement(df.columns,2):
            title = p
            new_df[title] = df[p[0]]*df[p[1]]
    return new_df

def f2():
    n = len(df.columns)
    ix = np.indices((n,n))[:, ~np.tri(n, k=-1, dtype=bool)]
    return pd.DataFrame(df.values.T[ix.T].prod(1).T, columns=list(map(tuple, ix.T)))
</code></pre>
</div>
<span class="comment-copy">I guess it has to be <code>O(n^2)</code> complexity since no calculation can be saved.</span>
<span class="comment-copy">In instances where the dataframe has column values that aren't just the index location, how do I set the new column headers to show the results of what has been multiplied.  For example, if the df is as follows;  df = pd.DataFrame(np.random.randn(3, 10), columns=['a','b','c','d','e','f','g','h','j','k'])  I would want to see ('a', 'b') as a column, rather than (0,1)</span>
<span class="comment-copy">Use <code>columns = list(map(tuple, np.array(['a','b','c','d','e','f','g','h','j','k'])[ix.T]))</code>. Note the <code>list(map(tuple</code> is just for creating tuples for column headers, the <code>np.array(...)[ix.T]</code> is for creating the array of letter combinations.</span>
