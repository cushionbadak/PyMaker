<div class="post-text" itemprop="text">
<p>I am using <a href="https://docs.python.org/3/library/logging.handlers.html#httphandler" rel="nofollow noreferrer">HTTPHandler</a> to send logging messages to a Django Web server with The following code, </p>
<pre><code>import logging
import logging.handlers

logger = logging.getLogger(__name__)

_TARGET = '192.168.8.100:8000'
_PATH = '/VideoParser/lYYDownloaderClientLog/'

sh = logging.handlers.HTTPHandler(_TARGET, _PATH)

logger.addHandler(sh)
logger.error('testing remote logging')
</code></pre>
<p>but The server side shows http 400 and Invalid HTTP_HOST header message like this </p>
<blockquote>
<p>Invalid HTTP_HOST header: '192.168.8.100:8000,192.168.8.100'. The
  domain name pr ovided is not valid according to RFC 1034/1035.
  [05/Apr/2017 10:43:14] "GET
  /VideoParser/lYYDownloaderClientLog/?relativeCreated
  =117.00654029846191&amp;thread=5468&amp;levelname=ERROR&amp;exc_info=None&amp;exc_text=None&amp;proc
  ess=8920&amp;filename=a.py&amp;msecs=39.52503204345703&amp;stack_info=None&amp;levelno=40&amp;proces
  sName=MainProcess&amp;msg=testing+remote+logging&amp;module=a&amp;threadName=MainThread&amp;line
  no=26&amp;created=1491360192.039525&amp;funcName=%3Cmodule%3E&amp;args=%28%29&amp;name=<strong>main</strong>&amp;
  pathname=C%3A%5CUsers%5Ci%5CDocuments%5CTencent+Files%5C2281570025%5CFileRecv%5C
  a.py HTTP/1.1" 400 68137</p>
</blockquote>
<p>while request from browser with url </p>
<blockquote>
<p><a href="http://192.168.8.100:8000/VideoParser/lYYDownloaderClientLog/?filename=log55.p%20y&amp;levelno=40&amp;relativeCreated=88.00482749938965&amp;funcName=%3Cmodule%3E&amp;thread=7144%20&amp;stack_info=None&amp;module=log55&amp;args=%28%29&amp;exc_text=None&amp;pathname=D%3A%5CBaiduYun%20Download%5C%E7%BC%96%E7%A8%8B%5CPython%5Clog55.py&amp;levelname=ERROR&amp;msecs=668.0548%20191070557&amp;threadName=MainThread&amp;process=6664&amp;name=root&amp;lineno=34&amp;msg=yahoo+Serve%20r+Exception&amp;exc_info=None&amp;processName=MainProcess&amp;created=1491225161.6680548" rel="nofollow noreferrer">http://192.168.8.100:8000/VideoParser/lYYDownloaderClientLog/?filename=log55.p%20y&amp;levelno=40&amp;relativeCreated=88.00482749938965&amp;funcName=%3Cmodule%3E&amp;thread=7144%20&amp;stack_info=None&amp;module=log55&amp;args=%28%29&amp;exc_text=None&amp;pathname=D%3A%5CBaiduYun%20Download%5C%E7%BC%96%E7%A8%8B%5CPython%5Clog55.py&amp;levelname=ERROR&amp;msecs=668.0548%20191070557&amp;threadName=MainThread&amp;process=6664&amp;name=root&amp;lineno=34&amp;msg=yahoo+Serve%20r+Exception&amp;exc_info=None&amp;processName=MainProcess&amp;created=1491225161.6680548</a></p>
</blockquote>
<p>could actually send a good request to The server , The server shows The following in this case</p>
<pre><code>----666666666666--- &lt;QueryDict: {'stack_info': ['None'], 'levelno': ['40'], 'arg
s': ['()'], 'exc_info': ['None'], 'created': ['1491225161.6680548'], 'process':
['6664'], 'levelname': ['ERROR'], 'exc_text': ['None'], 'module': ['log55'], 'ms
ecs': ['668.0548 191070557'], 'name': ['root'], 'processName': ['MainProcess'],
'lineno': ['34'], 'thread': ['7144 '], 'msg': ['yahoo Serve r Exception'], 'func
Name': ['&lt;module&gt;'], 'threadName': ['MainThread'], 'filename': ['log55.p y'], 'p
athname': ['D:\\BaiduYun Download\\编程\\Python\\log55.py'], 'relativeCreated':
['88.00482749938965']}&gt;
[05/Apr/2017 10:45:26] "GET /VideoParser/lYYDownloaderClientLog/?filename=log55.
p%20y&amp;levelno=40&amp;relativeCreated=88.00482749938965&amp;funcName=%3Cmodule%3E&amp;thread=
7144%20&amp;stack_info=None&amp;module=log55&amp;args=%28%29&amp;exc_text=None&amp;pathname=D%3A%5CB
aiduYun%20Download%5C%E7%BC%96%E7%A8%8B%5CPython%5Clog55.py&amp;levelname=ERROR&amp;msec
s=668.0548%20191070557&amp;threadName=MainThread&amp;process=6664&amp;name=root&amp;lineno=34&amp;ms
g=yahoo+Serve%20r+Exception&amp;exc_info=None&amp;processName=MainProcess&amp;created=149122
5161.6680548 HTTP/1.1" 200 27
</code></pre>
<p>so what's wrong with my code using <a href="https://docs.python.org/3/library/logging.handlers.html#httphandler" rel="nofollow noreferrer">HTTPHandler</a> to send logging messages to a Django Web server  ?</p>
<p>As I have tested: If I pass the IP address of my web server to the host parameter of HTTPHandler, the server side would show http 400 and Invalid HTTP_HOST header message, there are also exceptions , pasted here <a href="https://bpaste.net/show/f2d2e64e7a7e" rel="nofollow noreferrer">https://bpaste.net/show/f2d2e64e7a7e</a> , while if I pass the domain name instead, then the view function works as expected . 
so would it be a bug within HTTPHandler? </p>
<p>related code For debug </p>
<p>django-test\LYYDownloaderServer\VideoParser\urls.py</p>
<pre><code>from django.conf.urls import url
from . import views
app_name = 'VideoParser'
urlpatterns = [
    url(r'lYYDownloaderClientLog.+',views.lYYDownloaderClientLog, name='lYYDownloaderClientLog')
]
</code></pre>
<p>django-test\LYYDownloaderServer\VideoParser\views.py</p>
<pre><code>def lYYDownloaderClientLog(request):
    print('----666666666666---', request.GET)
    return HttpResponse("")  # The server *successfully* processed the request and is not returning any content.
</code></pre>
</div>
<div class="post-text" itemprop="text">
<p>I meet the same problem when I use Django receive log, finally I dont solve it, but i known the problem is. </p>
<pre><code>Invalid HTTP_HOST header: '127.0.0.1:8888,127.0.0.1'. The domain name provided is not valid according to RFC 1034/1035.
</code></pre>
<p>according to the output, I check the source code of <code>logging.handlers.HTTPHandler</code>, and in this class, function <code>emit</code> will instance <code>http.client.HTTPSConnection</code> or <code>http.client.HTTPConnection</code> then execute <code>putrequest</code> and <code>putheader</code>, but in the <code>putrequest</code> will execute <code>putheader</code> to, because the port != 80, the host is <code>host:port</code></p>
<pre><code>                if port == self.default_port:
                    self.putheader('Host', host_enc)
                else:
                    host_enc = host_enc.decode("ascii")
                    self.putheader('Host', "%s:%s" % (host_enc, port))
</code></pre>
<p>so I guess if you use Nginx and 80 port, maybe you can resolve the problem</p>
<p>update:
Finally I resolve it. I make a new class <code>LogHTTPHandler</code>, inherit the HTTPHandler, then rewrite the function <code>emit</code> and comment out <code>h.putheader("Host", host)</code></p>
<pre><code>from logging.handlers import HTTPHandler

class LogHTTPHandler(HTTPHandler):
    def emit(self, record):
        ......
        i = host.find(":")
        if i &gt;= 0:
            host = host[:i]
        # h.putheader("Host", host)
        if self.method == "POST":
            h.putheader("Content-type",
                        "application/x-www-form-urlencoded")
            h.putheader("Content-length", str(len(data)))
        ......
</code></pre>
</div>
<span class="comment-copy">Looks like the domain name is wrong. Did you type it right?</span>
<span class="comment-copy">@LeonardoChirivì sorry for that, I updated with the corresponding sever message this time.</span>
<span class="comment-copy">is 192.168.8.100 added to allowed_host?</span>
<span class="comment-copy">@LeonardoChirivì added, but the issue remains ,I usual give ALLOWED_HOSTS = ['*']</span>
<span class="comment-copy">Great investigation ! I used to test the program on my local machine , so raised the error message , but when I tested it on a remote server which run s on nginx/1.4.4, no error message at all, so maybe you got the right point. If this was a bug in Python , please report it, thanks !</span>
<span class="comment-copy">someone already submitted the bug <a href="https://bugs.python.org/issue30904" rel="nofollow noreferrer">bugs.python.org/issue30904</a></span>
