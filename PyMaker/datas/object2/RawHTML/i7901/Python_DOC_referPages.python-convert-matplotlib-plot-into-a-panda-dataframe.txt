<div class="post-text" itemprop="text">
<p>Does anyone know how to convert a matplotlib plot into a panda dataframe (either as a PNG or a JPG) without having to save the graphic to a file first. The code here for SQL Server 2017 outputs a varbinary(max) <a href="https://docs.microsoft.com/en-us/sql/advanced-analytics/tutorials/sqldev-py3-explore-and-visualize-the-data" rel="nofollow noreferrer">https://docs.microsoft.com/en-us/sql/advanced-analytics/tutorials/sqldev-py3-explore-and-visualize-the-data</a> using pandas and pickle but it is not recognised by SSRS as a valid PNG (or JPG) graphic. The aim to is get Python graphics into SSRS the same way as we do for R graphics via sp_execute_external_script in SQL and a varbinary(max) output.</p>
</div>
<div class="post-text" itemprop="text">
<p>The heart of your problem has nothing to do with the <code>pandas</code> dataframe per se - the dataframe is only the container of a pickled object here.</p>
<p>Instead of pickling the figure, my guess is you should save the figure to a Python file-like object like <a href="https://docs.python.org/3/library/io.html#io.StringIO" rel="nofollow noreferrer">io.StringIO (Python 3)</a> or <a href="https://docs.python.org/2/library/stringio.html" rel="nofollow noreferrer">Stringio (python 2)</a></p>
<pre><code>import matplotlib
matplotlib.use("Agg")
import matplotlib.pyplot as plt
import pandas as pd
import pickle

fig_handle = plt.figure()
plt.hist(InputDataSet.tipped)
plt.xlabel("Tipped")
plt.ylabel("Counts")
plt.title("Histogram, Tipped")

output_PNG = io.StringIO()
fig_handle.savefig(output_PNG)

OutputDataSet = output_PNG
</code></pre>
<p>If the PNG must be contained in a <code>pandas</code> dataframe, that can be done too, but I don't know if this data will make much sense...:</p>
<pre><code>plot0 = pd.DataFrame(data =[output_PNG], columns =["plot"])
OutputDataSet = plot0
</code></pre>
<p>Whenever you return <code>OutputDataSet</code> now as a <code>varbinary(max)</code>, my guess is the contents will be exactly the PNG file.</p>
<p>Curious to hear if this works!</p>
</div>
<span class="comment-copy">If you've got the byte stream for the image from your sql, perhaps you just need to supply the header information for your browser?</span>
<span class="comment-copy">Milo - thanks - but all the information must be in the byte stream panda dataframe/varbinary(max) - that is the way SSRS works when calling a stored procedure for the graphic</span>
<span class="comment-copy">Yes sorry I didn't expect it to be that simple. I don't know much about the conversions between those systems. If you figure it out, post the answer and I'll upvote for learning a little more about them.</span>
<span class="comment-copy">Cool - no it's not simple :-( Over 2000 views on my equivalent LinkedIn post and no answer yet!!!!</span>
<span class="comment-copy">unfortunately, fig_handle.savefig(output_PNG) gives an error: string argument expected got bytes - I met this error when I was experimenting - now, if we could fix that, that would be perfect - I do not have enough Python knowledge to know the fix - many thanks for trying</span>
<span class="comment-copy">so I tried BytesIO - but still no joy with converting to data frame in the correct format</span>
<span class="comment-copy">over a year later, I revisited the problem - and now have it working with BytesIO and get_value() - thanks vstrien for your initial input which eventually provided the clue</span>
