<div class="post-text" itemprop="text">
<p>I'm new to Python programming and i had a question around Multiprocessing in loops which must maintain position. In my example, i'm traversing multiple AWS IAM accounts, and creating an excel workbook, with multiple worksheets, one for each account. Within the context of each account worksheet, i need to return a bunch of permissions pertaining to the current account only.</p>
<p>However, the processing time needed to go through each bucket is very long as there can be upwards for 400k files in each bucket. But the calls themselves aren't very taxing on the host system. So i'm looking to go through 4-6 buckets at a time, but still have them write out to their respective sheets properly.</p>
<p>I've been unable to find an example that does something similar. Could one of you fine chaps point me in the right direction. My pseudo code is below. I'm doing this in Python 2.7 TIA!</p>
<pre><code>accounts = get_aws_iam_accounts()

for account in accounts:
    Add_worksheet_to_workboook(account)

    buckets = get_s3_bucket_list()

    for bucket in buckets:
        acl = get_s3_bucket_acl(BucketName=bucket)
            permission = acl.get('Grantee').get('URI')

            if permission != None
                write_permission_to_worksheet(permission)
</code></pre>
</div>
<div class="post-text" itemprop="text">
<p>Use <a href="https://docs.python.org/3/library/concurrent.futures.html" rel="nofollow noreferrer">thread pool</a>:</p>
<pre><code>accounts = get_aws_iam_accounts()

with ThreadPoolExecutor(max_workers=4) as executor: # configure number of threads

    for account in accounts:
        Add_worksheet_to_workboook(account)

        buckets = get_s3_bucket_list()

        for bucket in buckets:
            executor.submit(write_perm_to_worksheet, bucket)


def write_perm_to_worksheet(bucket):
    acl = get_s3_bucket_acl(BucketName=bucket)
    permission = acl.get('Grantee').get('URI')
    if permission != None
        write_permission_to_worksheet(permission)
</code></pre>
<p>In this example <code>executor.submit</code> will schedule a <code>write_permission_to_worksheet</code> execution with <code>permission</code> argument.</p>
<p><code>executor.submit</code> doesn't wait until submitted task will finishes and returns right after the task was scheduled.</p>
<p>To make sure all tasks are finished you have to invoke <code>executor.shutdown(wait=True)</code> however this call is guaranteed to be made by nice <code>with ThreadPoolExecutor(max_workers=4) as executor:</code> statement</p>
<p>So thread pool manages attaching a new task to working thread, switching thread to a new task and shutting down all worker threads if you ask for it.</p>
<p>P.S. about your comment: you better use threads, not processes. Memory is not shared between processes, os prevents one process from access another process memory space. Common resources accessing (which I assume your worksheet to be) could be a very tricky problem for processes. On the other side all threads started by one process share same memory. </p>
</div>
<span class="comment-copy">Let me also tack on that i'm not sure if Threading or Multiprocessing is better. I'm open to hearing suggestions on that as well. Thanks.</span>
<span class="comment-copy">Sergey, thank you for your thorough reply. But the taxing portion is on the line: acl = get_s3_bucket_acl(BucketName=bucket), how does one do the executors on something which has to return something?</span>
<span class="comment-copy">@mumbles you can submit 3 operations(<code>get_s3_bucket_acl</code>, get permission from it, write it to worksheet) as a single task, can't you?</span>
<span class="comment-copy">@mumbles actually <code>executor.submit(...)</code> returns <code>future</code> object. It has <code>result()</code> method, but it obviously blocks</span>
<span class="comment-copy">@mumbles I made the answer fit conditions</span>
