<div class="post-text" itemprop="text">
<p>Am looking for a generic validator module to assist in sanitizing data and importantly, giving back an error log stating why data has been rejected. Am working primarily with CSV files each with an average of 40 columns and with about 40,000 rows. A CSV file would have a mixture of Personal Identifying Information, Contact Information and details about the Account they hold with us w</p>
<p>E.g.</p>
<p><code>First Name|Last Name|Other Name|Passport Number|Date of Birth|Phone Number|Email Address|Physical Address|Account Number|Invoice Number|Date Opened|Amount Due|Date Due|etc|etc</code></p>
<p>I need to validate basic stuff like <code>data type</code>, <code>data length</code>, <code>options/choices</code>, <code>ranges</code>, <code>mandatory fields</code> etc. Also there are conditional validations e.g. if an <code>Amount Due</code> value has been provided, then the <code>Date Due</code> must also be provided. If it hasn't then I raise an error.</p>
<p><strong><a href="https://github.com/daveoncode/pyvaru" rel="nofollow noreferrer">Pyvaru</a></strong> provides some basic validation classes. Is it possible to implement both this scenarios of basic validation plus conditional validation with pyvaru? If yes, how would I structure the validations. Must I create objects e.g. Identifier Objects, then Account Objects for me to use pyvaru?</p>
</div>
<div class="post-text" itemprop="text">
<p>Pyvaru validates python objects (class instances and collections like dictionaries, lists and so on), so starting from a CSV I would convert each record into a dictionary using the <a href="https://docs.python.org/3/library/csv.html#csv.DictReader" rel="nofollow noreferrer">DictReader</a>.
So, given a CSV like:</p>
<pre><code>policyID,statecode,county,eq_site_limit,hu_site_limit,fl_site_limit,fr_site_limit,tiv_2011,tiv_2012,eq_site_deductible,hu_site_deductible,fl_site_deductible,fr_site_deductible,point_latitude,point_longitude,line,construction,point_granularity
119736,FL,CLAY COUNTY,498960,498960,498960,498960,498960,792148.9,0,9979.2,0,0,30.102261,-81.711777,Residential,Masonry,1
448094,FL,CLAY COUNTY,1322376.3,1322376.3,1322376.3,1322376.3,1322376.3,1438163.57,0,0,0,0,30.063936,-81.707664,Residential,Masonry,3
206893,FL,CLAY COUNTY,190724.4,190724.4,190724.4,190724.4,190724.4,192476.78,0,0,0,0,30.089579,-81.700455,Residential,Wood,1
333743,FL,CLAY COUNTY,0,79520.76,0,0,79520.76,86854.48,0,0,0,0,30.063236,-81.707703,Residential,Wood,3
172534,FL,CLAY COUNTY,0,254281.5,0,254281.5,254281.5,246144.49,0,0,0,0,30.060614,-81.702675,Residential,Wood,1
</code></pre>
<p>The validation code would be something like:</p>
<pre><code>import csv
from pyvaru import Validator
from pyvaru.rules import MaxLengthRule, MaxValueRule


class CsvRecordValidator(Validator):
    def get_rules(self) -&gt; list:
        record: dict = self.data
        return [
            MaxLengthRule(apply_to=record.get('statecode'),
                          label='State Code',
                          max_length=2),
            MaxValueRule(apply_to=record.get('eq_site_limit'),
                         label='Site limit',
                         max_value=40000),
        ]


with open('sample.csv', 'r') as csv_file:
    reader = csv.DictReader(csv_file)
    row = 0
    for record in reader:
        row += 1
        validator = CsvRecordValidator(record)
        validation = validator.validate()
        if not validation.is_successful():
            print(f'Row {row} did not validate. Details: {validation.errors}')
</code></pre>
<p>The example above is just a dumb example of what you can do, specifically it checks that "statecode" column has a max length of 2 and that "eq_site_limit" has a max value of 40k.
You can implement your own rules by subclassing the abstract class <code>ValidationRule</code> and implementing the <code>apply()</code> method:</p>
<pre><code>class ContainsHelloRule(ValidationRule):
    def apply(self) -&gt; bool:
        return 'hello' in self.apply_to
</code></pre>
<p>It's also possible to negate rules using bitwise operators... for example by using the previous custom rule which checks that a string mst contain "hello" you can write:</p>
<p><code>~ ContainsHelloRule(apply_to=a_string, label="A test string")</code></p>
<p>and thus the rule will be valid only if the string DOES NOT contains the "hello" string.</p>
<p>It would also possible to validate CSV records, without dictionary conversion by validating each line using a <code>PatternRule</code> with a validation regex... but of course you won't know which column value is invalid.</p>
</div>
