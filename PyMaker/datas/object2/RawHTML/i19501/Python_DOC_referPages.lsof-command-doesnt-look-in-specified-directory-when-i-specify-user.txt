<div class="post-text" itemprop="text">
<p>So I was writing a python script and my goal was to use lsof to list all open files under a specific directory (my home folder) for the local user and only output the 'uniq' entries.</p>
<p>My script looked like this:</p>
<pre><code>import os, sys, getpass
user = getpass.getuser()
cmd = "lsof -u " + user + " +d ~ | sort | uniq"
os.system(cmd)
</code></pre>
<p>This kind of does what I want it to do, it does lsof for the current local user, but it fails to look specifically in the home directory that i specified.  Instead it does lsof on the root directory and lists all lsof for the entire file system for the user.  However, when I do the same command without the <code>-u user</code> it looks specifically in the home directory.  I've been looking into why this is exactly, and yes I have tried using <code>+d /home/</code> and <code>+d ~/home/</code> instead of just <code>+d ~</code> to get this to work with no success, so I am kind of stumped.  Any advice would be great :)</p>
</div>
<div class="post-text" itemprop="text">
<p>From the <a href="http://linux.die.net/man/8/lsof" rel="nofollow">man page</a>:</p>
<blockquote>
<p>Normally list options that are specifically stated are ORed - i.e., specifying the -i option without an address and the -ufoo option produces a listing of all network files OR files belonging to processes owned by user ''foo''.</p>
</blockquote>
<p>There are some exceptions, but none of them apply in your case.</p>
<p>So, <code>-u me +d ~</code> means "all files that are opened by me OR in my home directory.</p>
<p>So how you do what you want?</p>
<blockquote>
<p>The -a option may be used to AND the selections. For example, specifying -a, -U, and -ufoo produces a listing of only UNIX socket files that belong to processes owned by user ''foo''.</p>
</blockquote>
<p>Throw a <code>-a</code> in there:</p>
<pre><code>cmd = "lsof -a -u " + user + " +d ~ | sort | uniq"
</code></pre>
<p>By the way, in general, you really don't want to use <code>os.system</code> in Python, which is why <a href="http://docs.python.org/3/library/os.html#os.system" rel="nofollow">the documentation</a> specifically says:</p>
<blockquote>
<p>The <code>subprocess</code> module provides more powerful facilities for spawning new processes and retrieving their results; using that module is preferable to using this function. See the <a href="http://docs.python.org/3/library/subprocess.html#subprocess-replacements" rel="nofollow"><em>Replacing Older Functions with the subprocess Module</em></a> section in the <code>subprocess</code> documentation for some helpful recipes.</p>
</blockquote>
<p>And really, why use <code>sort</code> and <code>uniq</code> instead of sorting in Python? Or, alternatively, if all you want to do is get this shell pipeline run, and not process it in any way in Python, why use Python instead of bash in the first place?</p>
</div>
<div class="post-text" itemprop="text">
<p>lsof joins options together using OR by default, try adding the <code>-a</code> flag to AND them together.</p>
</div>
<span class="comment-copy">Why would you expect <code>+d /home/</code> or <code>+d ~/home/</code> to do anything similar to <code>+d ~</code>? Normally, <code>~</code> is going to refer to something like <code>/home/me</code>, not just <code>/home</code>, and you're unlikely to have any files open in <code>/home</code> except maybe <code>/home/me</code>. (Note that <code>+d</code> is not recursiveâ€”use <code>+D</code> if you want that.) And <code>~/home/</code> will be <code>/home/me/home/</code>, which probably doesn't even exist. So, what were you trying to accomplish by trying them?</span>
