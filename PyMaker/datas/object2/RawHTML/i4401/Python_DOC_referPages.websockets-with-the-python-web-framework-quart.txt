<div class="post-text" itemprop="text">
<p>I need help with the python web frame work, <a href="https://github.com/pgjones/quart" rel="nofollow noreferrer">Quart</a>, more specifically the websockets.  I would like to be able to register a client when it connects (add it to a python list), and unregister them (remove it from the python list) when it disconnects.  The closest thing I could find on the web is this code: </p>
<pre><code>connected = set()

async def handler(websocket, path):
    global connected
    # Register.
    connected.add(websocket)
    try:
        # Implement logic here.
        await asyncio.wait([ws.send("Hello!") for ws in connected])
        await asyncio.sleep(10)
    finally:
        # Unregister.
        connected.remove(websocket)
</code></pre>
<p><a href="http://websockets.readthedocs.io/en/stable/intro.html" rel="nofollow noreferrer">source</a></p>
<p>But this does not work with quart websockets.</p>
<p>Help would be appreciated.</p>
</div>
<div class="post-text" itemprop="text">
<p>This decorator when used to wrap a websocket handler, will add and remove websockets from the <code>connected</code> set. The <code>_get_current_object</code> method of the websocket is required to get the websocket in the current <a href="https://pgjones.gitlab.io/quart/contexts.html" rel="nofollow noreferrer">context</a>, and the try-finally is required to ensure the websocket is removed regardless of any errors that are raised. Note the <code>app.websocket</code> must wrap (be before) the <code>collect_websocket</code> usage.</p>
<pre><code>from functools import wraps

connected = set()

def collect_websocket(func):
    @wraps(func)
    async def wrapper(*args, **kwargs):
        global connected
        connected.add(websocket._get_current_object())
        try:
            return await func(*args, **kwargs)
        finally:
            connected.remove(websocket._get_current_object())
    return wrapper                                                                                                                                                                                                            


@app.websocket('/ws')                                                                                                                                                                                       
@collect_websocket
async def ws():
    ...
</code></pre>
<p>Edit:
I am the Quart author.</p>
</div>
<span class="comment-copy">Hello, welcome to Stack Overflow! Please just note if you want to promote or recommend your own product/blog, there are some <a href="https://stackoverflow.com/help/promotion">guidelines in place</a> for doing so. Following them will help you avoid giving the impression that you're spamming. Could you please <a href="https://stackoverflow.com/posts/49841295/edit">edit</a> to explicitly state your affiliation? Thanks. (If you're not actually affiliated, it may be worth mentioning that as well.)</span>
<span class="comment-copy">I've made an edit to state my involvement in Quart. I'm not sure what this answer would be promoting though?</span>
<span class="comment-copy">That's a fine edit. The promotion would be promoting your own code/blog ...</span>
<span class="comment-copy">I get this error:      line 20, in collect_websocket          @wraps(func)     NameError: name 'wraps' is not defined,  Is there something im missing?</span>
<span class="comment-copy"><code>from functools import wraps</code> probably, <a href="https://docs.python.org/3/library/functools.html#functools.wraps" rel="nofollow noreferrer">see docs</a></span>
