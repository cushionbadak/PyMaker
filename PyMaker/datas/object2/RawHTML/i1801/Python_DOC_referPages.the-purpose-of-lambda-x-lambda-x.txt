<div class="post-text" itemprop="text">
<p>I was reading the code of byterun(a python python interpreter), and I can't understand lines below that something about closure and lambda:</p>
<pre><code>def make_cell(value):
    fn = (lambda x: lambda: x)(value) 
    return fn.__closure__[0]
</code></pre>
<p>The function was called in The second to the last line:</p>
<pre><code>class Function(object):
__slots__ = [... omit ...]

def __init__(self, name, code, globs, defaults, closure, vm):
    self._vm = vm
    self.func_code = code  
    self.func_name = self.__name__ = name or code.co_name  
    self.func_defaults = tuple(defaults)  
    self.func_globals = globs  
    self.func_locals = self._vm.frame.f_locals  
    self.__dict__ = {}  
    self.func_closure = closure  
    self.__doc__ = code.co_consts[0] if code.co_consts else None  
    kw = {
        'argdefs': self.func_defaults,
    }
    if closure:
        kw['closure'] = tuple(make_cell(0) for _ in closure)
    self._func = types.FunctionType(code, globs, **kw)  
</code></pre>
<p>What's the function's purpose? And how does it work(especially with 2 lambda)?</p>
</div>
<div class="post-text" itemprop="text">
<p>The purpose of this <code>lambda x: lambda: x</code> construct is to create a <a href="https://docs.python.org/3/c-api/cell.html" rel="nofollow noreferrer">closure cell object</a>, the objects Python uses to implement closure variables. The nested <code>lambda: x</code> uses the <code>x</code> variable from the outer <code>lambda</code>, so Python needs to create a closure cell for the <code>x</code> variable. Calling the outer lambda:</p>
<pre><code>(lambda x: lambda: x)(value)
</code></pre>
<p>creates a function object for the inner <code>lambda</code> with a closure cell for the <code>x</code> variable holding <code>value</code>, and the <code>__closure__</code> access:</p>
<pre><code>return fn.__closure__[0]
</code></pre>
<p>accesses the function object's tuple of closure variables to retrieve and return the closure cell.</p>
</div>
<span class="comment-copy">It's not very clear given the 3 line context. Link to the source code where <code>make_cell</code> is called?</span>
<span class="comment-copy">And the function was calledï¼štuple(make_cell(0) for _ in closure). Does it return the argument 0 ? Still confused. :(</span>
<span class="comment-copy">@kaka4NERV: <code>fn</code> <i>would</i> return 0 if called, but the cell <i>containing</i> that 0 is returned instead.</span>
