<div class="post-text" itemprop="text">
<p>I am trying to port some code from python2 to python3.
I am having trouble when converting some code using date/time manipulations.</p>
<blockquote>
<p>Python2.7</p>
</blockquote>
<pre><code>Python 2.7.13 (default, Apr 19 2017, 02:44:33) 
[GCC 4.8.5 20150623 (Red Hat 4.8.5-4)] on linux2
Type "help", "copyright", "credits" or "license" for more information.
&gt;&gt;&gt; import datetime
&gt;&gt;&gt; import os
&gt;&gt;&gt; os.environ['TZ'] = 'UTC'
&gt;&gt;&gt; datetime.datetime.fromtimestamp(1461085831)
datetime.datetime(2016, 4, 19, 17, 10, 31)
</code></pre>
<blockquote>
<p>Python3.6</p>
</blockquote>
<pre><code>Python 3.6.1 (default, Apr 19 2017, 21:58:41) 
[GCC 4.8.5 20150623 (Red Hat 4.8.5-4)] on linux
Type "help", "copyright", "credits" or "license" for more information.
&gt;&gt;&gt; import datetime
&gt;&gt;&gt; import os
&gt;&gt;&gt; os.environ['TZ'] = 'UTC'
&gt;&gt;&gt; datetime.datetime.fromtimestamp(1461085831)
datetime.datetime(2016, 4, 19, 22, 40, 31)
</code></pre>
<p>The result for <code>python2 = (2016, 4, 19, 17, 10, 31)</code> whereas for <code>python3 = (2016, 4, 19, 22, 40, 31)</code>.
Why is this difference, and how should I overcome this?</p>
</div>
<div class="post-text" itemprop="text">
<p>This is a little bit tricky. According to my knowledge, this only happen with python 3.6. For short, you need to call <a href="https://docs.python.org/3/library/time.html#time.tzset" rel="nofollow noreferrer"><code>time.tzset</code></a> after set <code>TZ</code> environment. I've encountered it sometime ago (I don't remember exactly), <s>and I don't have pre-3.6 python to test, so please bear with me</s>. I've just checked this issue on my colleague's <code>python3.5</code>, it works as expected (without putting <code>time.tzset()</code>)  </p>
<p>The <code>time.tzset</code> docs say:</p>
<blockquote>
<p>Reset the time conversion rules used by the library routines. The environment variable TZ specifies how this is done. It will also set the variables tzname (from the TZ environment variable), timezone (non-DST seconds West of UTC), altzone (DST seconds west of UTC) and daylight (to 0 if this timezone does not have any daylight saving time rules, or to nonzero if there is a time, past, present or future when daylight saving time applies).  </p>
</blockquote>
<p>Just put the <code>time.tzset()</code>:</p>
<p><a href="https://i.stack.imgur.com/ehZZJ.png" rel="nofollow noreferrer"><img alt="See the results" src="https://i.stack.imgur.com/ehZZJ.png"/></a></p>
<p>EDITED: I've just made some search, this behavior had been (mistakenly) reported as a bug: <a href="https://bugs.python.org/issue30062" rel="nofollow noreferrer">datetime in Python 3.6+ no longer respects 'TZ' environment variable</a></p>
</div>
<span class="comment-copy">And I get <code>datetime.datetime(2016, 4, 19, 18, 10, 31)</code> in 3.6 in the UK. I don't think <code>os.environ['TZ'] = 'UTC'</code> has any effect</span>
<span class="comment-copy">weird, its showing me same datetime for both python2.7 and python3.6.2</span>
<span class="comment-copy">Are these cloud-based instances of Linux?</span>
<span class="comment-copy">@Arpit Is your python3.6 ran from same system as your python2.7 ? @roganjosh maybe correct, <code>UTC</code> has no effect.</span>
<span class="comment-copy">@roganjosh I got different results on local machine with python 2 and 3. Maybe there is something different on how they use timezones</span>
<span class="comment-copy">The linked docs says also: "Although in many cases, changing the TZ environment variable may affect the output of functions like localtime() without calling tzset(), this behavior should not be relied on." I think this answer is helpful. Note that <code>datetime.fromtimestamp</code> calls <code>time.localtime</code>.</span>
<span class="comment-copy">@roganjosh It's about the affect of changing TZ variable. I see this is so confuse, and till now I still feel not so sure about these things :(</span>
<span class="comment-copy">"According to my knowledge, this only happen with python 3.6" how did you come up with this ? because <a href="https://www.tutorialspoint.com/execute_python3_online.php" rel="nofollow noreferrer">tutorialspoint.com/execute_python3_online.php</a>  does not really reflect it. This question poses some real questions about how datetime works. OP and I are in same TZ so our outputs are same as well except for python 3.6</span>
<span class="comment-copy">@angrysumit I have just made an edit to my answer. See the bug report for more detail</span>
