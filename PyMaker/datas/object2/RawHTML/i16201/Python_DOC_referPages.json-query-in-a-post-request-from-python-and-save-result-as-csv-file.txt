<div class="post-text" itemprop="text">
<p>I'm trying to write a program that will connect to a specified url:</p>
<pre><code>http://api.scb.se/OV0104/v1/doris/sv/ssd/START/BO/BO0104/BostadsbestandK
</code></pre>
<p>and use this query:</p>
<pre><code>{ "query": [ { "code": "Region", "selection": { "filter": "vs:RegionRiket99", "values": [ "00" ] } }, { "code": "Hustyp", "selection": { "filter": "item", "values": [ "FLERBO", "SMÅHUS" ] } }, { "code": "Tid", "selection": { "filter": "item", "values": [ "2012" ] } } ], "response": { "format": "csv" } }
</code></pre>
<p>I would then like to store the result into a csv file.</p>
<p>This is the code I have so far:</p>
<pre><code>import urllib.request
import json

url = 'http://api.scb.se/OV0104/v1/doris/sv/ssd/START/BO/BO0104/BostadsbestandK'

data = '{ "query": [ { "code": "Region", "selection": { "filter": "vs:RegionRiket99", "values": [ "00" ] } }, { "code": "Hustyp", "selection": { "filter": "item", "values": [ "FLERBO", "SMÅHUS" ] } }, { "code": "Tid", "selection": { "filter": "item", "values": [ "2012" ] } } ], "response": { "format": "csv" } }'
data = json.dumps(data)
</code></pre>
</div>
<div class="post-text" itemprop="text">
<p>You should <strong>not</strong> define the query as a string; leave it a Python object:</p>
<pre><code>data = { "query": [ { "code": "Region", "selection": { "filter": "vs:RegionRiket99", "values": [ "00" ] } }, { "code": "Hustyp", "selection": { "filter": "item", "values": [ "FLERBO", "SMÅHUS" ] } }, { "code": "Tid", "selection": { "filter": "item", "values": [ "2012" ] } } ], "response": { "format": "csv" } }
data = json.dumps(data)
</code></pre>
<p>You'll need to set a <code>application/json</code> request header to indicate what the contents are. You can do so with a <code>urllib.request.Request()</code> object; do encode the JSON data to UTF-8 first:</p>
<pre><code>request = urllib.request.Request(url, data.encode('utf8'))
request.add_header('content-type', 'application/json')
response = urllib.request.urlopen(request)
</code></pre>
<p>Now you can save the CSV to a file; using <a href="https://docs.python.org/3/library/shutil.html#shutil.copyfileobj" rel="nofollow"><code>shutil.copyfileobj()</code></a> would make this efficient even for large responses:</p>
<pre><code>import shutil

with open(csvfilename, 'wb') as outf:
    shutil.copyfileobj(response, outf)
</code></pre>
</div>
<span class="comment-copy">No, I can't figure out how to use a "raw" json query, i.e. like it is defined by the API owner.</span>
<span class="comment-copy">I get this error message: Traceback (most recent call last):   File "C:\Lagring\Python\PostRequest 1.py", line 17, in &lt;module&gt;     shutil.copyfileobject(response, outf) AttributeError: 'module' object has no attribute 'copyfileobject'</span>
<span class="comment-copy">@user3933746: my apologies, that was a typo on my side.</span>
