<div class="post-text" itemprop="text">
<p>I have a question about generators and/or python's execution model.</p>
<p>Given something like: </p>
<pre><code>def g(filename):
    with open(filename) as handle:
        for line in handle:
            yield some_trasformation_on(line)
</code></pre>
<p>My main confusion is: What happens to handle if</p>
<pre><code>res = g()
print(next(res))
</code></pre>
<p>is called only once? Does the handle stay open for the life of the program? What if we have scarce resources being allocated in a generator body? Threads? Database handles?</p>
<p>Perhaps I am considering generators to be like functions under the hood.</p>
</div>
<div class="post-text" itemprop="text">
<h2>Answer with the code as written</h2>
<p>As described, <strong>the file will stay open for the life of the program.</strong>  While you have a reference to the <em>res</em> variable, it keeps the generator stackframe is alive, so the only way to get the with-statement to close the file is to keep calling <a href="https://docs.python.org/3/library/functions.html#next" rel="nofollow noreferrer"><em>next()</em></a> until the for-loop ends normally.</p>
<h2>How to clean-up the generator</h2>
<p>The tool designed for generator clean-up is <a href="https://www.python.org/dev/peps/pep-0342/#new-generator-method-close" rel="nofollow noreferrer"><em>generator.close()</em></a> which raises a <a href="https://docs.python.org/2.7/library/exceptions.html#exceptions.GeneratorExit" rel="nofollow noreferrer"><em>GeneratorExit</em></a> inside the generator.</p>
<p>Here is some working code to show how it could be done:</p>
<pre><code>def genfunc(filename):
    try:
        with open(filename) as datafile:
            for line in datafile:
                yield len(line)
    finally:
        print('Status: %s' % datafile.closed)
</code></pre>
<p>And here is a sample session showing the closing operation actually takes place:</p>
<pre><code>&gt;&gt;&gt; g = genfunc('somefile.txt')
&gt;&gt;&gt; next(g)
23
&gt;&gt;&gt; g.close()
Status: True
</code></pre>
</div>
<span class="comment-copy">It would have been great to have an example with 'with' statement since I think using 'with' is often encouraged for auto closing of handles.</span>
