<div class="post-text" itemprop="text">
<p>Is there a way to measure the amount of memory allocated by an arbitrary web request in a Flask/Werkzeug app? By arbitrary, I mean I'd prefer a technique that lets me instrument code at a high enough level that I don't have to change it to test memory usage of different routes. If that's not possible but it's still possible to do this by wrapping individual requests with a little code, so be it.</p>
<p>In a PHP app I wrote a while ago, I accomplished this by calling the memory_get_peak_usage() function both at the start and the end of the request and taking the difference.</p>
<p>Is there an analog in Python/Flask/Werkzeug? Using Python 2.7.9 if it matters.</p>
</div>
<div class="post-text" itemprop="text">
<p>First of all, one should understand the main difference between PHP and Python requests processing. Roughly speaking, each PHP worker accepts only one request, handle it and then die (or reinit interpreter). PHP was designed directly for it, it's request processing language by its nature. So, it's pretty simple to measure per request memory usage. Request's peak memory usage is equal to the worker peak memory usage. It's a language feature.</p>
<p>At the same time, Python usually uses another approach to handle requests. There are two main models - synchronous and asynchronous request processing. However, both of them have the same difficulty when it comes to measure per request memory usage. The reason is that one Python worker handles plenty of requests (concurrently or sequentially) during his life. So, it's hard to get memory usage exactly for a request. </p>
<p>However, one can adapt an underlying framework and application code to accomplish collecting memory usage task. One possible solution is to use some kind of <a href="https://pythonhosted.org/blinker/" rel="nofollow noreferrer">events</a>. For example, one can raise an abstract <code>mem_usage</code> event on: before request, at the beginning of a view function, at the end of a view function, in some important places within the business logic and so on. Then it should exists a subscriber for such events, doing the next thing:</p>
<pre><code>import resource
mem_usage = resource.getrusage(resource.RUSAGE_SELF).ru_maxrss
</code></pre>
<p>This subscriber have to accumulate such usage data and on the <code>app_request_teardown/after_request</code> send it to the metrics collection system with information about current <code>request.endpoint</code> or route or whatever.</p>
<p>Also, <a href="https://stackoverflow.com/questions/110259/which-python-memory-profiler-is-recommended">using a memory profiler</a> is a good idea, but usually not for a production usage.</p>
<p>Further reading about request processing models:</p>
<ul>
<li><a href="https://en.wikipedia.org/wiki/Common_Gateway_Interface" rel="nofollow noreferrer">CGI</a> </li>
<li><a href="https://en.wikipedia.org/wiki/FastCGI" rel="nofollow noreferrer">FastCGI</a></li>
<li><a href="https://software-gunslinger.tumblr.com/post/47131406821/php-is-meant-to-die" rel="nofollow noreferrer">PHP specific</a></li>
</ul>
</div>
<div class="post-text" itemprop="text">
<p>Another possible solution is to use <a href="https://docs.python.org/3/library/sys.html#sys.settrace" rel="nofollow"><code>sys.setrace</code></a>. Using this tool one can measure memory usage even per each line of code. Usage examples can be found in the <a href="https://github.com/fabianp/memory_profiler" rel="nofollow">memory_profiler</a> project. Of course, it will slowdown the code significantly.</p>
</div>
<span class="comment-copy">I'm pretty familiar with the request model of both languages. Let's assume that I'm in a controlled environment where I choose which request is happening and there will be only one at a time. Is there a specific module, either general-purpose or specific to Werkzeug, that is most appropriate for testing mem usage? Thanks.</span>
<span class="comment-copy">@DaveBurns, how about using <a href="http://stackoverflow.com/a/37049727/1201488"><code>sys.settrace</code></a>?</span>
