<div class="post-text" itemprop="text">
<p>The following code throws</p>
<blockquote>
<p>TypeError: Object of type 'datetime' is not JSON serializable</p>
</blockquote>
<p>which I know how to resolve.  However my real question is how to cleanly structure the code to avoid a partial file if any exception occurs in <a href="https://docs.python.org/3/library/json.html#basic-usage" rel="nofollow noreferrer"><code>json.dump</code></a>.</p>
<pre><code>import datetime
import json

def save(data):
    with open('data.txt', 'w') as outfile:
        json.dump(data, outfile)

data = dict(sometime=datetime.datetime.now())
save(data)
</code></pre>
<p>The above code throws an exception and results in a partial file like:</p>
<pre><code>{"sometime": 
</code></pre>
<p>Should I <code>dumps</code> to a string first in a <code>try/except</code>?  If so are there any memory implications to be aware of? Or delete the file in an except block?</p>
</div>
<div class="post-text" itemprop="text">
<p>Use a <a href="https://wiki.python.org/moin/HandlingExceptions" rel="nofollow noreferrer"><code>try/except</code></a> block like:</p>
<h3>Code:</h3>
<pre><code>def save_json(data, filename):
    try:
        with open(filename, 'w') as outfile:
            json.dump(data, outfile)
    except:
        try:
            os.unlink(filename)
        except FileNotFoundError:
            pass
</code></pre>
<p>and if you want to preserve the exception:</p>
<pre><code>def save_json(data, filename):
    try:
        with open(filename, 'w') as outfile:
            json.dump(data, outfile)
    except:
        if os.path.exists(filename):
            os.unlink(filename)
        raise
</code></pre>
<h3>Test Code:</h3>
<pre><code>import datetime
import json
import os

data = dict(sometime=datetime.datetime.now())
save_json(data, 'data.txt')
</code></pre>
</div>
<div class="post-text" itemprop="text">
<p>That depends on whether your JSON data is under your control or from unknown source. If it’s from somewhere you can’t predict, use  <code>try...except...</code> block. Otherwise, fix your program to make it always available to serialize.</p>
</div>
<span class="comment-copy">Possible duplicate of <a href="https://stackoverflow.com/questions/3768895/how-to-make-a-class-json-serializable">How to make a class JSON serializable</a></span>
