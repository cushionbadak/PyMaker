<div class="post-text" itemprop="text">
<p>I am trying to code a script that will export all my messages (mailbox mbox format) into PDF files with pdfkit.</p>
<p>It seems that all messages in my mailbox are multipart, and I'm struggling with figuring out which part is the relevant one. If I iterate through all parts with the code below, I will generate typically 3 to 5 PDFs per e-mail, with only one of them being similar to what I would see if I opened the e-mail with an e-mail client. The other parts are typically either raw text or something that looks like this: <code>x92O&amp;S\xd2\x0c\xb4e\xee\x0fh\xc68\x1</code> (hexadecimal?).</p>
<p>I tried to solve the issue by including a test to filter for HTML (<code>if bool(BeautifulSoup(html, "html.parser").find())</code>) but it seems that this does not work.</p>
<pre><code>for part in message.walk():
    partcounter +=1
    try:
        html = str(part.get_payload(decode=True))
        if bool(BeautifulSoup(html, "html.parser").find()):
            print(str(messagecounter)+'-'+str(partcounter)+' - '+"payload is HTML")
            filename = 'C:/Email_forwarding/Attachments/'+str(messagecounter)+"-"+str(partcounter)+'.pdf'#this keeps the file only for the last part, which seems to be correct
            pdfkit.from_string(html,filename, configuration=config)
            print(str(messagecounter)+'-'+str(partcounter)+' - '+"created %s" %(filename))
        else:
            print(str(messagecounter)+'-'+str(partcounter)+' - '+"payload is not HTML")
    except:
        print(str(messagecounter)+'-'+str(partcounter)+' - '+"no payload or failed to convert")
</code></pre>
<p>How can I detect which part of a multipart e-mail contains actual, interpretable HTML?</p>
</div>
<div class="post-text" itemprop="text">
<p>You can use <a href="https://docs.python.org/3.6/library/email.compat32-message.html#email.message.Message.get_content_type" rel="nofollow noreferrer"><code>part.get_content_type()</code></a> to filter through the different parts of the message:</p>
<pre><code>for part in message.walk():
    if part.get_content_type() == 'text/html':
        html = str(part.get_payload(decode=True))
</code></pre>
</div>
<span class="comment-copy">Have you tried <code>message.get_body(preferencelist=('html','plain'))</code>: <a href="https://docs.python.org/3/library/email.message.html#email.message.EmailMessage.get_body" rel="nofollow noreferrer">docs.python.org/3/library/â€¦</a></span>
<span class="comment-copy">It seems that get_body isn't a mailbox method. My message object has type mailbox.mboxMessage.</span>
<span class="comment-copy">Why don't you do <code>if part.get_content_type() == 'text/html':</code>?</span>
<span class="comment-copy">Seems to work. Thanks!</span>
