<div class="post-text" itemprop="text">
<p>I am starting asynchronous tasks using python's <code>concurrent.futures</code> <a href="https://docs.python.org/3/library/concurrent.futures.html#concurrent.futures.ThreadPoolExecutor" rel="nofollow noreferrer">ThreadPoolExecutor</a>.
Following <a href="https://techoverflow.net/2017/05/18/how-to-use-concurrent-futures-map-with-a-tqdm-progress-bar/" rel="nofollow noreferrer">this</a> approach, I monitor the progress of the async calls using the <code>tqdm</code> progress bar.</p>
<p><strong>My code looks like this</strong>:</p>
<pre><code>with concurrent.futures.ThreadPoolExecutor(max_workers = n_jobs) as executor:
    future_to_url = {executor.submit(target_function, URL): URL for URL in URL_list}
    kwargs = {'total': len(future_to_url), # For tqdm
            'unit': 'URL',                 # For tqdm
            'unit_scale': True,            # For tqdm
            'leave': False,                # For tqdm
            'miniters': 50,                # For tqdm
            'desc': 'Scraping Progress'}
    for future in tqdm(concurrent.futures.as_completed(future_to_url), **kwargs):
            URL = future_to_url[future]
            try:
                data = future.result()     # Concurrent calls
            except Exception as exc:
                error_handling()           # Handle errors
            else:
                result_handling()          # Handle non-errors
</code></pre>
<p><strong>The console output looks like this</strong>:</p>
<pre><code>Scraping Progress:   9%|▉  | 3.35k/36.2k [08:18&lt;1:21:22, 6.72URL/s] # I want &lt; 6/s
Scraping Progress:   9%|▉  | 3.40k/36.2k [08:26&lt;1:21:16, 6.72URL/s] # I want &lt; 6/s
Scraping Progress:  10%|▉  | 3.45k/36.2k [08:30&lt;1:20:40, 6.76URL/s] # I want &lt; 6/s
Scraping Progress:  10%|▉  | 3.50k/36.2k [08:40&lt;1:20:51, 6.73URL/s] # I want &lt; 6/s
Scraping Progress:  10%|▉  | 3.55k/36.2k [08:46&lt;1:20:36, 6.74URL/s] # I want &lt; 6/s
Scraping Progress:  10%|▉  | 3.60k/36.2k [08:52&lt;1:20:17, 6.76URL/s] # I want &lt; 6/s
</code></pre>
<p>I know I can set up a URL queue and control its size, as described <a href="https://stackoverflow.com/questions/16914665/how-to-use-queue-with-concurrent-future-threadpoolexecutor-in-python-3">here</a>.</p>
<p>However, I don't know how to control throughput speed itself. Lets say I want not more than 6 URLs/sec. Can this be archived by something else than throwing in time.sleep(n) to <code>target_function()</code> in the above example?</p>
<p><strong>How to effectively control throughput speed of</strong> <code>ThreadPoolExecutor</code> <strong>in python's</strong> <code>concurrent.futures</code>?</p>
</div>
<div class="post-text" itemprop="text">
<p>To answer shortly, there is no such way. Once you have declared your pool, you cannot change the number of workers without first closing the pool and recreating it. There is also no way to make the pool feed tasks slower than the maximum speed to workers.</p>
<p>You have a couple of (not so optimal) choices. </p>
<p>One is to add sleep based on global variable to the worker.  Then you can use task completed callbacks to measure actual speed and adjust the variable accordingly.  But if sleeping is out of question, this does not work. </p>
<p>The better, albeit more onerous, way is to write the task manager yourself. In this version you do not use pool but write a class that manages worker processes. You spawn "enough" workers, and the workers listen to a queue for tasks. You will feed this queue from your manager in your desired speed. You will set your queue to have a very low maximum size, and if your manager detects the queue is full, it spawns another worker. </p>
<p>But there is no built-in functionality to do what you want, which means some work is needed or you need to redesign your program so that you will not feed all of your tasks to the pool in one go but do some throttling there. </p>
</div>
<span class="comment-copy">That cannot be precise, but you can reduce <code>max_workers</code>.</span>
<span class="comment-copy">I dont want to benchmark how many workers will make up which speed - especially because wifi quality also influences this. I want something like Java's variable thread options, min, max number of threads etc</span>
<span class="comment-copy">What do you mean? <code>max_workers</code> exactly controls the max number of threads.</span>
<span class="comment-copy">sorry for my lack of precision. I want that some instance controls the number of workers in a fluent way so that it will be adjusted to always be ~6 URLs/sec <a href="http://www.tutorialdost.com/Java-Programming-Tutorial/37-Java-Thread-Priority.aspx" rel="nofollow noreferrer">tutorialdost.com/Java-Programming-Tutorial/…</a></span>
<span class="comment-copy">basically i need "max_workers = fluent" functionality but don't know realize this</span>
