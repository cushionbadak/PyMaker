<div class="post-text" itemprop="text">
<p>I am very new to python programming, please go easy on me!  </p>
<p>I am querying my MySQL database and writing output to a file and sending an email of the results.  However the email is being sent before the file is written to.  How do I tell my code to do the query and writing to file <strong>before</strong> sending the email?</p>
<pre><code>#!/usr/bin/python
# Import smtplib for the actual sending function
import smtplib
import MySQLdb as mdb
import sys
import csv

con = mdb.connect('localhost', 'myuser', 'mypassword', 'mydatabase');
with con:
    cur = con.cursor()
    cur.execute("SELECT * from vw_mail")
    rows = cur.fetchall()
c = csv.writer(open('/home/pi/mail.csv','wb'))
c.writerows(rows)

# Import the email modules we'll need
from email.mime.text import MIMEText

# Open a plain text file for reading.  For this example, assume that
# the text file contains only ASCII characters.
fp = open('/home/pi/mail.csv','rb')
# Create a text/plain message
msg = MIMEText(fp.read())
fp.close()

# me == the sender's email address
# you == the recipient's email address
msg['Subject'] = 'MySubject'
msg['From'] = 'me@me.com'
msg['To'] = 'you@you.com'

# Send the message via our own SMTP server, but don't include the
# envelope header.
s = smtplib.SMTP('smtp.me.com')
s.sendmail('me@me.com','you@you.com', msg.as_string())
s.quit() 
</code></pre>
</div>
<div class="post-text" itemprop="text">
<p>The data is not flushed to disk after <code>c.writerows(rows)</code>. Refer <a href="https://stackoverflow.com/questions/3976711/csvwriter-not-saving-data-to-file-why">here</a></p>
</div>
<div class="post-text" itemprop="text">
<p>Your problem stems from the fact that when you do an anonymous open, like this:</p>
<pre><code>c = csv.writer(open('/home/pi/mail.csv','wb'))
</code></pre>
<p>Python will close the open file when the program ends, and that's when it appears as if its actually written to the disk.</p>
<p>To solve the problem, open the file using the <code>with statement</code>, which will close the file automatically for you:</p>
<pre><code>with open('/home/pi/mail.csv','w') as the_file:
    c = csv.writer(the_file)
    c.writerows(rows)
</code></pre>
</div>
<div class="post-text" itemprop="text">
<p>It seems like you are not familiar with the "with" statement, <a href="http://effbot.org/zone/python-with-statement.htm" rel="nofollow">here</a> is a post about it.</p>
<p>In your case, you can do like this:</p>
<pre><code>class query_database_and_mailï¼š
    def __enter__(self):
        con = mdb.connect('localhost', 'myuser', 'mypassword', 'mydatabase');
        return con

    def __exit__(self):
        #put your send-email codes here 

with query_database_and_email() as con:
    cur = con.cursor()
    cur.execute("SELECT * from vw_mail")
    rows = cur.fetchall()
    c = csv.writer(open('/home/pi/mail.csv','wb'))
    c.writerows(rows)    
</code></pre>
<p>no one will be hard to you, so just relax and be free to ask:)</p>
</div>
<span class="comment-copy">Why are you writing out the rows to the disk at all? Seems like you could use an <a href="http://docs.python.org/3/library/io.html#io.StringIO" rel="nofollow noreferrer"><code>io.StringIO</code></a> for storing the query results.</span>
<span class="comment-copy">Thank you very much Roger, sounds like a plan.  Back to the books.</span>
<span class="comment-copy">If you like my answer, you can accept it, just click the check mark below the votes,thanks:)</span>
<span class="comment-copy">I get the following with your code: ` File "./mail.py", line 25, in &lt;module&gt;     with query_database_and_mail() as con: AttributeError: query_database_and_mail instance has no attribute '<b>exit</b>'`</span>
<span class="comment-copy">Aha, there is a typo here, you should write def __exit__(self):, sorry, it's my mistake</span>
<span class="comment-copy">Making that change yields another error:[code]Traceback (most recent call last):   File "./mail.py", line 30, in &lt;module&gt;     c.writerows(rows) TypeError: __exit__() takes exactly 1 argument (4 given)[/code] What are the four arguments?  I can't post all my code because the system says too long by 522 characters! How do I make code show in a comment? I'm ready to give up here.</span>
