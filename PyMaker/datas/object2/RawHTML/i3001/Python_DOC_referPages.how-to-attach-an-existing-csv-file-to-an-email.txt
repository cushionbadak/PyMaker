<div class="post-text" itemprop="text">
<p>I'm trying to follow the example at <a href="https://stackoverflow.com/questions/17584550/attach-generated-csv-file-to-email-and-send-with-django">Attach generated CSV file to email and send with Django</a> to generate a CSV file and send it by email. In my case, however, I would also like to save the actual file, and not only send it my email as in the example. (Also, I'm using Python 3, whereas the example seems to pertain to Python 2).</p>
<p>Here is the Django script I'm trying to run:</p>
<pre><code>import csv
from collections import OrderedDict
from datetime import datetime
from django.conf import settings
from django.core.mail import EmailMessage
from lucy_web.models import Family

# Path of the CSV file to generate and send by email (relative to lucy-web)
FILENAME = 'scripts/nps.csv'


def get_row(family):
    """
    Return a row for the spreadsheet, including the corresponding headers.
    (The actual argument to csv.write.writerow() should be the .values(); the
    .keys() are for the header row). (An OrderedDict is easier to
    read/add to than two separate lists).
    """
    return OrderedDict([
        ("Employee Name", family.employee_name),
        ("Employee Email", family.employee_email),
        ("Employee Alternate Email", family.employee_alternate_email),
        ("Partner Name", family.partner_name),
        ("Partner Email", family.partner_email),
        ("Partner Alternate Email", family.partner_alternate_email),
    ])


def run():
    write_csv_file()
    send_results_by_email(to=['kurt@hicleo.com'])


def write_csv_file(filename=FILENAME):
    """Generate a CSV file with NPS data"""
    with open(filename, 'w', newline='') as csvfile:
        writer = csv.writer(csvfile)

        # Header row; we need to specify an arbitrary family
        writer.writerow(
        get_row(Family.objects.first()).keys())

        for family in Family.objects.all():
            row = get_row(family).values()
            writer.writerow(row)
    print(f"Wrote a CSV file at {filename}")


def send_results_by_email(to, filename=FILENAME):
    """Send an email with the NPS data attached"""
    with open(filename, 'r') as csvfile:
        now = datetime.now().strftime("%m-%d-%Y %H:%M")
        email_message = EmailMessage(
            subject=f"NPS data (collected {now})",
            body=f"Script run with the following settings module: '{settings.SETTINGS_MODULE}'",
            to=to,
            attachments=[('nps.csv', csvfile.getvalue(), 'text/csv')])
        email_message.send()
    print(f"Email sent to {to}!")
</code></pre>
<p>However, I'm getting the following error message when I run <code>python manage.py runscript nps</code> (where <code>scripts/nps.py</code> is the location of the script):</p>
<pre><code>Wrote a CSV file at scripts/nps.csv
Exception while running run() in 'scripts.nps'
Traceback (most recent call last):
  File "manage.py", line 28, in &lt;module&gt;
    execute_from_command_line(sys.argv)
  File "/Users/kurtpeek/.local/share/virtualenvs/lucy-web-CVxkrCFK/lib/python3.7/site-packages/django/core/management/__init__.py", line 371, in execute_from_command_line
    utility.execute()
  File "/Users/kurtpeek/.local/share/virtualenvs/lucy-web-CVxkrCFK/lib/python3.7/site-packages/django/core/management/__init__.py", line 365, in execute
    self.fetch_command(subcommand).run_from_argv(self.argv)
  File "/Users/kurtpeek/.local/share/virtualenvs/lucy-web-CVxkrCFK/lib/python3.7/site-packages/django_extensions/management/email_notifications.py", line 65, in run_from_argv
    super(EmailNotificationCommand, self).run_from_argv(argv)
  File "/Users/kurtpeek/.local/share/virtualenvs/lucy-web-CVxkrCFK/lib/python3.7/site-packages/django/core/management/base.py", line 288, in run_from_argv
    self.execute(*args, **cmd_options)
  File "/Users/kurtpeek/.local/share/virtualenvs/lucy-web-CVxkrCFK/lib/python3.7/site-packages/django_extensions/management/email_notifications.py", line 77, in execute
    super(EmailNotificationCommand, self).execute(*args, **options)
  File "/Users/kurtpeek/.local/share/virtualenvs/lucy-web-CVxkrCFK/lib/python3.7/site-packages/django/core/management/base.py", line 335, in execute
    output = self.handle(*args, **options)
  File "/Users/kurtpeek/.local/share/virtualenvs/lucy-web-CVxkrCFK/lib/python3.7/site-packages/django_extensions/management/utils.py", line 59, in inner
    ret = func(self, *args, **kwargs)
  File "/Users/kurtpeek/.local/share/virtualenvs/lucy-web-CVxkrCFK/lib/python3.7/site-packages/django_extensions/management/commands/runscript.py", line 238, in handle
    run_script(mod, *script_args)
  File "/Users/kurtpeek/.local/share/virtualenvs/lucy-web-CVxkrCFK/lib/python3.7/site-packages/django_extensions/management/commands/runscript.py", line 148, in run_script
    mod.run(*script_args)
  File "/Users/kurtpeek/Documents/Dev/lucy2/lucy-web/scripts/nps.py", line 58, in run
    send_results_by_email(to=['kurt@hicleo.com'])
  File "/Users/kurtpeek/Documents/Dev/lucy2/lucy-web/scripts/nps.py", line 84, in send_results_by_email
    attachments=[('nps.csv', csvfile.getvalue(), 'text/csv')])
AttributeError: '_io.TextIOWrapper' object has no attribute 'getvalue'
</code></pre>
<p>What I essentially need to do, as I understand from <a href="https://docs.python.org/3/library/io.html#text-i-o" rel="nofollow noreferrer">https://docs.python.org/3/library/io.html#text-i-o</a>, is construct an in-memory <code>io.StringIO</code> from the output file at <code>scripts/nps.csv</code>. How can I go about this?</p>
<p><strong>Update</strong></p>
<p>Following the answers, I've replaced <code>csvfile.getvalue()</code> by <code>csvfile.read()</code>. After some refactoring, this is now my <code>send_results_by_email()</code> function:</p>
<pre><code>def send_results_by_email(to, filename=FILENAME):
    """Send an email with the NPS data attached"""
    now = datetime.now().strftime("%m-%d-%Y %H:%M")
    email_message = EmailMessage(
        subject=f"NPS data (collected {now})",
        body=f"Script run with the following settings module: '{settings.SETTINGS_MODULE}'",
        to=to)

    with open(filename, newline='') as csvfile:
        email_message.attach('nps.csv', csvfile.read(), 'text/csv')
        email_message.send()
    print(f"Email sent to {to}!")
</code></pre>
<p>The problem is that it is not sending an email. However, if I replace <code>csvfile.read()</code> with the string <code>'foobar'</code>, I do get an email:</p>
<p><a href="https://i.stack.imgur.com/qKDcX.png" rel="nofollow noreferrer"><img alt="enter image description here" src="https://i.stack.imgur.com/qKDcX.png"/></a></p>
<p>with the expected content:</p>
<p><a href="https://i.stack.imgur.com/BuZYT.png" rel="nofollow noreferrer"><img alt="enter image description here" src="https://i.stack.imgur.com/BuZYT.png"/></a></p>
<p>Why does it work with the simple string, <code>'foobar'</code>, and not with <code>csvfile.read()</code>? I've printed the contents in the debugger and it does seem to have content, which I've uploaded to <a href="https://file.io/kZkNPq" rel="nofollow noreferrer">https://file.io/kZkNPq</a> (it's scrambled data).</p>
<p><strong>Update 2</strong></p>
<p>The sending of emails was actually working, the only difference was that GMail was identifying the emails with larger attachments as Phishing and sending them to my Junk folder:</p>
<p><a href="https://i.stack.imgur.com/dSaeA.png" rel="nofollow noreferrer"><img alt="enter image description here" src="https://i.stack.imgur.com/dSaeA.png"/></a></p>
</div>
<div class="post-text" itemprop="text">
<p><code>getvalue</code> method is available only on <code>io.StringIO</code>. For an <code>io.TextIOWrapper</code> instance, use the <code>read</code> method.</p>
<p>Change <code>csvfile.getvalue()</code> to <code>csvfile.read()</code> and it should work.</p>
</div>
<div class="post-text" itemprop="text">
<p>Since the <strong>csvfile</strong> is a <strong><code>_io.TextIOWrapper</code></strong> object, you have to use <strong><code>.read()</code></strong> method instead of <strong><code>getvalue()</code></strong> as,<br/></p>
<pre><code>def send_results_by_email(to, filename=FILENAME):
    """Send an email with the NPS data attached"""
    with open(filename, 'r') as csvfile:
        now = datetime.now().strftime("%m-%d-%Y %H:%M")
        email_message = EmailMessage(
            subject=f"NPS data (collected {now})",
            body=f"Script run with the following settings module: '{settings.SETTINGS_MODULE}'",
            to=to,
            attachments=[('nps.csv', <b>csvfile.read()</b>, 'text/csv')])
        email_message.send()
    print(f"Email sent to {to}!")</code></pre>
</div>
<span class="comment-copy">If I change it to <code>csvfile.read()</code>, I no longer get an error message, but no email gets sent. If I replace the <code>csvfile.read()</code> by <code>'foobar'</code>, an email does get sent with the expected attachment. What could be going wrong here?</span>
