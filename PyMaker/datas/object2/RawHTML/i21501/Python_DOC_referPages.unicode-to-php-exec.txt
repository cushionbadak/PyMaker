<div class="post-text" itemprop="text">
<p>I have a Python file I'm calling with PHP's <code>exec</code> function. Python then outputs a string (apparently Unicode, based on using <code>isinstance</code>), which is echoed by PHP. The problem I'm running into is that if my string has any special characters in it (like the degree symbol), it won't output. I'm sure I need to do something to fiddle with the encoding, but I'm not really sure what to do, and why.</p>
<p><strong>EDIT:</strong> To get an idea of how I am calling <code>exec</code>, please see the following code snippet:</p>
<pre><code>$tables = shell_exec('/s/python-2.6.2/bin/python2.6 getWikitables.py '.$title);
</code></pre>
<p>Python properly outputs the string when I call <code>getWikitables.py</code> by itself.</p>
<p><strong>EDIT:</strong> It definitely seems to be something either on the Python end, or in transmitting the results. When I run <code>strlen</code> on the returned values in PHP, I get 0. Can <code>exec</code> only accept a certain type of encoding?</p>
</div>
<div class="post-text" itemprop="text">
<p>On php you can use methods like <a href="http://php.net/manual/function.utf8-encode.php" rel="nofollow"><code>utf8_encode()</code></a> or <a href="http://php.net/manual/function.utf8-decode.php" rel="nofollow"><code>utf8_decode()</code></a> to solve your problem.</p>
</div>
<div class="post-text" itemprop="text">
<p>Try setting the <code>LANG</code> environment variable immediately before executing the Python script per <a href="http://php.net/shell-exec#85095" rel="noreferrer">http://php.net/shell-exec#85095</a>:</p>
<pre><code>shell_exec(sprintf(
  'LANG=en_US.utf-8; /s/python-2.6.2/bin/python2.6 getWikitables.py %s',
    escapeshellarg($title)
));
</code></pre>
<p>(use of <a href="http://php.net/sprintf" rel="noreferrer"><code>sprintf()</code></a> to (hopefully) make it a little easier to follow the lengthy string)</p>
<p>You might also/instead need to do this before calling <code>shell_exec()</code>, per <a href="http://php.net/shell-exec#78279" rel="noreferrer">http://php.net/shell-exec#78279</a>:</p>
<pre><code>$locale = 'en_US.utf-8';
setlocale(LC_ALL, $locale);
putenv('LC_ALL='.$locale);
</code></pre>
</div>
<div class="post-text" itemprop="text">
<p>I have had a similar issue and solved it with the following. I don't understand why it is necessary, since I though all is already processed with UTF-8. Calling my Python script on the command line worked, but not with exec (shell_exec) via PHP and Apache.</p>
<p>According to a <a href="http://php.net/manual/en/function.escapeshellarg.php#99213" rel="nofollow noreferrer">php forum entry</a> this one is needed when you want to use <a href="http://php.net/manual/en/function.escapeshellarg.php" rel="nofollow noreferrer"><code>escapeshellarg()</code></a>:</p>
<pre><code>setlocale(LC_CTYPE, "en_US.UTF-8");
</code></pre>
<p>It needs to be called before <code>escapeshellarg()</code> is executed. Also, it was necessary to set a certain <a href="https://docs.python.org/3/using/cmdline.html#envvar-PYTHONIOENCODING" rel="nofollow noreferrer">Python environment variable</a> before the exec command (found an unrelated hint <a href="https://stackoverflow.com/a/44938230/57091">here</a>):</p>
<pre><code>putenv("PYTHONIOENCODING=utf-8");
</code></pre>
<p>My Python script evaluated the arguments like this: </p>
<pre><code>sys.argv[1].decode("utf-8")
</code></pre>
<p>(Hint: That was required because I use a <a href="https://github.com/mpcabd/python-arabic-reshaper" rel="nofollow noreferrer">library</a> to convert some arabic texts.)</p>
<p>So finally, I could imagine that the original question could be solved this way:</p>
<pre><code>setlocale(LC_CTYPE, "en_US.UTF-8");
putenv("PYTHONIOENCODING=utf-8");
$tables = shell_exec('/s/python-2.6.2/bin/python2.6 getWikitables.py ' .
          escapeshellarg($title));
</code></pre>
<p>But I cannot tell anything regarding the return value. In my case I could output it to the browser directly without any problems.</p>
<p>Spent many, many hours to find that out... One of the situations when I hate my job ;-)</p>
</div>
<span class="comment-copy">Can you post a code snippet illustrating how you are calling exec to get the string.</span>
<span class="comment-copy">Neither worked - is it possible the problem is in transmitting from Python to php and I need to do something on the Python side?</span>
<span class="comment-copy">Maybe, or can be the php output charset. Try it <code>header('Content-type: text/html; charset=utf-8');</code> and tell me if you get a different result.</span>
<span class="comment-copy">Nope, still nothing.</span>
<span class="comment-copy">You need take a look on Multibyte library of PHP. This can tell you what is the returned encoding, and you can turn it to utf-8 and make <i>visible</i>.</span>
<span class="comment-copy">Oh god, I just spent 6 hours on this ! The second solution fixes the problem.</span>
