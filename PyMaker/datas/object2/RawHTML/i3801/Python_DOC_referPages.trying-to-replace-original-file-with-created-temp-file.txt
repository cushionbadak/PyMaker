<div class="post-text" itemprop="text">
<p>I want to do some changes in one file. For this purpose I am doing a temporary file where I write content with all wanted changes and at the end I try to replace the original file with this temp one.</p>
<p>Temp file is created and it looks like I expected, but replacing operation do not work.</p>
<p>This is my code which fails:</p>
<pre><code>with tempfile.NamedTemporaryFile(mode='w', prefix=basename, dir=dirname, delete=False) as temp, open(file_path, 'r') as f:
    for line in f:
        temp.write(line + " test")
    os.replace(temp.name, file_path)
</code></pre>
<p>but this gives me an error:</p>
<blockquote>
<p>PermissionError: [WinError 32] The process cannot access the file
  because it is being used by another process</p>
</blockquote>
<p>Is my usage of 'replace' function is wrong? </p>
</div>
<div class="post-text" itemprop="text">
<p>your command os.replace(temp.name, file_path) has to be out of the with.</p>
<pre><code>with tempfile.NamedTemporaryFile(mode='w', prefix=basename, dir=dirname, delete=False) as temp, open(file_path, 'r') as f:
    for line in f:
        temp.write(line + " test")
os.replace(temp.name, file_path)
</code></pre>
</div>
<div class="post-text" itemprop="text">
<p>When you are calling replace() inside 'with' the file is still open as you are still inside the scope of 'with'.</p>
<p>As soon as you're out of 'with' the file has now been closed and you can now replace with os.replace(). </p>
<p>Try it.</p>
<pre><code>with tempfile.NamedTemporaryFile(mode='w', prefix=basename, dir=dirname, delete=False) as temp, open(file_path, 'r') as f:
    for line in f:
        temp.write(line + " test")
os.replace(temp.name, file_path)
</code></pre>
</div>
<span class="comment-copy">That error seems pretty self explanatory. You need to close the temp file after writing, before replacing.</span>
<span class="comment-copy">Don't use <code>os.replace</code>. Use <a href="https://docs.python.org/3/library/shutil.html#shutil.move" rel="nofollow noreferrer"><code>shutil.move</code></a>. <code>os.replace</code> only works if the source and destination are on the same device.</span>
<span class="comment-copy"><code>os.replace</code> is still contained within <code>with tempfile(...) as ...</code>, which means your tempfile is still open. As the error suggests, you cannot change a file while it is still in use. Remove the indent for your last line and you should be fine.</span>
