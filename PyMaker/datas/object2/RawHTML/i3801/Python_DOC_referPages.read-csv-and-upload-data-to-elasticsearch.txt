<div class="post-text" itemprop="text">
<p>I am iterating the rows one by one of a csv file and I want to insert it into es. I'm new to both python and elastic search.How to convert one csv row and insert it into es one by one 
</p>
<pre class="lang-python prettyprint-override"><code>import csv
import json

from elasticsearch import Elasticsearch

es = Elasticsearch(
  [{'host': 'localhost', 'port': 9200}])
 print(es)


def csv_reader(file_obj, delimiter=','):
   reader = csv.reader(file_obj)
   i = 1
   results = []
   for row in reader:
    print(row)
    es.index(index='product', doc_type='prod', id=i, 
   body=json.dump([row for row in reader], file_obj))
    i = i + 1
    results.append(row)
    print(row)


 if __name__ == "__main__":
  with open("/home/Documents/csv/acsv.csv") as f_obj:
    csv_reader(f_obj)
</code></pre>
<p>But I'm getting this error:</p>
<blockquote>
<p>Traceback (most recent call last):</p>
<p>File "/home/PycharmProjects/CsvReaderForSyncEs/csvReader.py", line 25, in  csv_reader(f_obj)</p>
<p>File "/home/PycharmProjects/CsvReaderForSyncEs/csvReader.py", line 17, in csv_reader</p>
<p>es.index(index='product', doc_type='prod', id=i, body=json.dump([row for row in reader], file_obj))</p>
<p>File "/usr/lib/python2.7/json/<strong>init</strong>.py", line 190, in dump fp.write(chunk)</p>
<p>IOError: File not open for writing</p>
</blockquote>
</div>
<div class="post-text" itemprop="text">
<p>Try bulk API.</p>
<pre><code>import csv
from elasticsearch import helpers, Elasticsearch

def csv_reader(file_name):
    es = Elasticsearch([{'host': 'localhost', 'port': 9200}])
    with open(file_name, 'r') as outfile:
        reader = csv.DictReader(outfile)
        helpers.bulk(es, reader, index="index_name", doc_type="type")
</code></pre>
<p>for more information about bulk API
<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/docs-bulk.html" rel="nofollow noreferrer">https://www.elastic.co/guide/en/elasticsearch/reference/current/docs-bulk.html</a></p>
</div>
<div class="post-text" itemprop="text">
<p>The problem is that you are passing <code>file_obj</code> as a parameter for <code>json.dump</code> but the file is only opened for reading. Check the mode parameter for the <code>open</code> function in this <a href="https://docs.python.org/3/library/functions.html#open" rel="nofollow noreferrer">link</a>.</p>
<p>Also check the first parameter for the <code>json.dump</code> function, <code>[row for row in reader]</code> gets all the rows in the <code>csv</code> file, but probably you just want to pass one row, so the parameter should be <code>row</code>.</p>
<p>And <code>json.dump</code> writes to a file, probably you should use the <code>json.dumps</code> function, check <a href="https://docs.python.org/3/library/json.html#json.dumps" rel="nofollow noreferrer">here</a></p>
</div>
<div class="post-text" itemprop="text">
<p>can you try this.
Change reader to DictReader and json.dumps(row).
DictReader make input data is python dict. And for in is loop each row in reader, you just try push row is enough</p>
<pre><code>        es = Elasticsearch([{'host': 'localhost', 'port': 9200}])
        print(es)

        def csv_reader(file_obj, delimiter=','):
            reader = csv.DictReader(file_obj)
            i = 1
            results = []
            for row in reader:
                print(row)
                es.index(index='product', doc_type='prod', id=i,
                         body=json.dumps(row))
                i = i + 1

                results.append(row)
                print(row)

          if __name__ == "__main__":
           with open("/home/Documents/csv/acsv.csv") as f_obj:
           csv_reader(f_obj)
</code></pre>
</div>
<span class="comment-copy">This was exactly what I was looking for. BTW, do you know why the function above appends a dot to the name of the header in the first column of my csv? i.e. <code>".CurrencyType": "Cash"</code></span>
<span class="comment-copy">I have changed to es.index(index='product', doc_type='prod', id=i, body=json.dumps(row))    ............ Strill I am getting the parsing error</span>
<span class="comment-copy">@agxcv I guess the problem is that <code>csv.reader</code> returns the rows as python lists, and for the body you need a python dict, see this <a href="https://hackernoon.com/react-stateless-functional-components-nine-wins-you-might-have-overlooked-997b0d933dbc" rel="nofollow noreferrer">example</a>. Probably you can use the csv <a href="https://docs.python.org/3/library/csv.html#csv.DictReader" rel="nofollow noreferrer"><code>DictReader</code></a></span>
