<div class="post-text" itemprop="text">
<h1><strong>Problem Description:</strong></h1>
<p>I want to crawl some info from the bbs of my college. Here is the address:<a href="http://bbs.byr.cn" rel="nofollow">http://bbs.byr.cn</a>
Below is the code of my spider:</p>
<pre><code>from lxml import etree
import scrapy
try:
from scrapy.spiders import Spider
except:
from scrapy.spiders import BaseSpider as Spider
from scrapy.http import Request

class ITJobInfoSpider(scrapy.Spider):
name = "ITJobInfoSpider"
start_urls = ["http://bbs.byr.cn/#!login"]

def parse(self,response):
    return scrapy.FormRequest.from_response(
        response,
        formdata={'method':'post','id': 'username', 'passwd':'password'},
        formxpath='//form[@action="/login"]',
        callback=self.after_login
)

def after_login(self,response):
    print "######response body: " + response.body +"\n"
    if "authentication failed" in response.body:
        print "#######Login failed#########\n"
    return
</code></pre>
<p>However, with this code, I often get an Error: raise ValueError("No element found in %s" % response)</p>
<h1><strong>My Investigation:</strong></h1>
<p>I find that this Error happens when scrapy try to parse the HTML code of the url: <a href="http://bbs.byr.cn" rel="nofollow">http://bbs.byr.cn</a>, scrappy parses the page with lxml. Below is the code</p>
<pre><code>root = LxmlDocument(response, lxml.html.HTMLParser)
forms = root.xpath('//form')
if not forms:
    raise ValueError("No &lt;form&gt; element found in %s" % response)
</code></pre>
<p>So I look into the code with the code:
    <code>print etree.tostring(root)</code>
And find that HTML element:<code>&lt;/form&gt;</code>is parsed into <code>&amp;lt;/form&amp;gt;</code>
no wonder the code <code>forms = root.xpath('//form')</code> will return an empty forms list.</p>
<blockquote>
<p>But I don't know why this is happening, maybe the HTML code encoding? (The HTML code is encoded with GBK not UTF8.) 
  Thanks advance for anyone who can help me out? BTW, if anyone want to write code against the website, I can give you an test account, pls leave me an email address in the comment.</p>
</blockquote>
<p>Thanks a lot, guys!!</p>
</div>
<div class="post-text" itemprop="text">
<p>There seems to be some JavaScript redirection happening.</p>
<p>In this case using <a href="https://splash.readthedocs.io/en/stable/" rel="nofollow noreferrer">Splash</a> would be overkill, though. Simply append <code>/index</code> to the start URL: <code>http://bbs.byr.cn â†’ http://bbs.byr.cn/index</code></p>
<p>This would be the complete working spider:</p>
<pre class="lang-py prettyprint-override"><code>from scrapy import Spider
from scrapy.http import FormRequest

class ByrSpider(Spider):
    name = 'byr'
    start_urls = ['http://bbs.byr.cn/index']

    def parse(self, response):
        return FormRequest.from_response(
            response,
            formdata={'method':'post','id': 'username', 'passwd':'password'},
            formxpath='//form[@action="/login"]',
            callback=self.after_login)

    def after_login(self, response):
        self.logger.debug(response.text)
        if 'authentication failed' in response.text:
            self.logger.debug('Login failed')
</code></pre>
</div>
<span class="comment-copy">etree.tostring(root),("No element found in %s" % response), dont convert to string use default module parser.Check:  <a href="https://docs.python.org/3/library/xml.etree.elementtree.html" rel="nofollow noreferrer">docs.python.org/3/library/xml.etree.elementtree.html</a> And check forms is not empty !</span>
<span class="comment-copy">Thanks for reply. Do you mean I should get root element with the code below:<code>root = LxmlDocument(response)</code>? This won't work.</span>
<span class="comment-copy">give me test user acoount and pass (id=test,password=test)</span>
<span class="comment-copy">I may just solve my problem, but don't know the reason. I send request to [link]<a href="http://bbs.byr.cn/index" rel="nofollow noreferrer">bbs.byr.cn/index</a>, then I can login successfully. But send request to [link]<a href="http://bbs.byr.cn/" rel="nofollow noreferrer">bbs.byr.cn</a> won't work. Also, I notice that when I send request to [link]<a href="http://bbs.byr.cn/" rel="nofollow noreferrer">bbs.byr.cn</a>, the HTML code in the response is the same with the web page, however, the HTML code I saw after the parse is different.</span>
<span class="comment-copy">@SDilmac It's hanx415/hanx415</span>
