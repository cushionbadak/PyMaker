<div class="post-text" itemprop="text">
<p>I'm trying to make a POST request to the Coinigy API in Python 3. This is the code I've been running.  </p>
<pre><code>from urllib.request import Request, urlopen
from urllib.parse import urlencode

headers = {
  'Content-Type':'application/json',
  'X-API-KEY':'mykey',
  'X-API-SECRET':'mysecretkey'
}

values = {
"exchange_code": "BINA",
"exchange_market": "BTC/USDT",
"type": "all"
}


values = urlencode(values).encode("utf-8")
headers = urlencode(headers).encode("utf-8")


request = Request('https://api.coinigy.com/api/v1/data', data=values, headers=headers)
response_body = urlopen(request,values).read()
print(response_body)
</code></pre>
<p>I'm getting the following error:</p>
<pre><code> AttributeError                            Traceback (most recent call last)
 &lt;ipython-input-41-504342401726&gt; in &lt;module&gt;()
      19 
      20 
 ---&gt; 21 request = Request('https://api.coinigy.com/api/v1/data', 
 data=values, headers=headers)
      22 response_body = urlopen(request,values).read()
      23 print(response_body)

 ~/anaconda3/lib/python3.6/urllib/request.py in __init__(self, url, 
 data, headers, origin_req_host, unverifiable, method)
     333         self.data = data
     334         self._tunnel_host = None
 --&gt; 335         for key, value in headers.items():
     336             self.add_header(key, value)
     337         if origin_req_host is None:

 AttributeError: 'bytes' object has no attribute 'items'
</code></pre>
<p>With a past POST request I wrote to their API for pulling down account activity info, I found I needed to use urlencode(headers).encode("utf-8") to get it in the right format to pass through the API. But now that doesn't seem to work.
 <a href="https://coinigy.docs.apiary.io/#reference/account-data/activity-log/activity" rel="nofollow noreferrer">https://coinigy.docs.apiary.io/#reference/account-data/activity-log/activity</a></p>
<p>If I comment out the headers encode into utf-8 line, it seems to get through to Coinigy, but then it returns the following error code:</p>
<pre><code> b'{"err_num":"1057-14-01","err_msg":"Missing or empty parameters:"}'
</code></pre>
<p>But the urllib.request says that you must pass headers as a dictionary {} so I can't understand what is wrong, it should be the right data structure.  </p>
</div>
<div class="post-text" itemprop="text">
<p>You should not URL encode your <code>headers</code>. <a href="https://docs.python.org/3/library/urllib.request.html#urllib.request.Request" rel="nofollow noreferrer"><code>Request</code> expects <code>headers</code> to be a dictionary</a>:</p>
<blockquote>
<p><code>headers</code> should be a dictionary, and will be treated as if <code>add_header()</code> was called with each key and value as arguments.</p>
</blockquote>
<p>These are HTTP headers and when sent over the wire are in the form (newline-separated, colon space between header name and value):</p>
<pre><code>User-Agent: Mozilla/5.0 blah blah
Content-Length: 500
</code></pre>
<p>So you should pass your <code>headers</code> dictionary in without doing <code>urlencode</code> on it.</p>
<p>This github repo might also be helpful to you: <a href="https://github.com/coinigy/api/blob/master/coinigy_api_rest.py" rel="nofollow noreferrer">https://github.com/coinigy/api/blob/master/coinigy_api_rest.py</a></p>
</div>
<div class="post-text" itemprop="text">
<p>As an update with Bailey's corrections:
1) Passing the values as JSON encoded rather than URL encoded.
2) utf-8 encoding the values</p>
<p>This is the correct code which works now, thanks!</p>
<pre><code>from urllib.request import Request, urlopen
from urllib.parse import urlencode
import json

headers = {
  'Content-Type': 'application/json',
  'X-API-KEY': 'mykey',
  'X-API-SECRET': 'mysecretkey'
}

values = {
    'exchange_code': 'BINA',
    'exchange_market': 'BTC/USDT',
    'type': 'all'
}

values = dumps(values).encode('utf-8')
request = Request('https://api.coinigy.com/api/v1/data/', data=values, 
headers=headers)

response_body = urlopen(request).read()
print(response_body)
</code></pre>
</div>
<span class="comment-copy">Thanks Bailey, yes exactly, I had read that Request requires headers as a dictionary, but when I do this, I get the following error code back from Coinigy.</span>
<span class="comment-copy">Probably not. When you don't include the headers (one of which authenticates your request with your API key), coinigy returns that error because you are missing the headers. Try not serializing the headers (just pass the dict into the <code>Request</code>).</span>
<span class="comment-copy">Ah yep, so apparently your <code>values</code> need to be JSON not urlended. <code>from json import dumps; Request(data=dumps(values))</code></span>
<span class="comment-copy">Sorry to be more clear, when I pass <code>headers</code> as a dictionary I get the following error from the endpoint:    <code>b'{"err_num":"1057-14-01","err_msg":"Missing or empty parameters:"}'</code>  No longer a Python attribute error which is good, but this is the structure mentioned in their documentation. At least as far as I can understand it.</span>
<span class="comment-copy">Yes. And the API requires that your <code>values</code> be JSON encoded. Right now it is urlencoded.</span>
