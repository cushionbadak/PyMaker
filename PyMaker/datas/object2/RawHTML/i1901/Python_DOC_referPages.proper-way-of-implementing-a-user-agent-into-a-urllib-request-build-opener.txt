<div class="post-text" itemprop="text">
<p>I'm trying to set the user agent for my urllib request:</p>
<pre><code>opener = urllib.request.build_opener(
            urllib.request.HTTPCookieProcessor(cj),
            urllib.request.HTTPRedirectHandler(),
            urllib.request.ProxyHandler({'http': proxy})
)
</code></pre>
<p>and finally:</p>
<pre><code>response3 = opener.open("https://www.google.com:443/search?q=test", timeout=timeout_value).read().decode("utf-8")
</code></pre>
<p>What would be the best way to set the user-agent header to</p>
<pre><code>Mozilla/5.0 (Macintosh; Intel Mac OS X 10_9_3) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/35.0.1916.47 Safari/537.36
</code></pre>
</div>
<div class="post-text" itemprop="text">
<p>With <code>urllib</code> we have two options, as far as I know.  </p>
<p><code>build_opener</code> returns a <a href="https://docs.python.org/3/library/urllib.request.html#urllib.request.OpenerDirector" rel="nofollow noreferrer"><code>OpenerDirector</code></a> object, which has an <code>addheaders</code> attribute. We can change the user-agent and other headers with that attribute.</p>
<pre><code>opener.addheaders = [('User-Agent', 'My User-Agent')]

url = 'http://httpbin.org/user-agent'
r = opener.open(url, timeout=5)
text = r.read().decode("utf-8")
</code></pre>
<p>Alternatively, we can install the OpenerDirector object to the global opener with <a href="https://docs.python.org/3/library/urllib.request.html#urllib.request.install_opener" rel="nofollow noreferrer"><code>install_opener</code></a> and use <code>urlopen</code> to submit the request. Now can use <code>Request</code> to set the headers.  </p>
<pre><code>urllib.request.install_opener(opener)

url = 'http://httpbin.org/user-agent'
headers = {'user-agent': "My User-Agent"}
req = urllib.request.Request(url, headers=headers)
r = urllib.request.urlopen(req, timeout=5)
text = r.read().decode("utf-8")
</code></pre>
<p>Personally, I prefer the second method because it is more consistent. Once we install the opener all requests will have the same handlers, and we can continue using urllib the same way. However, if you don't want to use those handlers for all requests you should choose the first method and use <code>addheaders</code> to set headers for a specific OpenerDirector object.  </p>
<hr/>
<p>With <a href="http://docs.python-requests.org/en/master/user/quickstart/" rel="nofollow noreferrer"><code>requests</code></a> things are simpler.  </p>
<p>We can use the <code>session.heders</code> attribute if we want to change the user-agent or other headers for all requests,  </p>
<pre><code>s = requests.session()
s.headers['user-agent'] = "My User-Agent"
r = s.get(url, timeout=5)
</code></pre>
<p>or use the <code>headers</code> parameter if we want to set headers for a specific request only.  </p>
<pre><code>headers = {'user-agent': "My User-Agent"}
r = requests.get(url, headers=headers, timeout=5)
</code></pre>
</div>
