<div class="post-text" itemprop="text">
<p>I am trying to use python <a href="https://docs.python.org/3/extending/embedding.html" rel="nofollow noreferrer">embedding</a> with Python 3 but unfortunately there are some strange outcomes when using it. Here is the source code:</p>
<h2>Scenario 1</h2>
<p>/tmp/main.cpp</p>
<pre><code>#include &lt;python3.6/Python.h&gt;
//#include &lt;python2.7/Python.h&gt;
using namespace std;

int main()
{
    Py_Initialize();
    PyObject* sysPath = PySys_GetObject("path");
    PyObject *path = PyBytes_FromString("/tmp");
    int result = PyList_Append(sysPath, path);
    PyRun_SimpleString("from hello import hello\n"); // there is a /tmp/hello.py
    Py_Finalize();
    return 0;
}
</code></pre>
<p>If I compile and run the above code in Python 2.7 like this, it did not show any errors:</p>
<pre><code>g++ -L/usr/lib/python2.7/config-x86_64-linux-gnu/ -g -o main main.cpp -I/usr/include/python2.7 -lpython2.7
</code></pre>
<p>However, if I compile and run the code in Python 3.6 like this:</p>
<pre><code>g++ -L/usr/lib/python3.6/config-3.6m-x86_64-linux-gnu/ -g -o main main.cpp -I/usr/include/ -lpython3.6
</code></pre>
<p>It will show the following errors:</p>
<pre><code>Traceback (most recent call last):
  File "&lt;string&gt;", line 1, in &lt;module&gt;
  File "/home/tfidm/.local/lib/python3.6/site-packages/numpy/__init__.py", line 142, in &lt;module&gt;
    from . import add_newdocs
  File "/home/tfidm/.local/lib/python3.6/site-packages/numpy/add_newdocs.py", line 13, in &lt;module&gt;
    from numpy.lib import add_newdoc
  File "/home/tfidm/.local/lib/python3.6/site-packages/numpy/lib/__init__.py", line 8, in &lt;module&gt;
    from .type_check import *
  File "/home/tfidm/.local/lib/python3.6/site-packages/numpy/lib/type_check.py", line 11, in &lt;module&gt;
    import numpy.core.numeric as _nx
  File "/home/tfidm/.local/lib/python3.6/site-packages/numpy/core/__init__.py", line 35, in &lt;module&gt;
    from . import _internal  # for freeze programs
  File "/home/tfidm/.local/lib/python3.6/site-packages/numpy/core/_internal.py", line 12, in &lt;module&gt;
    from numpy.compat import basestring
  File "/home/tfidm/.local/lib/python3.6/site-packages/numpy/compat/__init__.py", line 14, in &lt;module&gt;
    from . import py3k
  File "/home/tfidm/.local/lib/python3.6/site-packages/numpy/compat/py3k.py", line 14, in &lt;module&gt;
    from pathlib import Path
  File "/usr/lib/python3.6/pathlib.py", line 4, in &lt;module&gt;
    import ntpath
  File "/usr/lib/python3.6/ntpath.py", line 278, in &lt;module&gt;
    from nt import _getvolumepathname
  File "&lt;frozen importlib._bootstrap&gt;", line 971, in _find_and_load
  File "&lt;frozen importlib._bootstrap&gt;", line 951, in _find_and_load_unlocked
  File "&lt;frozen importlib._bootstrap&gt;", line 894, in _find_spec
  File "&lt;frozen importlib._bootstrap_external&gt;", line 1157, in find_spec
  File "&lt;frozen importlib._bootstrap_external&gt;", line 1129, in _get_spec
  File "&lt;frozen importlib._bootstrap_external&gt;", line 1268, in find_spec
  File "&lt;frozen importlib._bootstrap_external&gt;", line 60, in _path_join
  File "&lt;frozen importlib._bootstrap_external&gt;", line 60, in &lt;listcomp&gt;
TypeError: a bytes-like object is required, not 'str'
Error in sys.excepthook:
Traceback (most recent call last):
  File "/usr/lib/python3/dist-packages/apport_python_hook.py", line 57, in apport_excepthook
    from cStringIO import StringIO
  File "&lt;frozen importlib._bootstrap&gt;", line 971, in _find_and_load
  File "&lt;frozen importlib._bootstrap&gt;", line 951, in _find_and_load_unlocked
  File "&lt;frozen importlib._bootstrap&gt;", line 894, in _find_spec
  File "&lt;frozen importlib._bootstrap_external&gt;", line 1157, in find_spec
  File "&lt;frozen importlib._bootstrap_external&gt;", line 1129, in _get_spec
  File "&lt;frozen importlib._bootstrap_external&gt;", line 1268, in find_spec
  File "&lt;frozen importlib._bootstrap_external&gt;", line 60, in _path_join
  File "&lt;frozen importlib._bootstrap_external&gt;", line 60, in &lt;listcomp&gt;
TypeError: a bytes-like object is required, not 'str'

Original exception was:
Traceback (most recent call last):
  File "&lt;string&gt;", line 1, in &lt;module&gt;
  File "/home/tfidm/.local/lib/python3.6/site-packages/numpy/__init__.py", line 142, in &lt;module&gt;
    from . import add_newdocs
  File "/home/tfidm/.local/lib/python3.6/site-packages/numpy/add_newdocs.py", line 13, in &lt;module&gt;
    from numpy.lib import add_newdoc
  File "/home/tfidm/.local/lib/python3.6/site-packages/numpy/lib/__init__.py", line 8, in &lt;module&gt;
    from .type_check import *
  File "/home/tfidm/.local/lib/python3.6/site-packages/numpy/lib/type_check.py", line 11, in &lt;module&gt;
    import numpy.core.numeric as _nx
  File "/home/tfidm/.local/lib/python3.6/site-packages/numpy/core/__init__.py", line 35, in &lt;module&gt;
    from . import _internal  # for freeze programs
  File "/home/tfidm/.local/lib/python3.6/site-packages/numpy/core/_internal.py", line 12, in &lt;module&gt;
    from numpy.compat import basestring
  File "/home/tfidm/.local/lib/python3.6/site-packages/numpy/compat/__init__.py", line 14, in &lt;module&gt;
    from . import py3k
  File "/home/tfidm/.local/lib/python3.6/site-packages/numpy/compat/py3k.py", line 14, in &lt;module&gt;
    from pathlib import Path
  File "/usr/lib/python3.6/pathlib.py", line 4, in &lt;module&gt;
    import ntpath
  File "/usr/lib/python3.6/ntpath.py", line 278, in &lt;module&gt;
    from nt import _getvolumepathname
  File "&lt;frozen importlib._bootstrap&gt;", line 971, in _find_and_load
  File "&lt;frozen importlib._bootstrap&gt;", line 951, in _find_and_load_unlocked
  File "&lt;frozen importlib._bootstrap&gt;", line 894, in _find_spec
  File "&lt;frozen importlib._bootstrap_external&gt;", line 1157, in find_spec
  File "&lt;frozen importlib._bootstrap_external&gt;", line 1129, in _get_spec
  File "&lt;frozen importlib._bootstrap_external&gt;", line 1268, in find_spec
  File "&lt;frozen importlib._bootstrap_external&gt;", line 60, in _path_join
  File "&lt;frozen importlib._bootstrap_external&gt;", line 60, in &lt;listcomp&gt;
TypeError: a bytes-like object is required, not 'str'
</code></pre>
<h2>Scenario 2</h2>
<p>If I remove the three lines to append the current directory to system path like this:</p>
<pre><code>Py_Initialize();
PyRun_SimpleString("from hello import hello\n");
</code></pre>
<p>It will show the following error in both Python 2 and Python 3:</p>
<pre><code>ModuleNotFoundError: No module named 'hello'
</code></pre>
<hr/>
<p>From Scenario 2, we can observe that the lines to add the current directory to the system path is required. When adding the path is done, the code in scenario 1 works in Python 2 only. The error logs for Python 3 showed that it expects something like byte object rather than string. However I have no clue how to use the embedding with byte object as I cannot find it in the official python website nor any other places on the web.</p>
<p>Please can someone kindly explain how to use embedding properly in Python 3?</p>
</div>
<div class="post-text" itemprop="text">
<p>Python 3 <code>sys.path</code> takes <strong>Unicode</strong> strings, not byte strings. Don't use <code>PyBytes_FromString</code> to create the path element.</p>
<p>Use <a href="https://docs.python.org/3/c-api/unicode.html#c.PyUnicode_FromString" rel="nofollow noreferrer"><code>PyUnicode_FromString</code></a> instead, at least when embedding Python 3.</p>
<p>If the path elements contain just ASCII characters, you can use the same function in Python 2. Non-ASCII character support in <code>sys.path</code> elements in Python 2.x is spotty and depends on the OS.</p>
</div>
