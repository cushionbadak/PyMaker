<div class="post-text" itemprop="text">
<p>I'm trying to use <a href="https://docs.python.org/3/library/shelve.html#shelve.open" rel="nofollow">shelve</a> with Python 3.3. It is recommended to use the <code>with shelve.open('spam.db') as db:...</code> syntax to ensure we close the "connection". However, when I try it I get the following error <code>AttributeError: __exit__</code>. What gives? Any thoughts? Many similar questions here, although couldn't find a satisfying solution. The following shows what I have attempted thus far:</p>
<p>The following fails:</p>
<pre><code>import shelve
with shelve.open('spam.db') as db:
    db['key'] = 'value'
    print(db['key'])
</code></pre>
<p>Error message:</p>
<pre><code>Traceback (most recent call last):
  File "D:\arbitrary_path_to_script\nf_shelve_test.py", line 3, in &lt;module&gt;
    with shelve.open('spam.db') as db:
AttributeError: __exit__
[Finished in 0.1s with exit code 1]
</code></pre>
<p>The following works:</p>
<pre><code>import shelve
db = shelve.open('spam.db')
db['key'] = 'value'
print(db['key'])
db.close()
</code></pre>
<p>And outputs the expected:</p>
<pre><code>value
[Finished in 0.1s]
</code></pre>
<p>Printing the shelve module path</p>
<pre><code>import shelve
print(shelve)
</code></pre>
<p>Location:</p>
<pre><code>&lt;module 'shelve' from 'C:\\Python33\\lib\\shelve.py'&gt;
[Finished in 0.1s]
</code></pre>
</div>
<div class="post-text" itemprop="text">
<p>In Python 3.3 <code>shelve.open()</code> is not a context manager and cannot be used in a <code>with</code> statement. The <code>with</code> statement expects there to be <a href="https://docs.python.org/3/reference/datamodel.html#with-statement-context-managers" rel="nofollow"><code>__enter__</code> and <code>__exit__</code> methods</a>; the error you see is because there are no such methods.</p>
<p>You can use <a href="https://docs.python.org/3/library/contextlib.html#contextlib.closing" rel="nofollow"><code>contextlib.closing()</code></a> to wrap the <code>shelve.open()</code> result in a context manager here:</p>
<pre><code>from contextlib import closing

with closing(shelve.open('spam.db')) as db:
</code></pre>
<p>Alternatively, upgrade to Python 3.4, where the required context manager methods were added to the return value of <code>shelve.open()</code>. From the <a href="https://docs.python.org/3/library/shelve.html#shelve.Shelf" rel="nofollow"><code>shelve.Shelve</code> documentation</a>:</p>
<blockquote>
<p><em>Changed in version 3.4</em>: Added context manager support.</p>
</blockquote>
</div>
<div class="post-text" itemprop="text">
<p><code>Shelf</code> isn't a context manager in Python 3.3; this functionality was introduced in 3.4. If you need to support 3.3, you'll need to use <code>contextlib.closing</code> or an explicit <code>close</code> in a finally block. I recommend <code>contextlib.closing</code>.</p>
<pre><code>import contextlib

with contextlib.closing(shelve.open('spam.db')) as db:
    do_whatever_with(db)
</code></pre>
</div>
<span class="comment-copy"><code>shelve.open()</code> is not returning a context manager.</span>
<span class="comment-copy"><a href="http://bugs.python.org/13896" rel="nofollow noreferrer">bugs.python.org/13896</a> and fix: <a href="https://hg.python.org/cpython/file/3c1df1ede882/Lib/shelve.py" rel="nofollow noreferrer">hg.python.org/cpython/file/3c1df1ede882/Lib/shelve.py</a></span>
<span class="comment-copy">Thanks a lot! I was reading the python 3 (no 'point' something) documentation, which it seems uses the latest documentation which is 3.4 thus got confused when it suggested using 'with'. I think I'll just upgrade. Not married to 3.3.</span>
<span class="comment-copy">Thank you. You and Martijn Pieters submitted at the same time. I'm awarding him the answer, but it's practically arbitrary since both of you have the same contribution. Sorry about that.</span>
