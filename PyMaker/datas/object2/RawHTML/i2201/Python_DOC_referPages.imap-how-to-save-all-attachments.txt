<div class="post-text" itemprop="text">
<p>I am trying to save excel file attachments from my inbox to a directory. My code is executing just fine because I am seeing the print outs but the attachments wont save in the file directory. Is there something I am missing in my code that is preventing the action of saving? </p>
<pre><code> import email, getpass, imaplib, os, sys


detach_dir = r'\directory link'

user = "test"
pwd = "test"
sender_email = "example@example.com"

m = imaplib.IMAP4_SSL("outlook.office365.com")
m.login(user,pwd)


m.select('"INBOX/somestuff"')

print("ok")



resp, items = m.search(None, 'FROM', '"%s"' % sender_email)
items = items[0].split()

print("ok")

for emailid in items:
    resp, data = m.fetch(emailid, "(RFC822)")
    email_body = data[0][1].decode('utf-8')
    mail = email.message_from_string(email_body)

    print("ok")

    if mail.get_content_maintype() != 'multipart':
        continue



    subject = ""

    if mail["subject"] is not None:
        subject = mail["subject"]

    print ("["+mail["From"]+"] :" + subject)

    for part in mail.walk():
        if part.get_content_maintype() == 'multipart':
            continue

        if part.get('Content-Disposition') is None:
            continue

        filename = part.get_filename()
        counter = 1

        if not filename:
            filename = 'part-%03d%s' % (counter, 'bin')
            counter += 1

        att_path = os.path.join(detach_dir, filename)

        if not os.path.isfile(att_path) :
            fp = open(att_path, 'wb')
            fp.write(part.get_payload(decode=True))
            fp.close()
</code></pre>
<p>This code saves just one of the attachments in the subfolder but I am looking to get all attachments save to the directory:</p>
<pre><code>detach_dir = r'directory link'
m = imaplib.IMAP4_SSL("outlook.office365.com")
m.login('user','pass')
m.select('"INBOX/subfolder"')

resp, items = m.search(None, 'All')
items = items[0].split()

for emailid in items:
    resp, data = m.fetch(emailid, "(RFC822)") 
    filename = part.get_filename()
    print(filename)
    att_path = os.path.join(detach_dir, filename)
    fp = open(att_path, 'wb')
    fp.write(part.get_payload(decode=True))
    fp.close()

    print('check folder')
</code></pre>
</div>
<div class="post-text" itemprop="text">
<blockquote>
<p><strong>Question</strong>: This code saves just <strong>one</strong> of the attachments ... but I am looking to get <strong>all attachments</strong> </p>
</blockquote>
<p>Implement <a href="https://docs.python.org/3/library/email.message.html#email.message.EmailMessage.iter_attachments" rel="nofollow noreferrer">iter-attachments()</a> </p>
<pre><code>resp, items = imap.search(None, "(UNSEEN)")

for n, num in enumerate(items[0].split(), 1):
    resp, data = imap.fetch(num, '(RFC822)')

    data01 = data[0][1]
    msg_obj = email.message_from_string(data01)

    for part in msg_obj.iter_attachments():
        filename = part.get_filename()
        print(filename)
</code></pre>
<blockquote>
<p><strong>iter_attachments()</strong> </p>
<blockquote>
<p>Return an iterator over all of the immediate sub-parts of the message that are not candidate “body” parts. That is, skip the first occurrence of each of text/plain, text/html, multipart/related, or multipart/alternative (unless they are explicitly marked as attachments via Content-Disposition: attachment), and return all remaining parts.</p>
</blockquote>
</blockquote>
<p>Used modules and classes:<br/>
<a href="https://docs.python.org/3/library/imaplib.html#imaplib.IMAP4" rel="nofollow noreferrer">class imaplib.IMAP4</a>
<a href="https://docs.python.org/3/library/email.message.html" rel="nofollow noreferrer">class email.message.EmailMessage</a></p>
<p><a href="https://docs.python.org/3/library/email.examples.html" rel="nofollow noreferrer">Here’s an example of how to unpack a MIME message, using email.message.walk(), into a directory of files:</a></p>
</div>
<span class="comment-copy">that function is not recognized. do you have a full script that works with that? maybe I am missing something.</span>
<span class="comment-copy">@orangecodelife: Updated my Answer. Show your Python version.</span>
<span class="comment-copy">the verison I'm using is Python 3</span>
