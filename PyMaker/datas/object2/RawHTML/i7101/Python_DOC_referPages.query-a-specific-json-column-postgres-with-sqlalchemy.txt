<div class="post-text" itemprop="text">
<p>I have a model with a JSON field:</p>
<pre><code>class Item(db.Model)
   ...
   data = db.Column(JSON, nullable=False)
   ...
</code></pre>
<p>The data contains some JSON such as:</p>
<pre><code>{
    "cost": 10.00,
    "passengers": 2,
    "surcharge": 1.6
}
</code></pre>
<p>I want to be able to get a sum of the cost across all rows in the table with a filter. I tried the following but that didn't seem to work.</p>
<pre><code>db.session.query(func.count(Item.data['cost'])).filter(
          Item.data["surcharge"].cast(Float) &gt; 1
      ).scalar()
</code></pre>
</div>
<div class="post-text" itemprop="text">
<p>You're using the wrong <a href="https://www.postgresql.org/docs/current/static/functions-aggregate.html" rel="nofollow noreferrer">aggregate</a>. <code>count(expression)</code> counts the number of rows for which the <em>expression</em> is not null. If you want a sum, use <code>sum(expression)</code>:</p>
<pre><code>db.session.query(func.sum(Item.data['cost'].astext.cast(Numeric))).\
    filter(Item.data['surcharge'].astext.cast(Numeric) &gt; 1).\
    scalar()
</code></pre>
<p>Note that monetary values and binary floating point math is a bad mixture due to <a href="https://stackoverflow.com/questions/588004/is-floating-point-math-broken">binary floats not being able to represent all decimal values</a>. Instead use a proper <a href="https://www.postgresql.org/docs/current/static/datatype-money.html" rel="nofollow noreferrer">monetary type</a>, or <a href="http://docs.sqlalchemy.org/en/latest/core/type_basics.html#sqlalchemy.types.Numeric" rel="nofollow noreferrer"><code>Numeric</code></a> in which case SQLAlchemy uses <a href="https://docs.python.org/3/library/decimal.html" rel="nofollow noreferrer"><code>Decimal</code></a> to represent the results in Python.</p>
</div>
<div class="post-text" itemprop="text">
<p>You need to use <a href="http://docs.sqlalchemy.org/en/latest/core/type_basics.html#sqlalchemy.types.Float" rel="nofollow noreferrer"><code>Float</code></a> instead of <a href="http://docs.sqlalchemy.org/en/latest/core/type_basics.html#sqlalchemy.types.Integer" rel="nofollow noreferrer"><code>Integer</code></a> as argument of <a href="http://docs.sqlalchemy.org/en/latest/core/sqlelement.html?highlight=cast#sqlalchemy.sql.expression.cast" rel="nofollow noreferrer"><code>cast</code></a></p>
<pre><code>db.session.query(func.count(Item)).filter(
          Item.data['surcharge'].cast(Float) &gt; 1
      ).all()
</code></pre>
</div>
<span class="comment-copy">Though PostgreSQL <code>JSONB</code> stores numbers in numeric, and <code>JSON</code> as decimal strings... However, needs some special handling with Python ...</span>
<span class="comment-copy">Thanks that worked</span>
<span class="comment-copy">Fair point, I've updated the query but that still doesn't work. It just returns 0.</span>
