<div class="post-text" itemprop="text">
<p>How does one use put_bucket_policy()? It throws a MalformedPolicy error even when I try to pass in an existing valid policy:</p>
<pre><code>import boto3
client = boto3.client('s3')
dict_policy = client.get_bucket_policy(Bucket = 'my_bucket')
str_policy = str(dict_policy)
response = client.put_bucket_policy(Bucket = 'my_bucket', Policy = str_policy)
</code></pre>
<p><strong>* error message: *</strong></p>
<pre><code>botocore.exceptions.ClientError: An error occurred (MalformedPolicy) when calling the PutBucketPolicy operation: This policy contains invalid Json
</code></pre>
</div>
<div class="post-text" itemprop="text">
<p>That's because applying <code>str</code> to a <code>dict</code> doesn't turn it into a valid json, use <a href="https://docs.python.org/3/library/json.html#json.dumps" rel="nofollow"><code>json.dumps</code></a> instead:</p>
<pre><code>import boto3
import json
client = boto3.client('s3')
dict_policy = client.get_bucket_policy(Bucket = 'my_bucket')
str_policy = json.dumps(dict_policy)
response = client.put_bucket_policy(Bucket = 'my_bucket', Policy = str_policy)
</code></pre>
</div>
<div class="post-text" itemprop="text">
<p>Current boto3 API doesn't have a function to APPEND the bucket policy, whether add another items/elements/attributes.  You need load and manipulate the JSON yourself. E.g. write script load the policy into a dict, append the "Statement"  element list,  then use the policy.put to replace the whole policy. Without the original statement id, user policy will be appended. HOWEVER, there is no way to tell whether later user policy will override rules of the earlier one. </p>
<p>For example </p>
<pre><code>import boto3
s3_conn = boto3.resource('s3')
bucket_policy = s3_conn.BucketPolicy('bucket_name')
policy = s3_conn.get_bucket_policy(Bucket='bucket_name')
user_policy = { "Effect": "Allow",... } 
new_policy =  policy['Statement'].append(user_policy)
bucket_policy.put(Policy=new_policy) 
</code></pre>
<p>The user don't need know the old policy in the process.  </p>
</div>
<span class="comment-copy">thanks -- received the following error: botocore.exceptions.ClientError: An error occurred (MalformedPolicy) when calling the PutBucketPolicy operation: Unknown field Policy"</span>
<span class="comment-copy">how is that error possible, given that I got the policy from a valid bucket?</span>
