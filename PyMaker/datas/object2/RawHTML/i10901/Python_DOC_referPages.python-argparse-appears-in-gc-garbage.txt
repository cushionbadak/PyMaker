<div class="post-text" itemprop="text">
<p>I'm trying to debug a memory leak in a python application and I can see a lot of non collected object belonging to the module <code>argparse</code> </p>
<p>Here a minimal script reproducing the error</p>
<pre><code>import gc
gc.set_debug(gc.DEBUG_LEAK)

def get_cli_arguments():
    import argparse
    parser = argparse.ArgumentParser(description='Launch a RHM server')
    parser.add_argument(
        '--port',
        metavar='port',
        type=int,
        nargs='?',
        help='the server port',
        default=8003
    )
    return vars(parser.parse_args())


def main():
    args = get_cli_arguments()
    x = "AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"


main()
gc.collect()
print(gc.garbage)
</code></pre>
<p>and I got the following output</p>
<pre><code>gc: collectable &lt;dict 0x7f9a8b303c58&gt;
gc: collectable &lt;dict 0x7f9a8b303d70&gt;
gc: collectable &lt;list 0x7f9a8b350ea8&gt;
gc: collectable &lt;list 0x7f9a8b350b00&gt;
gc: collectable &lt;list 0x7f9a8b3dca70&gt;
gc: collectable &lt;_ArgumentGroup 0x7f9a8b3e6250&gt;
gc: collectable &lt;dict 0x7f9a8b301910&gt;
gc: collectable &lt;list 0x7f9a8b3535a8&gt;
gc: collectable &lt;list 0x7f9a8b3e1758&gt;
gc: collectable &lt;function 0x7f9a8b3d2d70&gt;
gc: collectable &lt;dict 0x7f9a8b301a28&gt;
gc: collectable &lt;list 0x7f9a8b3e17e8&gt;
gc: collectable &lt;_HelpAction 0x7f9a8b3e60d0&gt;
gc: collectable &lt;dict 0x7f9a8b3014b0&gt;
gc: collectable &lt;HelpFormatter 0x7f9a8b2f7f90&gt;
gc: collectable &lt;_Section 0x7f9a8b2f7fd0&gt;
gc: collectable &lt;dict 0x7f9a8b3016e0&gt;
gc: collectable &lt;list 0x7f9a8b350248&gt;
gc: collectable &lt;dict 0x7f9a8b3015c8&gt;
gc: collectable &lt;dict 0x7f9a8b303e88&gt;
gc: collectable &lt;list 0x7f9a8b3e1d40&gt;
gc: collectable &lt;_StoreAction 0x7f9a8b30a090&gt;
gc: collectable &lt;dict 0x7f9a8b2f9c58&gt;
gc: collectable &lt;HelpFormatter 0x7f9a8b30a0d0&gt;
gc: collectable &lt;_Section 0x7f9a8b30a110&gt;
gc: collectable &lt;dict 0x7f9a8b3017f8&gt;
gc: collectable &lt;list 0x7f9a8b36c200&gt;
gc: collectable &lt;dict 0x7f9a8b301b40&gt;
[{'action': {'store_false': &lt;class 'argparse._StoreFalseAction'&gt;, 'append_const': &lt;class 'argparse._AppendConstAction'&gt;, 'help': &lt;class 'argparse._HelpAction'&gt;, None: &lt;class 'argparse._StoreAction'&gt;, 'store_true': &lt;class 'argparse._StoreTrueAction'&gt;, 'count': &lt;class 'argparse._CountAction'&gt;, 'store_const': &lt;class 'argparse._StoreConstAction'&gt;, 'version': &lt;class 'argparse._VersionAction'&gt;, 'store': &lt;class 'argparse._StoreAction'&gt;, 'parsers': &lt;class 'argparse._SubParsersAction'&gt;, 'append': &lt;class 'argparse._AppendAction'&gt;}, 'type': {None: &lt;function identity at 0x7f9a8b3d2d70&gt;}}, {'store_false': &lt;class 'argparse._StoreFalseAction'&gt;, 'append_const': &lt;class 'argparse._AppendConstAction'&gt;, 'help': &lt;class 'argparse._HelpAction'&gt;, None: &lt;class 'argparse._StoreAction'&gt;, 'store_true': &lt;class 'argparse._StoreTrueAction'&gt;, 'count': &lt;class 'argparse._CountAction'&gt;, 'store_const': &lt;class 'argparse._StoreConstAction'&gt;, 'version': &lt;class 'argparse._VersionAction'&gt;, 'store': &lt;class 'argparse._StoreAction'&gt;, 'parsers': &lt;class 'argparse._SubParsersAction'&gt;, 'append': &lt;class 'argparse._AppendAction'&gt;}, [_HelpAction(option_strings=['-h', '--help'], dest='help', nargs=0, const=None, default='==SUPPRESS==', type=None, choices=None, help='show this help message and exit', metavar=None), _StoreAction(option_strings=['--port'], dest='port', nargs='?', const=None, default=8003, type=&lt;type 'int'&gt;, choices=None, help='the server port', metavar='port')], [], [], &lt;argparse._ArgumentGroup object at 0x7f9a8b3e6250&gt;, {'_mutually_exclusive_groups': [], '_negative_number_matcher': &lt;_sre.SRE_Pattern object at 0x7f9a8b437290&gt;, 'description': None, '_option_string_actions': {'--port': _StoreAction(option_strings=['--port'], dest='port', nargs='?', const=None, default=8003, type=&lt;type 'int'&gt;, choices=None, help='the server port', metavar='port'), '-h': _HelpAction(option_strings=['-h', '--help'], dest='help', nargs=0, const=None, default='==SUPPRESS==', type=None, choices=None, help='show this help message and exit', metavar=None), '--help': _HelpAction(option_strings=['-h', '--help'], dest='help', nargs=0, const=None, default='==SUPPRESS==', type=None, choices=None, help='show this help message and exit', metavar=None)}, 'title': 'optional arguments', '_has_negative_number_optionals': [], '_defaults': {}, 'prefix_chars': '-', 'argument_default': None, '_registries': {'action': {'store_false': &lt;class 'argparse._StoreFalseAction'&gt;, 'append_const': &lt;class 'argparse._AppendConstAction'&gt;, 'help': &lt;class 'argparse._HelpAction'&gt;, None: &lt;class 'argparse._StoreAction'&gt;, 'store_true': &lt;class 'argparse._StoreTrueAction'&gt;, 'count': &lt;class 'argparse._CountAction'&gt;, 'store_const': &lt;class 'argparse._StoreConstAction'&gt;, 'version': &lt;class 'argparse._VersionAction'&gt;, 'store': &lt;class 'argparse._StoreAction'&gt;, 'parsers': &lt;class 'argparse._SubParsersAction'&gt;, 'append': &lt;class 'argparse._AppendAction'&gt;}, 'type': {None: &lt;function identity at 0x7f9a8b3d2d70&gt;}}, '_group_actions': [_HelpAction(option_strings=['-h', '--help'], dest='help', nargs=0, const=None, default='==SUPPRESS==', type=None, choices=None, help='show this help message and exit', metavar=None), _StoreAction(option_strings=['--port'], dest='port', nargs='?', const=None, default=8003, type=&lt;type 'int'&gt;, choices=None, help='the server port', metavar='port')], '_action_groups': [], 'conflict_handler': 'error', '_actions': [_HelpAction(option_strings=['-h', '--help'], dest='help', nargs=0, const=None, default='==SUPPRESS==', type=None, choices=None, help='show this help message and exit', metavar=None), _StoreAction(option_strings=['--port'], dest='port', nargs='?', const=None, default=8003, type=&lt;type 'int'&gt;, choices=None, help='the server port', metavar='port')]}, [], [_HelpAction(option_strings=['-h', '--help'], dest='help', nargs=0, const=None, default='==SUPPRESS==', type=None, choices=None, help='show this help message and exit', metavar=None), _StoreAction(option_strings=['--port'], dest='port', nargs='?', const=None, default=8003, type=&lt;type 'int'&gt;, choices=None, help='the server port', metavar='port')], &lt;function identity at 0x7f9a8b3d2d70&gt;, {None: &lt;function identity at 0x7f9a8b3d2d70&gt;}, ['-h', '--help'], _HelpAction(option_strings=['-h', '--help'], dest='help', nargs=0, const=None, default='==SUPPRESS==', type=None, choices=None, help='show this help message and exit', metavar=None), {'const': None, 'help': 'show this help message and exit', 'option_strings': ['-h', '--help'], 'dest': 'help', 'required': False, 'nargs': 0, 'choices': None, 'default': '==SUPPRESS==', 'container': &lt;argparse._ArgumentGroup object at 0x7f9a8b3e6250&gt;, 'type': None, 'metavar': None}, &lt;argparse.HelpFormatter object at 0x7f9a8b2f7f90&gt;, &lt;argparse._Section object at 0x7f9a8b2f7fd0&gt;, {'items': [], 'formatter': &lt;argparse.HelpFormatter object at 0x7f9a8b2f7f90&gt;, 'heading': None, 'parent': None}, [], {'_current_indent': 0, '_level': 0, '_indent_increment': 2, '_action_max_length': 0, '_max_help_position': 24, '_width': 78, '_root_section': &lt;argparse._Section object at 0x7f9a8b2f7fd0&gt;, '_long_break_matcher': &lt;_sre.SRE_Pattern object at 0x7f9a8b33e258&gt;, '_prog': 'prout.py', '_current_section': &lt;argparse._Section object at 0x7f9a8b2f7fd0&gt;, '_whitespace_matcher': &lt;_sre.SRE_Pattern object at 0x7f9a8b347750&gt;}, {'--port': _StoreAction(option_strings=['--port'], dest='port', nargs='?', const=None, default=8003, type=&lt;type 'int'&gt;, choices=None, help='the server port', metavar='port'), '-h': _HelpAction(option_strings=['-h', '--help'], dest='help', nargs=0, const=None, default='==SUPPRESS==', type=None, choices=None, help='show this help message and exit', metavar=None), '--help': _HelpAction(option_strings=['-h', '--help'], dest='help', nargs=0, const=None, default='==SUPPRESS==', type=None, choices=None, help='show this help message and exit', metavar=None)}, ['--port'], _StoreAction(option_strings=['--port'], dest='port', nargs='?', const=None, default=8003, type=&lt;type 'int'&gt;, choices=None, help='the server port', metavar='port'), {'const': None, 'help': 'the server port', 'option_strings': ['--port'], 'dest': 'port', 'required': False, 'nargs': '?', 'choices': None, 'default': 8003, 'container': &lt;argparse._ArgumentGroup object at 0x7f9a8b3e6250&gt;, 'type': &lt;type 'int'&gt;, 'metavar': 'port'}, &lt;argparse.HelpFormatter object at 0x7f9a8b30a0d0&gt;, &lt;argparse._Section object at 0x7f9a8b30a110&gt;, {'items': [], 'formatter': &lt;argparse.HelpFormatter object at 0x7f9a8b30a0d0&gt;, 'heading': None, 'parent': None}, [], {'_current_indent': 0, '_level': 0, '_indent_increment': 2, '_action_max_length': 0, '_max_help_position': 24, '_width': 78, '_root_section': &lt;argparse._Section object at 0x7f9a8b30a110&gt;, '_long_break_matcher': &lt;_sre.SRE_Pattern object at 0x7f9a8b33e258&gt;, '_prog': 'prout.py', '_current_section': &lt;argparse._Section object at 0x7f9a8b30a110&gt;, '_whitespace_matcher': &lt;_sre.SRE_Pattern object at 0x7f9a8b347750&gt;}]
</code></pre>
<p>I can't find any report of such a problem in argparse, am I doing something wrong?</p>
</div>
<div class="post-text" itemprop="text">
<p>This line</p>
<pre><code>gc.set_debug(gc.DEBUG_LEAK)
</code></pre>
<p>Is <a href="https://docs.python.org/3/library/gc.html#gc.DEBUG_LEAK" rel="nofollow">equivalent to saying</a></p>
<pre><code>gc.set_debug(gc.DEBUG_COLLECTABLE | gc.DEBUG_UNCOLLECTABLE | gc.DEBUG_SAVEALL)
</code></pre>
<p>And <a href="https://docs.python.org/3/library/gc.html#gc.DEBUG_SAVEALL" rel="nofollow">by setting <code>DEBUG_SAVEALL</code></a>,</p>
<blockquote>
<p>When set, all unreachable objects found will be appended to garbage rather than being freed.</p>
</blockquote>
<p>In fact, these <em>would</em> have been freed, had you not set <code>DEBUG_LEAK</code>.  (Try your code it without setting <code>DEBUG_LEAK</code>)</p>
<p>The flag you likely want is <a href="https://docs.python.org/3/library/gc.html#gc.DEBUG_UNCOLLECTABLE" rel="nofollow"><code>gc.DEBUG_UNREACHABLE</code></a>, which displays information about objects that are unreachable (and should probably be freed) but cannot be freed by the garbage collector.</p>
<p>You could also look at <code>DEBUG_COLLECTABLE</code> to help identify circular references that <em>can</em> be freed.</p>
</div>
