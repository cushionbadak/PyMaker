<div class="post-text" itemprop="text">
<p>Hi I'm trying to use ML to predict some future sales. So i would like to add mean sales from the previous month/year for each product</p>
<p>My df is something like: <code>[ id | year | month | product_id | sales ]</code> I would like to add <code>prev_month_mean_sale</code> and <code>prev_month_id_sale</code> columns</p>
<pre><code>id | year | month | product_id | sales | prev_month_mean_sale | prev_month_id_sale
----------------------------------------------------------------------
1  | 2018 |   1   |    123     |   5   |         NaN          |    NaN          
2  | 2018 |   1   |    234     |   4   |         NaN          |    NaN
3  | 2018 |   1   |    345     |   2   |         NaN          |    NaN
4  | 2018 |   2   |    123     |   3   |         3.6          |     5 
5  | 2018 |   2   |    345     |   2   |         3.6          |     2 
6  | 2018 |   3   |    123     |   4   |         2.5          |     3 
7  | 2018 |   3   |    234     |   6   |         2.5          |     0 
8  | 2018 |   3   |    567     |   7   |         2.5          |     0 
9  | 2019 |   1   |    234     |   4   |         5.6          |     6 
10 | 2019 |   1   |    567     |   3   |         5.6          |     7 
</code></pre>
<p>also I would like to add <code>prev_year_mean_sale</code> and <code>prev_year_id_sale</code>
<code>prev_month_mean_sale</code> is the mean of the total sales of the previuos month, eg: for month 2 is (5+4+2)/3</p>
<p>My actual code is something like:</p>
<pre><code>for index,row in df.iterrows():

   loc = df.index[(df['month'] == row['month']-1) &amp; 
                  (df['year'] == row['year']) &amp; 
                  (df['product_id'] == row['product_id']).tolist()[0]]

   df.loc[index, 'prev_month_id_sale'] = df.loc[ loc ,'sales']
</code></pre>
<p>but it is really slow and my df is really big. Maybe there is another option using <code>groupby()</code> or something like that.</p>
</div>
<div class="post-text" itemprop="text">
<p>A simple way to avoid loop is to use <code>merge()</code> from dataframe:</p>
<pre><code>df["prev_month"] = df["month"] - 1
result = df.merge(df.rename(columns={"sales", "prev_month_id"sale"}),
                  how="left",
                  left_on=["year", "prev_month", "product_id"],
                  right_on=["year", "month", "product_id"])
</code></pre>
<p>The <code>result</code> in this way will have more columns than you needed. You should <code>drop()</code> some of them and/or <code>rename()</code> some other.</p>
</div>
