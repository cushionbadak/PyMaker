<div class="post-text" itemprop="text">
<p>Hello Everyone and thank you for your time. In the previous couple of days I have been undergoing a little project of mine to create a online chatbot for LINE. I understand the API but ran into a problem. I am trying to get my chabot to use online responses to user text. To accomplish this I am trying to use a websocket between python and JavaScript. The API I am using is in python hence the websocket must also be written in Python. I picked asyncio websockets. In short, I am trying to fetch a response from a user input on Line --&gt; Send that response over a websocket to my javascript in a browser console --&gt; The javascript will proceed with it's logic and send the response back to the server --&gt; the Program will proceed with it's execution. My problem is that both the Websocket programming as well as my Line programming use a loop. The Line Code can be seen at</p>
<p><a href="https://github.com/fadhiilrachman/line-py/blob/master/examples/groupbot.py" rel="nofollow noreferrer">https://github.com/fadhiilrachman/line-py/blob/master/examples/groupbot.py</a></p>
<p>As you can see at the end of the code there is a while statement which traces the READ_MESSAGE Function over and over again for each message. You can ignore the NOTIFIED_LEAVE one. So basically my code while proceed with it's own logic and then do something like:</p>
<pre><code>else:
#ExternalBot code
ExtText = text[6:]
</code></pre>
<p>I now wish to send this ExtText over my websocket to my javascript which will fetch a response from the browser and send it back. The javascript will do something like this:</p>
<pre><code>exampleSocket = new WebSocket("ws://192.168.1.9:8765/") 
exampleSocket.onmessage = function(e){
var server_message = e.data;
console.log(server_message);
(logic)
exampleSocket.send(response);
</code></pre>
<p>Now this is where the problem begins as I simply do not know how to proceed. The python asyncio Websockets requires a loop to run as seen below:</p>
<pre><code>async def Send(websocket, path):
    await websocket.send(ExtText)
    await Receive(websocket, path)

async def Receive(websocket, path):
    resposne = await websocket.recv()
    if response is None:
        await Recieve(websocket, path)
    else:
        print (Response)

    start_server = websockets.serve(Send,'192.168.1.9','8765')
    loop = asyncio.get_event_loop()
    loop.run_untill_complete(start_server)
    loop.run_forever()

   (continue to do a line.send() the response back to the client on Line.)
</code></pre>
<p>This is the code that I currently have. Now the problem is, If I never close the loop the loop with something like loop.call_soon_threadsafe(loop.stop) it will keep running and in turn the message will never get sent back to the client(the program will not proceed with it's LINE logic). if I DO close the loop the server is "shutdown" in effect. If the server is shutdown and reopened for each message I have to send over the websocket, I now face the problem of getting my JavaScript to continually try to reconnect to the server every single message. I have tried this and have never succeeded in getting the Javascript to keep trying to establish a connection. I have tried to use Javascript websocket readyState attribute but that hasn't worked either. I am coming here simply because I Have no idea on how to proceed and what to do further. How do you people suggest I proceed, closing the loop or somehow leaving it open but continuing with my program's logic. If so how would you go about implementing it into my already looping code( the LINE while true statement)? I really do apologize for such a long question but I am completely stuck. Thank you for your time people who decide to read and help me, I really appreciate it.</p>
</div>
<div class="post-text" itemprop="text">
<p>After days of research I have solved the issue by separating the loops into two python scripts and communicating between them. If anyone here has a similar issue and wishes a more in depth explanation, feel free to ask me.</p>
</div>
<span class="comment-copy">Well, it is not an easy problem. It seems this line client is just incompatible with asyncio. I suggest you to try moving line client polling process to another thread using <a href="https://docs.python.org/3/library/asyncio-eventloop.html#executor" rel="nofollow noreferrer">executors API</a>. But you must be careful with thread safety</span>
<span class="comment-copy">Thank you for the reply. Is it possible to move the server to another separate python program and somehow communicate between the two?</span>
<span class="comment-copy">it is definitely possible, but you will still have a problem - you would have to switch between running main program loop and checking between-the-two-programs communication channel for new data. Solving this problem efficiently is non trivial and requires some skills in concurrent programming</span>
<span class="comment-copy">It is quite interesting problem, so I will try to code it, when I will have time and good mood</span>
<span class="comment-copy">Ok thanks. Perhaps the elif statement (when conditions call for the external text to be called) can trigger the communication?</span>
