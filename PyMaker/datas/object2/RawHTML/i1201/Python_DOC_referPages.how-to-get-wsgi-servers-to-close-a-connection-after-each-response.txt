<div class="post-text" itemprop="text">
<p>The API for Python's <a href="https://docs.python.org/3/library/wsgiref.html#module-wsgiref" rel="nofollow noreferrer">wsgiref module</a> precludes <a href="https://docs.python.org/3/library/wsgiref.html#wsgiref.util.is_hop_by_hop" rel="nofollow noreferrer">hop-by-hop</a> headers (as defined in <a href="https://tools.ietf.org/html/rfc2616.html" rel="nofollow noreferrer">RFC 2616</a>). </p>
<p>I'm unclear on how to get the server to terminate a connection after a response (since there doesn't seem to be a way to add <code>Connection: close</code>).</p>
<p>This problem comes up in testing small WSGI apps and <a href="https://bottlepy.org/docs/dev/" rel="nofollow noreferrer">Bottle</a> micro-services.  Calls from <a href="https://curl.haxx.se/" rel="nofollow noreferrer"><em>curl</em></a> get blocked by open connections from a browser.  I have to click a browser refresh to terminate the connection so that the pending curl request can be answers.   </p>
<p>Obviously, this should be a server side decision (terminate connection after a response) rather than client-side.  I'm unclear how to implement this.</p>
</div>
<div class="post-text" itemprop="text">
<p>This is really predicated on your WSGI server you are hosting your framework via.  The best solution with bottle is to run it through gevent.  </p>
<pre><code>botapp = bottle.app()
for Route in (mainappRoute,): #handle multiple files containing routes
    botapp.merge(Route)
botapp = SessionMiddleware(botapp, beakerconfig) #in case you are using beaker sessions
botapp = WhiteNoise(botapp) #in case you want whitenoise to handle static files
botapp.add_files(staticfolder, prefix='static/') #add static route to whitenoise
server = WSGIServer(("0.0.0.0", int(80)), botapp) #gevent async web server
def shutdown():
    print('Shutting down ...')
    server.stop(timeout=60)
    exit(signal.SIGTERM)
gevent.signal(signal.SIGTERM, shutdown)
gevent.signal(signal.SIGINT, shutdown) #CTRL C
server.serve_forever() #spawn the server
</code></pre>
<p>You can purge the whitenoise and bottle configs if they aren't necessary, I kept them there as an example, and a suggestion that you use them if this is outward facing.  </p>
<p>This is purely asynchronous on every connection.  </p>
</div>
<span class="comment-copy">This may be helpful in your case: <a href="https://stackoverflow.com/questions/38079916/how-to-close-the-connection" title="how to close the connection">stackoverflow.com/questions/38079916/â€¦</a></span>
<span class="comment-copy">Thanks @Ajax1234 . The other question is related but doesn't get to the heart of the matter which is "what is the correct way for an app to notify a WSGI server that it needs to terminate a session after fulfilling the response?"  The connection-close header is specifically disallowed, so there much be some other way to communicate, "here's your answer, now we're done, goodbye".</span>
<span class="comment-copy">AFAIK, there's no way to do this. But couldn't you achieve your aim by using (for example) gevent to handle concurrent requests?</span>
