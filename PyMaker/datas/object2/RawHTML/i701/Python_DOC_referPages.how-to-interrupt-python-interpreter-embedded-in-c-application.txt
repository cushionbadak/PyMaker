<div class="post-text" itemprop="text">
<p>We have a C++ QT application, we embedded python in it. 
We provided two interfaces to the user
      1. Execute file
      2. Stop execution.
We execute a python file in a non GUI thread, using PyRun_FileExFlags.
We would like to interrupt python file execution (assume python file has an infinite loop, it never completes execution).
How to interrupt?</p>
<p>We tried following
1. In main thread set trace using PyEval_SetTrace
2. (if user click on Stop execution) In the trace call back function we set error "PyErr_SetString"</p>
<p>1:setting trace function</p>
<pre><code>PyGILState_STATE state;
state = PyGILState_Ensure();                
PyEval_SetTrace(TraceHook, NULL);
PyGILState_Release(state);
</code></pre>
<p>2:trace function </p>
<pre><code>int TraceHook(PyObject *obj, PyFrameObject *frame, int what, PyObject *arg)
{
if (b_isInterrupted)
{
PyGILState_STATE state;
state = PyGILState_Ensure();
PyErr_SetString(PyExc_KeyboardInterrupt, "Python Interrupted.");
PyGILState_Release(state);
}
return 0;
}
</code></pre>
<p>Python execution is not interrupted.
I expect python execution to interrupt.</p>
</div>
<div class="post-text" itemprop="text">
<p><code>PyEval_SetTrace</code> affects the <strong>current thread</strong> only.</p>
<p>You want <a href="https://docs.python.org/3/c-api/exceptions.html?highlight=pyerr_setinterrupt#c.PyErr_SetInterrupt" rel="nofollow noreferrer"><code>PyErr_SetInterrupt</code></a>.  It interrupts (what Python considers to be) the <strong>main thread</strong>, regardless of the calling thread (which need not bother with the GIL).</p>
</div>
<span class="comment-copy">Thanks Davis, how to interrupt the thread (which is not main thread) which is executing PyRun_FileExFlags</span>
<span class="comment-copy">@srinivasM: I don’t think Python knows more than what thread called <code>Py_Initialize</code>—can you arrange for it to be the same one?</span>
<span class="comment-copy">Thanks @Davis: it worked for main thread. Can you suggest if there is a way to stop other threads?</span>
<span class="comment-copy">@srinivasM: There is <a href="https://docs.python.org/3/c-api/init.html?highlight=pythreadstate_setasyncexc#c.PyThreadState_SetAsyncExc" rel="nofollow noreferrer">PyThreadState_SetAsyncExc</a>, but I don’t know how to get its <code>id</code> argument.</span>
