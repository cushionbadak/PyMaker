<div class="post-text" itemprop="text">
<p>Is it possible to call a function in a kind of protected environment with the following feature: <em>if calling function <code>f</code> raises an exception, then make sure all (outer) variables are restored to their previous values</em>.</p>
<p>For instance, the following code:</p>
<pre><code>a = 42
def f():
  global a
  a += 1
  error
f()
</code></pre>
<p>will obviously set a to 43 before raising the exception. I would like to build some <code>try/except</code> structure for calling <code>f()</code> where the exception would restore local variables to their previous state.</p>
<p>Of course I thought to something related to <code>sys._getframe(1).f_locals</code>. Is it possible? Would it be portable accross different versions of Python? etc.</p>
<p>No major goal right now; just curious about that idea.</p>
</div>
<div class="post-text" itemprop="text">
<p>Short answer is no, there's no snapshot feature to these executions and thus no way of reverting the variables.</p>
<p>However there are some things you can do. One of them being:<br/>
(And I'm writing this as I go so this <em>will</em> be resource exhausting way to solve your problem if you use it on large variables.)</p>
<pre><code>from pickle import load, dump

def snapshot(v):
    with open('snapshot.bin', 'wb') as fh:
        dump(v, fh)
def restore():
    with open('snapshot.bin', 'rb') as fh:
        v = load(fh)
    return v

a = 42
snapshot(a)

def f():
  global a
  a += 1
  error

try:
    f()
except:
    a = restore()
</code></pre>
<p>If this were a class with initated values, you could also snapshot the entire class or peak inside it and pull out certain variables. But there's no way to automatically do these things for you.</p>
<p>Of course this requires you to know a head of time what variables will be affected, I'm not sure there is a way to "peak inside" a function and see what variable names will be used, and even then you'd have to use a <code>traceback</code> call to see on which row your got the error and restored based on that.</p>
<p>One way I would solve it, is to store all my critical variables in a dictionary and snapshot branches of that dictionary or the entire dictionary itself.</p>
</div>
<span class="comment-copy">What should "all (outer) variables" include ???</span>
<span class="comment-copy">Probably the closest thing to this in Python is something like using the <a href="https://docs.python.org/3/whatsnew/2.5.html?highlight=contextmanager#pep-343-the-with-statement" rel="nofollow noreferrer"><code>with</code></a> statement and the general idea of creating <a href="https://docs.python.org/3/whatsnew/2.5.html?highlight=contextmanager#writing-context-managers" rel="nofollow noreferrer">Context Managers</a>.</span>
