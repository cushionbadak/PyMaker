<div class="post-text" itemprop="text">
<p>I have a simple test code that runs successfully on Linux, but it won't run on my windows 10 x64 computer. </p>
<p>When I tried to start a celery worker, it complained about the unrecoverable error: PicklingError. (Celery version: 3.1.20)</p>
<p>In my celery config, I've set the serialization to 'json', but it still didn't help at all. </p>
<pre><code>CELERY_RESULT_SERIALIZER = 'json'
CELERY_TASK_SERIALIZER = 'json'
CELERY_ACCEPT_CONTENT = ['json']
</code></pre>
<p>Here is the full error message:</p>
<pre><code>[2016-02-09 15:11:48,532: ERROR/MainProcess] Unrecoverable error: PicklingError("Can't pickle &lt;type 'module'&gt;: it's not found as __builtin__.module",)

Traceback (most recent call last):
  File "C:\Python27\lib\site-packages\celery-3.1.20-py2.7.egg\celery\worker\__init__.py", line 206, in start
    self.blueprint.start(self)   
  File "C:\Python27\lib\site-packages\celery-3.1.20-py2.7.egg\celery\bootsteps.py", line 123, in start
    step.start(parent)
  File "C:\Python27\lib\site-packages\celery-3.1.20-py2.7.egg\celery\bootsteps.py", line 374, in start
    return self.obj.start()
  File "C:\Python27\lib\site-packages\celery-3.1.20-py2.7.egg\celery\concurrency\base.py", line 131, in start
    self.on_start()
  File "C:\Python27\lib\site-packages\celery-3.1.20-py2.7.egg\celery\concurrency\prefork.py", line 117, in on_start
    **self.options)
  File "C:\Python27\lib\site-packages\billiard\pool.py", line 972, in __init__
    self._create_worker_process(i)
  File "C:\Python27\lib\site-packages\billiard\pool.py", line 1068, in _create_worker_process
    w.start()
  File "C:\Python27\lib\site-packages\billiard\process.py", line 137, in start
    self._popen = Popen(self)
  File "C:\Python27\lib\site-packages\billiard\forking.py", line 263, in __init__
    dump(process_obj, to_child, HIGHEST_PROTOCOL)
  File "C:\Python27\lib\site-packages\billiard\py2\reduction.py", line 84, in dump
    ForkingPickler(file, protocol).dump(obj)
  File "C:\Python27\lib\pickle.py", line 224, in dump
    self.save(obj)
  File "C:\Python27\lib\pickle.py", line 331, in save
    self.save_reduce(obj=obj, *rv)
  File "C:\Python27\lib\pickle.py", line 401, in save_reduce
    save(args)
  File "C:\Python27\lib\pickle.py", line 286, in save
    f(self, obj) # Call unbound method with explicit self
  File "C:\Python27\lib\pickle.py", line 562, in save_tuple
    save(element)
  File "C:\Python27\lib\pickle.py", line 286, in save
    f(self, obj) # Call unbound method with explicit self
  File "C:\Python27\lib\pickle.py", line 548, in save_tuple
    save(element)
  File "C:\Python27\lib\pickle.py", line 331, in save
    self.save_reduce(obj=obj, *rv)
  File "C:\Python27\lib\pickle.py", line 401, in save_reduce
    save(args)
  File "C:\Python27\lib\pickle.py", line 286, in save
    f(self, obj) # Call unbound method with explicit self
  File "C:\Python27\lib\pickle.py", line 548, in save_tuple
    save(element)
  File "C:\Python27\lib\pickle.py", line 286, in save
    f(self, obj) # Call unbound method with explicit self
  File "C:\Python27\lib\pickle.py", line 649, in save_dict
    self._batch_setitems(obj.iteritems())
  File "C:\Python27\lib\pickle.py", line 681, in _batch_setitems
    save(v)
  File "C:\Python27\lib\pickle.py", line 331, in save
    self.save_reduce(obj=obj, *rv)
  File "C:\Python27\lib\pickle.py", line 396, in save_reduce
    save(cls)
  File "C:\Python27\lib\pickle.py", line 286, in save
    f(self, obj) # Call unbound method with explicit self
  File "C:\Python27\lib\pickle.py", line 748, in save_global
    (obj, module, name))
PicklingError: Can't pickle &lt;type 'module'&gt;: it's not found as __builtin__.module
</code></pre>
</div>
<div class="post-text" itemprop="text">
<p>I ran into the same problem. What was weird is that the problem only existed on Windows, on Linux Celery was running without any problems.
Turns out I needed to pass the configuration module as name not as object:</p>
<p><code>app.config_from_object('celeryconfig')</code></p>
<p>instead of</p>
<p><code>app.config_from_object(celeryconfig)</code></p>
<p>Explanation from the <a href="http://docs.celeryproject.org/en/latest/userguide/application.html#example-1-using-the-name-of-a-module" rel="noreferrer">Celery docs</a>:</p>
<blockquote>
<h2>Tip</h2>
<p>Using the name of a module is recommended as this means that the module doesn’t need to be serialized when the prefork pool is used. If you’re experiencing configuration pickle errors then please try using the name of a module instead.</p>
</blockquote>
<p>Apparently Celery needs to pickle the configuration when it's passed as an object which fails on Windows. If passed as module name it works.
Thanks for pointing me in the right direction @JoyLy!</p>
</div>
<span class="comment-copy">Open up <code>C:\Python27\lib\site-packages\billiard\forking.py</code> and throw an <code>import pdb; pdb.set_trace()</code> before line 263. From the trace, it looks like that's where the decision is made to use pickle. Check out what's going on when you land in the debugger, should provide some clues.</span>
<span class="comment-copy">Thanks for the replay. I added the debugger before line 263. And this is what I got: -&gt; dump(process_obj, to_child, HIGHEST_PROTOCOL) [2016-02-09 16:20:09,266: INFO/MainProcess] (Pdb) n [2016-02-09 16:20:14,244: INFO/MainProcess] PicklingError: [2016-02-09 16:20:14,244: INFO/MainProcess] Pickling...module",)  You are right, this is where it decides to do pickle. Is there any solution to solve it? or maybe a workaround? Thanks for your help!</span>
<span class="comment-copy">Once you're in the debugger, you can use <a href="https://docs.python.org/3/library/pdb.html#debugger-commands" rel="nofollow noreferrer">docs.python.org/3/library/pdb.html#debugger-commands</a> to check what's going on. You can also evaluate Python, e.g. <code>print(HIGHEST_PROTOCOL)</code> to see what value it has.</span>
<span class="comment-copy">It turns out to be caused by how I loaded the configuration object. Not it's fixed. Thanks for help!!</span>
<span class="comment-copy">Could you please be more specific? I'm running into the same issue, would be helpful to know what you changed, I can't see anything being obviously wrong.</span>
