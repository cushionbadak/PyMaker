<div class="post-text" itemprop="text">
<p>I am trying to write an "order file" with a Header and Detail Lines.  I am successfully getting the order Header to write to file, but only one detail line seems to get written to the file. </p>
<pre><code>for k, v in atlantic_billing.iteritems():
    XHORNO = str(digits + counter)
    XHCSNO = k
    print XHCSNO
    machines = v
    line = 1
    counter = counter + 1
    header_written = False
    try :
        for machine in machines :
            XDORNO = XHORNO
            XDORSQ = line
            line = line + 1
            XDITD1 = ranpak_dict[machine]['MODEL']
            XDITD2 = ranpak_dict[machine]['SN']
            XDCAVC = ranpak_dict[machine]['TOTAL']
            print XDORSQ, XDITD1, XDITD2, XDCAVC
            if XDCAVC &gt; 0 :
                if header_written == False :
                    with open(XHORNO + ".txt", 'w') as order:
                        order.write("H01, " + XHORNO + ", " + XHCSNO + "\n")
                        order.write("D01," + str(XDORSQ) + ", " + ' EQPRANUSER, ' + XDITD1 + ", " +  XDITD2 + ", " + XDCAVC + "\n")
                else :
                    order.write("D01," + str(XDORSQ) + ", " + ' EQPRANUSER, ' + XDITD1 + ", " +  XDITD2 + ", " + XDCAVC + "\n")
                    success.append(machine)
                    header_written = True

    except KeyError, e:
        issues.append(machine)
</code></pre>
</div>
<div class="post-text" itemprop="text">
<p>When opening the file, you should use the mode <code>"A"</code> else the file will be overwritten at each loop (again and again):</p>
<pre><code> with open(XHORNO + ".txt", 'a') as order:
     ...
</code></pre>
<p>see <a href="https://docs.python.org/3/library/functions.html#open" rel="nofollow">https://docs.python.org/3/library/functions.html#open</a></p>
<p>An other option is to take the <code>with</code>block over the for block.</p>
</div>
<div class="post-text" itemprop="text">
<p>You need to open the file only once and not inside the loop</p>
<pre><code>for k, v in atlantic_billing.iteritems():
    XHORNO = str(digits + counter)
    with open(XHORNO + ".txt", 'w') as order: # &lt;--- here you go
        XHCSNO = k
        print XHCSNO
        machines = v
        line = 1
        counter = counter + 1
        header_written = False
        try :
            for machine in machines :
                XDORNO = XHORNO
                XDORSQ = line
                line = line + 1
                XDITD1 = ranpak_dict[machine]['MODEL']
                XDITD2 = ranpak_dict[machine]['SN']
                XDCAVC = ranpak_dict[machine]['TOTAL']
                print XDORSQ, XDITD1, XDITD2, XDCAVC
                if XDCAVC &gt; 0 :
                    if header_written == False :

                        order.write("H01, " + XHORNO + ", " + XHCSNO + "\n")
                        order.write("D01," + str(XDORSQ) + ", " + ' EQPRANUSER, ' + XDITD1 + ", " +  XDITD2 + ", " + XDCAVC + "\n")
                    else :
                        order.write("D01," + str(XDORSQ) + ", " + ' EQPRANUSER, ' + XDITD1 + ", " +  XDITD2 + ", " + XDCAVC + "\n")
                        success.append(machine)
                        header_written = True

        except KeyError, e:
            issues.append(machine)
</code></pre>
</div>
<div class="post-text" itemprop="text">
<p>Try this:</p>
<pre><code>for k, v in atlantic_billing.iteritems():
    XHORNO = str(digits + counter)
    XHCSNO = k
    print XHCSNO
    machines = v
    line = 1
    counter = counter + 1
    header_written = False
    try :
        for machine in machines :
            XDORNO = XHORNO
            XDORSQ = line
            line = line + 1
            XDITD1 = ranpak_dict[machine]['MODEL']
            XDITD2 = ranpak_dict[machine]['SN']
            XDCAVC = ranpak_dict[machine]['TOTAL']
            print XDORSQ, XDITD1, XDITD2, XDCAVC
            if XDCAVC &gt; 0 :
                with open(XHORNO + ".txt", 'a') as order:
                    if header_written == False :
                        order.write("H01, " + XHORNO + ", " + XHCSNO + "\n")
                        order.write("D01," + str(XDORSQ) + ", " + ' EQPRANUSER, ' + XDITD1 + ", " +  XDITD2 + ", " + XDCAVC + "\n")
                        header_written = True
                    else :
                        order.write("D01," + str(XDORSQ) + ", " + ' EQPRANUSER, ' + XDITD1 + ", " +  XDITD2 + ", " + XDCAVC + "\n")
                        success.append(machine)

    except KeyError, e:
        issues.append(machine)
</code></pre>
</div>
<span class="comment-copy">I think you want to do <code>with open(XHORNO +  ".txt", "w") as order:</code> before the start of the <code>for machine in machines:</code> loop. Also, I would put <code>header_written = True</code> in the <code>if header_written == False:</code> block.</span>
<span class="comment-copy">@DavidCullen If I move the <code>with open (XHORNO + "txt", "a")</code> to before the <code>for machine in machines:</code> loop, it writes the file before I can validate that any of lines are billable?</span>
<span class="comment-copy">It will create the file, but nothing will be written until you call <code>order.write</code>. This does not sound like the behavior your desire. However, putting <code>with open(XHORNO + ".txt", 'w') as order:</code> inside the <code>if</code> statement is almost certainly not the behavior your desire either, because <code>order</code> gets closed at the end of the <code>if</code> statement (before the <code>else</code> statement). Maybe you should collect the data for each machine in a list of lines and then write the list of lines after the <code>for machine in machines:</code> loop if the length of the list of lines is greater than zero.</span>
<span class="comment-copy">That got me all my detail lines, thanks so much!  Now it is repeatedly @Antoine writing the heading level.  I am not sure that moving the with block over the for block will work, bc I am trying to only write files that have valid non-0 lines.  Any ideas on that dilemma?</span>
<span class="comment-copy">Maybe use the len() function to check the length of the line before first  write. Then check the existence of the file before writing again with os.path.exists() (see <a href="https://docs.python.org/3/library/os.path.html#os.path.exists" rel="nofollow noreferrer">docs.python.org/3/library/os.path.html#os.path.exists</a>).</span>
<span class="comment-copy">I think you need to put the <code>with open(XHORNO + ".txt", 'w') as order:</code> before the <code>for machine in machines:</code> loop. XHORNO is a variable that changes inside the outer for loop.</span>
<span class="comment-copy">@DavidCullen - you are correct, fixed &amp; thanks!</span>
