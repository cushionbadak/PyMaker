<div class="post-text" itemprop="text">
<p>I am writing a <a href="https://docs.python.org/3/extending/extending.html" rel="nofollow">Python 3 C extension</a> where I want to use a MappingProxyType (<code>from types import MappingProxyType</code>). From what I saw in the Cpython source code, MappingProxyType is written in Python and not in C.</p>
<p>How can I use this type from C? I imagine there must be something like an C-level "import" and then I could find the PyObject (or rather, PyTypeObject) from the name as a C string.</p>
</div>
<div class="post-text" itemprop="text">
<p>There's a <a href="https://docs.python.org/3/c-api/import.html" rel="nofollow">C API</a> for for importing modules. Then you just need to get the <code>MappingProxyType</code> type attribute from the module:</p>
<pre><code>static PyTypeObject *import_MappingProxyType(void) {
    PyObject *m = PyImport_ImportModule("types");
    if (!m) return NULL;
    PyObject *t = PyObject_GetAttrString(m, "MappingProxyType");
    Py_DECREF(m);
    if (!t) return NULL;
    if (PyType_Check(t))
        return (PyTypeObject *) t;
    Py_DECREF(t);
    PyErr_SetString(PyExc_TypeError, "not the MappingProxyType type");
    return NULL;
}
</code></pre>
</div>
<span class="comment-copy">You forgot to check for errors on the getattr.  In practice it is unlikely to fail, but somebody could have monkey-patched out the module.</span>
<span class="comment-copy">@Kevin it's not necessary. If <code>t</code> is <code>NULL</code>, the function just returns <code>NULL</code>. <code>t</code> never gets used, so it's safe.</span>
<span class="comment-copy">And what if <code>t</code> is <code>None</code> or something that isn't a <code>PyTypeObject</code>?</span>
<span class="comment-copy">@Kevin good point. Haven't thought of this last night.</span>
