<div class="post-text" itemprop="text">
<p>I'd like to start and stop the celery worker processes from inside a Python script. I'm using Redis as the broker and backend.</p>
<p>I issue a Popen command to start the workers from inside the script that schedules tasks for workers:</p>
<pre><code>  # start the celery deamon
  cmd = 'celery worker '
  cmd += '--app intertext.tasks '
  cmd += '--loglevel critical'
  subprocess.Popen(shlex.split(cmd))
</code></pre>
<p>After all steps are complete, I want to delete all worker processes. I know I could do something like <code>ps -ef | grep celery | awk '{print $2}' | xargs kill -9</code> but that won't run on Windows.</p>
<p>What's the best way to kill the processes opened with Popen (or the best way to start and stop the celery deamon from within a Python script)?</p>
</div>
<div class="post-text" itemprop="text">
<p>I ended up using the following approach:</p>
<pre><code>from psutil import Process
from subprocess import Popen
import shlex

def start_celery():
  '''
  Start the celery deamon.
  @returns:
    subprocess.Popen object that supports pid lookup via
    self.pid
  '''
  cmd = 'celery worker '
  cmd += '--app intertext.tasks '
  cmd += '--loglevel error'
  return subprocess.Popen(shlex.split(cmd))


def terminate_process(pid):
  '''
  Stop a process given its pid or stop all processes if pid
  is a list of identifiers.
  @args:
    int pid: the process identifier of the root process that
      spawned child celery processes
  '''
  process = Process(pid)
  for child in process.children(recursive=True):
    child.kill()
  process.kill()

# main
celery_process = start_celery()

# ...do work... then
terminate_process(celery_process.pid)
</code></pre>
</div>
<span class="comment-copy">how about noting down the <code>pid</code>  of processes that are opened via <code>Popen</code>? <a href="https://docs.python.org/3/library/subprocess.html#subprocess.Popen.pid" rel="nofollow noreferrer">docs.python.org/3/library/subprocess.html#subprocess.Popen.pid</a></span>
<span class="comment-copy">@AliYılmaz how can I make this also work on Windows? I'm reading <a href="https://stackoverflow.com/questions/4789837/how-to-terminate-a-python-subprocess-launched-with-shell-true" title="how to terminate a python subprocess launched with shell true">stackoverflow.com/questions/4789837/…</a></span>
<span class="comment-copy">hmm I found this: <a href="https://stackoverflow.com/a/28609523/7757415">stackoverflow.com/a/28609523/7757415</a></span>
