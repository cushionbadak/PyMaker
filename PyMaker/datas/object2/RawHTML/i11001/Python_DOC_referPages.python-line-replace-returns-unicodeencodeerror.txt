<div class="post-text" itemprop="text">
<p>I have a tex file that was generated from rst source using Sphinx, it is encoded as UTF-8 without BOM (according to Notepad++) and named <code>final_report.tex</code>, with following content: </p>
<pre class="lang-latex prettyprint-override"><code>% Generated by Sphinx.
\documentclass[letterpaper,11pt,english]{sphinxmanual}
\usepackage[utf8]{inputenc}
\begin{document}

\chapter{Preface}
Krimson4 is a nice programming language.
Some umlauts äöüßÅö.
That is an “double quotation mark” problem.
Johnny’s apostrophe allows connecting multiple ports.
Components that include data that describe how they ellipsis …
Software interoperability – some dash – is not ok.
\end{document}
</code></pre>
<p>Now, before I compile the tex source to pdf, I want to replace some lines in the tex file to get nicer results. My script was inspired by <a href="https://stackoverflow.com/questions/4128144/replace-string-within-file-contents">another SO question</a>.</p>
<pre class="lang-python prettyprint-override"><code>#!/usr/bin/python
# -*- coding: utf-8 -*-
import os

newFil=os.path.join("build", "latex", "final_report.tex-new")
oldFil=os.path.join("build", "latex", "final_report.tex")

def freplace(old, new):
    with open(newFil, "wt", encoding="utf-8") as fout:
        with open(oldFil, "rt", encoding="utf-8") as fin:
            for line in fin:
                print(line)
                fout.write(line.replace(old, new))
    os.remove(oldFil)
    os.rename(newFil, oldFil)

freplace('\documentclass[letterpaper,11pt,english]{sphinxmanual}', '\documentclass[letterpaper, 11pt, english]{book}') 
</code></pre>
<p>This works on Ubuntu 16.04 with Python 2.7 as well as Python 3.5,
but it fails on Windows with Python 3.4. 
The error message I get is:</p>
<pre class="lang-none prettyprint-override"><code>File "C:\Python34\lib\encodings\cp850.py", line 19, in encode
    return codecs.charmap_encode(input,self.errors,encoding_map)[0]
UnicodeEncodeError: 'charmap' codec can't encode character '\u201c' in position 11: character maps to &lt;undefined&gt;
</code></pre>
<p>where <code>201c</code> stands for left double quotation mark. If I remove the problematic character, the script proceeds till it finds the next problematic character.</p>
<p>In the end, I need a solution that works on Linux and Windows with Python 2.7 and 3.x. I tried quite a lot of the solutions suggested here on SO, but could not yet find one that works for me...</p>
</div>
<div class="post-text" itemprop="text">
<p>You need to specify the correct encoding with the <code>encoding="the_encoding"</code>:</p>
<pre><code>with open(oldFil, "rt", encoding="utf-8") as fin,  open(newFil, "wt", encoding="utf-8") as fout:
</code></pre>
<p>If you don't the preferred encoding will be used.</p>
<p><a href="https://docs.python.org/3/library/functions.html#open" rel="nofollow">open</a></p>
<p><em>In text mode, if encoding is not specified the encoding used is platform dependent: locale.getpreferredencoding(False) is called to get the current locale encoding</em></p>
</div>
<span class="comment-copy">Hi @matth what do you have in line 19?</span>
<span class="comment-copy">My example does not have 19 lines, I assume the error message refers to line 19 of  the <code>cp850.py</code> file.</span>
<span class="comment-copy">related: <a href="http://stackoverflow.com/questions/10971033/backporting-python-3-openencoding-utf-8-to-python-2" title="backporting python 3 openencoding utf 8 to python 2">stackoverflow.com/questions/10971033/…</a></span>
<span class="comment-copy">@matth,  what double quote? If you still have encoding issues then you don't have utf-8 encoded data</span>
<span class="comment-copy">What is the exact new error?</span>
<span class="comment-copy">@matth, you have specified the encoding as utf-8 for both annd the error happens on write?</span>
<span class="comment-copy">For python 2 you would need to use the io lib, using io.open. when I get back on my comp this evening I will add a link to a nice answer that allows you to print from a cmd shell, although I would recommend using cygwin as your default shell on windows or use an side like pycharm.</span>
<span class="comment-copy">No need,  Python3's open is io.open so the code will work as is for both 2.7 and 3</span>
