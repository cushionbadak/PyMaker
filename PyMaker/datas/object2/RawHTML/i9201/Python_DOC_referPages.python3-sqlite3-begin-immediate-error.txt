<div class="post-text" itemprop="text">
<p>I have some code that used to work, but after upgrading to Python 3.6.0 on Windows I am getting errors. I can confirm that the same code works just fine in Python 3.5.2. I narrowed the issue down to the following very simple code in which I am trying to explicitly set a writer lock on the database:</p>
<pre><code>&gt;&gt;&gt; import sqlite3
&gt;&gt;&gt; conn = sqlite3.connect('testDB.db')
&gt;&gt;&gt; cur = conn.cursor()
&gt;&gt;&gt; conn.in_transaction
False
&gt;&gt;&gt; cur.execute('BEGIN IMMEDIATE')
Traceback (most recent call last):
  File "&lt;stdin&gt;", line 1, in &lt;module&gt;
sqlite3.OperationalError: cannot start a transaction within a transaction
</code></pre>
<p>The same code has no issues with Python 3.5.2:</p>
<pre><code>&gt;&gt;&gt; cur.execute('BEGIN IMMEDIATE')
&lt;sqlite3.Cursor object at 0xb710ab60&gt;
</code></pre>
<p>I tried to use <code>conn = sqlite3.connect('testDB.db', isolation_level='IMMEDIATE')</code> without success. Note that I am not doing any transaction such as INSERT or even SELECT.</p>
<p>UPDATE:
I noticed the following on the Python <a href="https://docs.python.org/3/library/sqlite3.html#controlling-transactions" rel="nofollow noreferrer">sqlite3 documentation</a>:</p>
<p>"Changed in version 3.6: sqlite3 used to implicitly commit an open transaction before DDL statements. This is no longer the case."</p>
<p>What does this mean and how to fix my code so that I can still explicitly lock the database?</p>
</div>
<div class="post-text" itemprop="text">
<p>If you want to use Python's automatic transaction handling, leave <a href="https://docs.python.org/3/library/sqlite3.html#controlling-transactions" rel="nofollow noreferrer"><code>isolation_level</code></a> at its default value, or set it to one of the three levels.</p>
<p>If you want to do your own transaction handling, you have to prevent Python from doing its own by setting <code>isolation_level</code> to <code>None</code>.</p>
</div>
<div class="post-text" itemprop="text">
<p>It's a bug. It will be fixed in Python 3.6.1: <a href="https://bugs.python.org/issue28518" rel="nofollow noreferrer">https://bugs.python.org/issue28518</a></p>
</div>
<span class="comment-copy">Is the Python version the same? Anyway, read the <a href="https://docs.python.org/3/library/sqlite3.html#controlling-transactions" rel="nofollow noreferrer">documentation</a>.</span>
<span class="comment-copy">Good catch, on Windows, the python version is 3.6.0 downgraded to 3.5.2 and the code works perfectly. I noticed this in the doc: "Changed in version 3.6: sqlite3 used to implicitly commit an open transaction before DDL statements. This is no longer the case." However, I don't fully understand what this means, nor how to fix it. if I run conn._intransaction it gives me false.</span>
<span class="comment-copy">This seems to work. I did not realize that <code>isolation_level = ''</code> is not the same as <code>isolation_level = None</code></span>
<span class="comment-copy">Thanks for pointing that out. I guess there's always a risk in using X.X.0 versions. Should have waited for the service pack :)</span>
