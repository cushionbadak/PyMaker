<div class="post-text" itemprop="text">
<p>I wrote a Flask application to browse a remote system with Paramiko's SFTP support.  I want the client to be able to download remote files when browsing.  How do I use Paramiko to download the file and server it with Flask?</p>
<pre><code>@app.route('/download/path:&lt;path:to_file&gt;/')
def download(to_file):
    ssh = paramiko.SSHClient()
    privatekeyfile = os.path.expanduser(key)
    mykey = paramiko.RSAKey.from_private_key_file(privatekeyfile)
    ssh.set_missing_host_key_policy(paramiko.AutoAddPolicy())
    ssh.connect(hostname=host, username=user, pkey=mykey)
    transfer = ssh.open_sftp()

    # what do I do here to get the file and serve it?
    download = transfer.~SOME_MAGIC~(to_file)
    return download
</code></pre>
</div>
<div class="post-text" itemprop="text">
<p>Use <a href="http://docs.paramiko.org/en/latest/api/sftp.html#paramiko.sftp_client.SFTPClient.getfo" rel="nofollow"><code>SFTPClient.getfo</code></a> to copy a file from the remote path, then send a response with the data.  Use a <a href="https://docs.python.org/3/library/tempfile.html#tempfile.SpooledTemporaryFile" rel="nofollow"><code>SpooledTemporaryFile</code></a> to store the data in memory or a temporary file if it gets too big.</p>
<pre><code>import os
from tempfile import SpooledTemporaryFile
from flask import Flask
from paramiko import SSHClient

app = Flask(__name__)

@app.route('/remote_download/&lt;path:path&gt;')
def remote_download(path):
    client = SSHClient()
    client.connect('host')
    transfer = client.open_sftp()

    with SpooledTemporaryFile(1024000) as f:  # example max size before moving to file = 1MB
        transfer.getfo(path, f)
        f.seek(0)
        r = app.response_class(f.read(), mimetype='application/octet-stream')

    r.headers.set('Content-Disposition', 'attachment', filename=os.path.basename(path))
    return r

app.run()
</code></pre>
<p>You should do something to check if the path is valid, as otherwise there is a security issue if the path is something like <code>../sibling/path/secret.txt</code>.</p>
</div>
<span class="comment-copy">What kind of file are you trying to make the users download?</span>
<span class="comment-copy">Arbitrary. Anything that is not a folder</span>
<span class="comment-copy">Although I believe we can assume that they will be text, not binary... But I would go for universal solution if there is any. But in case you have something for text, please do share</span>
