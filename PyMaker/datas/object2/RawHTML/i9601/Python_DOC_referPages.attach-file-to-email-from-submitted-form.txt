<div class="post-text" itemprop="text">
<p>I have a function which saves an attachment when a user submits my form and uploads a file, this function also sends an email. I want this function to use the submitted file as an attachment for the email. I have tried to do this like so:</p>
<pre><code>def send_email(subject, sender, recipients, text_body):
    FILE_TYPES = set(['txt', 'doc', 'docx', 'odt', 'pdf', 'rtf', 'text', 'wks', 'wps', 'wpd'])
    form = ApplicationForm (request.files)
    submit_name = form.file_upload.data.filename
    mail = Mail(app)
    msg = Message(subject, sender=sender, recipients=recipients)
    msg.body = text_body
    if '.' in submit_name and submit_name.rsplit('.', 1)[1] in FILE_TYPES:
        filename = secure_filename(submit_name)
        form.file_upload.data.save('uploads/' + filename)
        with app.open_resource('uploads/' + filename) as fp:
            msg.attach(filename, fp.read()) #attaches the submitted file to the email
        print 'file sent successfully'
     mail.send(msg)
</code></pre>
<p>Edit: Now receiving the following error:</p>
<pre><code>TypeError: __init__() takes exactly 3 arguments (75 given)
</code></pre>
<p>Traceback:</p>
<pre><code>Traceback (most recent call last):
  File "C:\PYTHON27\lib\site-packages\flask\app.py", line 2000, in __call__
    return self.wsgi_app(environ, start_response)
  File "C:\PYTHON27\lib\site-packages\flask\app.py", line 1991, in wsgi_app
    response = self.make_response(self.handle_exception(e))
  File "C:\PYTHON27\lib\site-packages\flask\app.py", line 1567, in handle_exception
    reraise(exc_type, exc_value, tb)
  File "C:\PYTHON27\lib\site-packages\flask\app.py", line 1988, in wsgi_app
    response = self.full_dispatch_request()
  File "C:\PYTHON27\lib\site-packages\flask\app.py", line 1641, in full_dispatch_request
    rv = self.handle_user_exception(e)
  File "C:\PYTHON27\lib\site-packages\flask\app.py", line 1544, in handle_user_exception
    reraise(exc_type, exc_value, tb)
  File "C:\PYTHON27\lib\site-packages\flask\app.py", line 1639, in full_dispatch_request
    rv = self.dispatch_request()
  File "C:\PYTHON27\lib\site-packages\flask\app.py", line 1625, in dispatch_request
    return self.view_functions[rule.endpoint](**req.view_args)
  File "C:\Users\richard.danvers\application\app\views.py", line 87, in index
    department_data=form.department.data
  File "C:\Users\richard.danvers\application\app\views.py", line 30, in send_email
    mail.send(msg) # if no file is uploaded email is sent without any attachment
  File "C:\PYTHON27\lib\site-packages\flask_mail.py", line 492, in send
    message.send(connection)
  File "C:\PYTHON27\lib\site-packages\flask_mail.py", line 427, in send
    connection.send(self)
  File "C:\PYTHON27\lib\site-packages\flask_mail.py", line 190, in send
    message.as_bytes() if PY3 else message.as_string(),
  File "C:\PYTHON27\lib\site-packages\flask_mail.py", line 381, in as_string
    return self._message().as_string()
  File "C:\PYTHON27\lib\site-packages\flask_mail.py", line 349, in _message
    f = MIMEBase(*attachment.content_type.split('/'))
TypeError: __init__() takes exactly 3 arguments (75 given)
</code></pre>
</div>
<div class="post-text" itemprop="text">
<p>I see two problems </p>
<ul>
<li><p>you save in <code>"upload/"+filename</code> but you read from <code>filename</code> - you have to read from <code>"upload/"+filename</code></p></li>
<li><p>when you attache file then you don't do <code>mail.send(msg)</code> so you don't send mail. You need code without `else:</p>
<pre><code>if '.' in submit_name and submit_name.rsplit('.', 1)[1] in FILE_TYPES:
    filename = secure_filename(submit_name)
    form.file_upload.data.save('uploads/' + filename)
    with app.open_resource('uploads/' + filename) as fp:
        msg.attach(filename, fp.read())
        print 'file sent successfully'

# send mail with or without attachment

mail.send(msg)
</code></pre></li>
</ul>
</div>
<span class="comment-copy">in question always show full error message (Traceback). There can be more usefull information.</span>
<span class="comment-copy">Traceback has now been included.</span>
<span class="comment-copy">do you have file <code>'C:\\Users\\richard.danvers\\application\\answer.docx'</code> ? I see you save file in <code>'uploads/' + filename</code> but you read from <code>filename</code>, not <code>'uploads/' + filename</code>.</span>
<span class="comment-copy">Tried this before, when this is done no email is sent for some reason but console prints 'file sent successfully'.</span>
<span class="comment-copy">but you didn't have problem with <code>"No such file or directory"</code> so you had correct path to file - and problem could be with other part of code, not with file. After <code>'file sent successfully'</code> you doesn't do <code>mail.send(msg)</code></span>
<span class="comment-copy">I've now added mail.send(msg) and included the 'uploads/' + filename in the read. Now receiving this error: __init__() takes exactly 3 arguments (75 given)</span>
<span class="comment-copy">you have new problem so you should create new question on SO. but first check documentation how to attache file <a href="https://docs.python.org/3/library/email-examples.html" rel="nofollow noreferrer">docs.python.org/3/library/email-examples.html</a></span>
<span class="comment-copy">I see, I can't currently ask any more questions as I have been banned from doing so! I will look through documentation and search for a fix. Thanks for your help.</span>
