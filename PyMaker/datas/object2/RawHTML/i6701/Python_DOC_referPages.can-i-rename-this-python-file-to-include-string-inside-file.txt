<div class="post-text" itemprop="text">
<p>Might be a bit confusing, but bear with me on this one...</p>
<p>I have a python script which pulls AWS SQS messages, decrypts/decompresses them, and places them in a directory as a JSON file for the user to access. The user is now requesting the name of the file to change...right now the file name is the message ID in AWS, and they would like it to be Transaction Number, which is only found inside the file after it is decompressed and decrypted. Here is my script that is running right now</p>
<pre><code>import argparse
import boto.sqs
import json
import os
import base64
import zlib

parser = argparse.ArgumentParser(description='Saves all messages from an AWS SQS queue into a folder.')

parser.add_argument(
     '-q', '--queue', dest='queue', type=str, required=True,
     help='The name of the AWS SQS queue to save.')

parser.add_argument(
     '-a', '--account', dest='account', type=str,
     help='The AWS account ID whose queue is being saved.')

parser.add_argument(
     '-o', '--output', dest='output', type=str, default='queue-messages',
     help='The output folder for saved messages.')

parser.add_argument(
     '-r', '--region', dest='aws_region', type=str, required=True,
     help='The AWS region where the queue is located.')

parser.add_argument(
     '-k', '--key', dest='aws_key', type=str, required=True,
     help='Your AWS account key.')

parser.add_argument(
     '-s', '--secret', dest='aws_secret', type=str, required=True,
     help='Your AWS account secret.')

parser.add_argument(
     '-d', '--delete', dest='delete', default=False, action='store_true',
     help='Whether or not to delete saved messages from the queue.')

parser.add_argument(
     '-v', '--visibility', dest='visibility', type=int, default=60,
     help='The message visibility timeout for saved messages.')

args = parser.parse_args()

print (args.aws_region)
print (args.aws_key)
print (args.aws_secret)

if not os.path.exists(args.output):
     os.makedirs(args.output)

conn = boto.sqs.connect_to_region(
     args.aws_region,
     aws_access_key_id=args.aws_key,
     aws_secret_access_key=args.aws_secret)

print('Connection: ', conn)
queue = conn.get_queue(args.queue)

count = 0

while True:
     messages = queue.get_messages(
             num_messages=10,
             message_attributes=['All'],
             visibility_timeout=args.visibility)
     if len(messages) == 0: break

     for msg in messages:
         filename = os.path.join(args.output, msg.id)

         decoded_data = base64.b64decode(msg.get_body())
         decompressed_data = zlib.decompress(decoded_data, 16+zlib.MAX_WBITS)
         obj = { 'id': msg.id,
                 'attributes': msg.message_attributes,
                 'body': decompressed_data.decode('utf-8') }
         print('decompressed_data: ', decompressed_data.decode('utf-8'))
         with open(filename, 'w') as f:
             f.write(str(decompressed_data) + '\n')
             count += 1
 ##            print 'Saved message to {}'.format(filename)
             if args.delete:
                 queue.delete_message(msg)

##print '{} messages saved'.format(count)
</code></pre>
<p>I don't think there is a way for me to add this to this script, but is there another way I can name the file "TransactionNumber".json when the script is complete? </p>
<p>Here is the part of the output json I need to pull and put as the file name...just the number as the file name. </p>
<pre><code>"createdAt":"2017-09-20T13:57:36.476Z","transactionNo":"10591581413677"}],"isReturnForService":0,
</code></pre>
<p>I was working on a script to pull this number</p>
<pre><code>with open('*directory*','r') as f:
for line in f:
    if line.startswith('transactionNo'):
        flag=True
    if flag:
        data.append(line)
    if line.strip().endswith('}]'):
        flag=False
</code></pre>
<p>Then will use this outcome as a variable, then run a rename script using this variable, but can't seem to get it to work. Any other direction I should take on this?</p>
</div>
<div class="post-text" itemprop="text">
<p>This doesn't make sense:</p>
<pre><code>if line.startswith('transactionNo'):
</code></pre>
<p>Use <code>if 'transactionNo' in line:</code>, or <a href="https://docs.python.org/3/library/json.html#json.load" rel="nofollow noreferrer"><code>json.load()</code></a>, or:</p>
<pre><code>xact_re = re.compile(r'"transactionNo":"(\d+)"')
for line in f:
    m = xact_re.search(line)
    if m:
        print('transactionNo is %d' % int(m.group(1)))
</code></pre>
</div>
