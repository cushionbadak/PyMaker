<div class="post-text" itemprop="text">
<p><strong>Directory structure</strong></p>
<pre><code>/service-session
    - app.yaml
/service-dashboard
    - app.yaml
    /handlers
        - login.py
    /tests
        - login_test.py
</code></pre>
<p>service-dashboard uses webapp2 to respond to the user. service-session manages the session. </p>
<p>What the unittest has to do:</p>
<ol>
<li>Insert valid session into datastore</li>
<li>Set session cookie</li>
<li>Request login page to perform an auto-login based on session cookie</li>
</ol>
<p><strong>Unit Test</strong></p>
<pre><code>class TestHandlers(unittest.TestCase):
    def setUp(self):
        self.testbed = testbed.Testbed()
        self.testbed.activate()
        self.testbed.init_datastore_v3_stub()
        self.testbed.init_memcache_stub()
        self.testbed.init_modules_stub()
        self.testbed.init_urlfetch_stub()

        self.app = main.app

        self.customer = service_customer.Customer(password='test', salt='', email='test@test.com')
        self.customer.put()

        self.session = service_session.Session(customer=self.customer.key, session_id="test_session")
        self.session.put()


    def test_list(self):
        request = webapp2.Request.blank('/login', headers={'Cookie': 'session_id=%s' % 'test_session'})
        response = request.get_response(self.app)
        self.assertEqual(response.status_int, 200)
</code></pre>
<p><strong>The issue</strong></p>
<p>Dashboard makes a request to service-session, this fails because the session cannot be located. This is because the session has not been dispatched.</p>
<p>In search for answers I came across <a href="https://stackoverflow.com/questions/28166558/invalidmoduleerror-when-using-testbed-to-unit-test-google-app-engine">this</a> post where they use a <code>_LocalFakeDispatcher</code> to bind the services to a certain location. However, this requires to dispatch the services with the devserver because it does not actually dispatch the services. Doing so causes the services to not use the datastore_v3_stub which is initialized in the unit test preventing me to insert a valid session into the datastore.</p>
<p>How does one work around this issue? Is it possible to dispatch the services with the datastore stub? What tactics do you use when testing a microservice architecture on app engine?</p>
<p><strong>NoseGAE + WebTest</strong></p>
<pre><code>nosetests --logging-level=ERROR --gae-lib-root "C:\google_appengine" --with-gae --gae-application="C:\service-session\app.yaml,C:\service-dashboard\app.yaml"
</code></pre>
<p>Unittest remains about the same except the webtest.TestApp is used to perform requests to dashboard service.</p>
<p>When the dashboard service attempts to locate the session service the application terminates with an InvalidModuleError. Trace:</p>
<pre><code>Traceback (most recent call last):
  File "C:\google_appengine\lib\webapp2-2.5.2\webapp2.py", line 1535, in __call__
    rv = self.handle_exception(request, response, e)
  File "C:\google_appengine\lib\webapp2-2.5.2\webapp2.py", line 1529, in __call__
    rv = self.router.dispatch(request, response)
  File "C:\google_appengine\lib\webapp2-2.5.2\webapp2.py", line 1278, in default_dispatcher
    return route.handler_adapter(request, response)
  File "C:\google_appengine\lib\webapp2-2.5.2\webapp2.py", line 1102, in __call__
    return handler.dispatch()
  File "C:\service-dashboard\core.py", line 40, in dispatch
    url = 'http://' + modules.get_hostname('service-session') + '/session.get'
  File "C:\google_appengine\google\appengine\api\modules\modules.py", line 458, in get_hostname
    _ResultHook).get_result()
  File "C:\google_appengine\google\appengine\api\apiproxy_stub_map.py", line 613, in get_result
    return self.__get_result_hook(self)
  File "C:\google_appengine\google\appengine\api\modules\modules.py", line 441, in _ResultHook
    _CheckAsyncResult(rpc, mapped_errors, [])
  File "C:\google_appengine\google\appengine\api\modules\modules.py", line 146, in _CheckAsyncResult
    raise mapped_error()
InvalidModuleError
</code></pre>
</div>
<div class="post-text" itemprop="text">
<p>I'm working also with an app deployed in App Engine that is microservices based and as I try to build this mServices to can run in any place (in spite of this is running of App Engine) my strategie is use  as few as possible Google tools. I preffer do unit tests based in raw request (also between mServices) to check everything, but of course it depends of each domain and each specific architecture implemented, but <em>this is only my opinion</em>.</p>
<p>If you want talk with people with experience you can join to <a href="https://googlecloud-community.slack.com/" rel="nofollow noreferrer">Slack group</a> and vistit also community forum for users of Google App Engine in <a href="https://groups.google.com/forum/#!forum/google-appengine" rel="nofollow noreferrer">Google Groups</a>.</p>
<p>Anyway please tell us how have you solved your problem when you do this because there isn't  too much info about in the net. </p>
</div>
<div class="post-text" itemprop="text">
<p>I believe you can do what you need with these three tools:</p>
<ul>
<li><a href="https://github.com/Trii/NoseGAE" rel="nofollow noreferrer">NoseGAE</a> -- "NoseGAE sets up the GAE development environment before your test run. This means that you can easily write functional tests for your application without having to actually start the dev server and test over http. "</li>
<li><a href="http://docs.pylonsproject.org/projects/webtest/en/latest/" rel="nofollow noreferrer">WebTest</a> -- "With this you can test your web applications without starting an HTTP server, and without poking into the web framework shortcutting pieces of your application that need to be tested. The tests WebTest runs are entirely equivalent to how a WSGI HTTP server would call an application. "</li>
<li><a href="https://docs.python.org/3/library/unittest.mock.html" rel="nofollow noreferrer">mock</a> -- "It allows you to replace parts of your system under test with mock objects and make assertions about how they have been used."</li>
</ul>
<p>I'm not sure if you need mock.  I believe using NoseGAE and WebTest will allow your services to interact with each other in the testing environment.</p>
<p>Even if you don't need mock, however, it is often useful to isolate your testing more effectively.  I use mock for mocking third-party services when testing my code, but you may also be able to use it to mock your session service when testing your dashboard service and vice versa.</p>
</div>
<span class="comment-copy">You use your own service locator instead of modules.get_hostname ?</span>
<span class="comment-copy">No, is too easy to search anocher option (but it will be a problem if i decide change to deploy some service in another place in the future, I Know)</span>
<span class="comment-copy">Giving NoseGAE + WebTest a chance. It does execute the test but I get a InvalidModuleError when the application tries to locate the session service using modules.gethostname. I did supply both the session and dashboard app.yaml to nosetests using --gae-application.</span>
<span class="comment-copy">I added this information to the question to give you a better idea of what i'm talking about.</span>
