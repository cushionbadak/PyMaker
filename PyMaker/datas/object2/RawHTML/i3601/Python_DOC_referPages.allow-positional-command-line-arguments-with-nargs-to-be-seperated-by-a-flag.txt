<div class="post-text" itemprop="text">
<p>I have a program using argparse. It takes 1 required positional argument, 1 optional positional argument, and 1 flag argument. </p>
<p>Something like:</p>
<pre><code>usage: test.py [-h] [-a A] b [c]
</code></pre>
<p>So, I tried using this:</p>
<pre><code>parser = argparse.ArgumentParser()

parser.add_argument('-a')
parser.add_argument('b')
parser.add_argument('c', nargs='?', default=None)
print(parser.parse_args())
</code></pre>
<p>Which works fine for <code>test.py B C -a A</code> and <code>test.py -a A B C</code>.</p>
<p>But when I do <code>test.py B -a A C</code>, it throws an error:</p>
<pre class="lang-bash prettyprint-override"><code>$ python3 test.py B -a A C
usage: test.py [-h] [-a A] b [c]
test.py: error: unrecognized arguments: C
</code></pre>
<p>So, how can I get it to accept the optional positional argument to be accepted even if there is a flag in between?</p>
<p>Note that this works if I remove the <code>nargs='?', default=None</code>, but then it's not optional. The problem also happens with <code>nargs='*'</code>, but this doesn't happen for <code>nargs=N</code> (e.g. <code>nargs=1</code>, <code>nargs=2</code>) and doesn't happen for <code>nargs='+'</code>. <code>nargs=argparse.REMAINDER</code> makes it parse the flags as part of <code>c</code> (<code>c = ['-a', 'A', 'C']</code>, <code>a = None</code>)</p>
</div>
<div class="post-text" itemprop="text">
<p>This is a known issue, both here on SO and Python bug/issues, and doesn't have an easy fix.   <a href="https://bugs.python.org/issue15112" rel="nofollow noreferrer">https://bugs.python.org/issue15112</a></p>
<p>It's the result of the basic parsing algorithm.  This trys to parse positionals up to the next optional's flag.  Then parse the flagged option (and however many arguments it needs).  Then parse the next batch of positions, etc.</p>
<p>When the parser handles <code>b</code>, it can also handle <code>c</code>, even if there is just one string.  <code>c</code> requires nothing.  That means <code>c</code> gets 'used up' the first time it processes positionals.</p>
<pre><code>In [50]: parser.parse_args(['one'])
Out[50]: Namespace(a=None, b='one', c=None)
In [51]: parser.parse_args(['one','two'])
Out[51]: Namespace(a=None, b='one', c='two')
In [52]: parser.parse_args(['one','-a','1','two'])
usage: ipython3 [-h] [-a A] b [c]
ipython3: error: unrecognized arguments: two
An exception has occurred, use %tb to see the full traceback.

SystemExit: 2

/home/paul/.local/lib/python3.6/site-packages/IPython/core/interactiveshell.py:2971: UserWarning: To exit: use 'exit', 'quit', or Ctrl-D.
  warn("To exit: use 'exit', 'quit', or Ctrl-D.", stacklevel=1)
In [53]: parser.parse_known_args(['one','-a','1','two'])
Out[53]: (Namespace(a='1', b='one', c=None), ['two'])
</code></pre>
<p>With <code>c</code> used up (even though it just gets the default), there's nothing to consume the last string.  It is an 'extra'.</p>
<h2>parse_intermixed_args</h2>
<p>Python 3.7 has added a parsing method that solves this issue, <code>parse_intermixed_args</code>.  <a href="https://docs.python.org/3/library/argparse.html#intermixed-parsing" rel="nofollow noreferrer">https://docs.python.org/3/library/argparse.html#intermixed-parsing</a></p>
<pre><code>In [447]: import argparse37
In [448]: p = argparse37.ArgumentParser()
In [449]: p.add_argument('pos1');
In [450]: p.add_argument('-a');
In [451]: p.add_argument('pos2', nargs='?');

In [453]: p.parse_args('1 2 -a foo'.split())
Out[453]: Namespace(a='foo', pos1='1', pos2='2')

In [454]: p.parse_args('1 -a foo 2'.split())
usage: ipython3 [-h] [-a A] pos1 [pos2]
ipython3: error: unrecognized arguments: 2
...

In [455]: p.parse_intermixed_args('1 -a foo 2'.split())
Out[455]: Namespace(a='foo', pos1='1', pos2='2')

In [456]: p.parse_intermixed_args('1 2 -a foo'.split())
Out[456]: Namespace(a='foo', pos1='1', pos2='2')
</code></pre>
<p>It was added as a way of allowing a flagged Action in the middle of a '*' positional. But ends up working in this case with '?' Actions.  Note the caution in the docs; it may not handle all <code>argparse</code> features.</p>
<p>In effect it deactivates the <code>positionals</code>, does a <code>parse_known_args</code> to get all <code>optionals</code>, and then parses the <code>extras</code> with just the <code>positonals</code>.  See the code of <code>parse_known_intermixed_args</code> for details.</p>
</div>
