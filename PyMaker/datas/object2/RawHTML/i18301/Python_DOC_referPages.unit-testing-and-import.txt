<div class="post-text" itemprop="text">
<p>My program reads a python script for configuration. So far I'm loading the script called <code>lab.py</code> like this:</p>
<pre><code>self.lab_file = "/not/interesting/path/lab.py"
sys.path.insert(0, os.path.dirname(self.lab_file))
import lab as _config
</code></pre>
<p>But when I'm unit-testing it, I've a strange behavior:</p>
<ul>
<li>when I launch only one unit test calling this code, it succeed</li>
<li>when I launch several unit tests, each of one calling this code independantly, some tests failed</li>
</ul>
<p>Tracing the problem with <code>logging</code>, It seems the lab script is imported only the first time. This behavior seems coherent in respect of python but I was assuming than unit tests are isolated between each other. I am wrong ? If test are not independant in respect of the import, how can I write test to force the loading of my script each time ? </p>
</div>
<div class="post-text" itemprop="text">
<p>I would suggest deleting the module from sys.modules</p>
<pre><code> import sys
 if 'lab' in sys.modules:
     del sys.modules['lab']
 import lab as _config
</code></pre>
<p>just deleting the import will not work because import checks in sys.modules if the module is already imported.</p>
<p>if you import then reload it works because it first loads the module from sys.modules into the local namespace and then reloads the module from file.</p>
</div>
<div class="post-text" itemprop="text">
<p>Try using <code>reload</code>.</p>
<p>For example:</p>
<pre><code>    import lab as _config
    reload(_config)
</code></pre>
<ul>
<li><p>In <strong>python 2</strong> <code>reload</code> is <a href="http://docs.python.org/2/library/functions.html?highlight=reload#reload" rel="nofollow">a builtin function</a>.</p></li>
<li><p>In <strong>python 3.2+</strong> <code>reload</code> is <a href="https://docs.python.org/3/library/imp.html#imp.reload" rel="nofollow">in the <code>imp</code> module</a>, <em>but deprecated in 3.4+</em>.</p></li>
<li><p>In <strong>python 3.4+</strong> <code>reload</code> is <a href="https://docs.python.org/3/library/importlib.html#importlib.reload" rel="nofollow">in the <code>importlib</code> module</a>.</p></li>
</ul>
</div>
<div class="post-text" itemprop="text">
<p>Maybe it helps if you run <code>nose</code> with this flag:</p>
<p><code>--with-isolation</code></p>
<p>From the <a href="http://nose.readthedocs.org/en/latest/usage.html" rel="nofollow">nosedoc</a></p>
<blockquote>
<p>Enable plugin IsolationPlugin: Activate the isolation plugin to isolate changes to external modules to a single test module or package. The isolation plugin resets the contents of sys.modules after each test module or package runs to its state before the test. PLEASE NOTE that this plugin should not be used with the coverage plugin, or in any other case where module reloading may produce undesirable side-effects. [NOSE_WITH_ISOLATION]</p>
</blockquote>
</div>
<span class="comment-copy">How are you running your unit tests?</span>
<span class="comment-copy">launching nose poiting to the test directory</span>
<span class="comment-copy">OK that make sense now. Thanks.</span>
<span class="comment-copy">The reload advice is good but are you sure for the reload usage ? Your code does not work but doing an import then just after a reload works.</span>
<span class="comment-copy">I think getting rid of the try/catch makes this work.  I tested using the interactive interpreter and changing the module file.</span>
<span class="comment-copy">See the answer of @nachshon who explains such behavior. Thanks for your help.</span>
<span class="comment-copy">Yes I saw this plugin but I wanted to understand the bevahior and I need code coverage feature. Thanks anyway...</span>
