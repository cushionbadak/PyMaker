<div class="post-text" itemprop="text">
<p>I have a dataframe like this.</p>
<pre><code>   Date       price       top          
 ..............
1999-07-21  8.6912      9.674425    
1999-07-22  8.6978      8.692583    
1999-07-23  8.8127      10.760976   
1999-07-24  8.8779      8.871057    
 ..............
1999-07-27  8.8888      10.12344
...............
</code></pre>
<p>I want to create a new col called 'return'. If in a row ,'price' &gt;'top' then I want to fill 'return' of this row with the return of price in this row and price in the n+5 row.</p>
<p>For example, In row 1999-07-22,the price is greater than top, so I wanto fill 'return' in this row with return 07-22 and 07-27, that is,(8.8888-8.6978)/8.6978 (notice the date may not be consecutive since holidays are excluded ). Only a small part of the rows meet the demand. So most of values in 'return' will be missing values.</p>
<p>Could you please tell me how I can do this in python?</p>
</div>
<div class="post-text" itemprop="text">
<p>First create <code>DatetimeIndex</code> if necessary and then use <a href="http://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.Series.pct_change.html" rel="nofollow noreferrer"><code>Series.pct_change</code></a>, <a href="http://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.Series.shift.html" rel="nofollow noreferrer"><code>Series.shift</code></a> and last <a href="http://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.Series.where.html" rel="nofollow noreferrer"><code>Series.where</code></a>:</p>
<pre><code>df['Date'] = pd.to_datetime(df['Date'])
df = df.set_index('Date')

df['new'] = (df['price'].pct_change(5)
                        .shift(-5)
                        .where(df['price'] &gt; df['top']))
print (df)
</code></pre>
</div>
<span class="comment-copy">Did you look at the documentation for <code>where</code>? That would tell you straight away that it cannot be called in this manner - the assignment of values coming <i>before</i> the condition is checked</span>
<span class="comment-copy">Not sure if this is correct, but what I understood he want to return the value in the row with date <code>1999-07-22</code></span>
<span class="comment-copy">@Erfan - Thank you.</span>
<span class="comment-copy">Hi. The frequency 5 is the relative position but not 5 days. For example, if the date in the rows are 01-01,01-03,01-04,01-05,01-07,01-08, the pct_change should calculate the price between 01-01 and 01-08 rather than 01-06(which will return missing value). Could you please me help me abt this?</span>
<span class="comment-copy">@JAKE - Do you think <code>df['price'].shift(-5).pct_change().where(df['price'] &gt; df['top'])</code> ?</span>
<span class="comment-copy">@jezrael haha I found that pct_change(5)                         .shift(-5)) is right</span>
