<div class="post-text" itemprop="text">
<p>I've been struggling with this logic for a few days. Lets say I have a dataframe that looks like this. I just made some dummy data so it might not make that much sense:</p>
<pre><code>+----+---------------+------------+
|Id  |prescr_testdrug|diagnosis   |
+---------+----------+------------+
|0   |Yes            |[a,b,c]     |
|1   |Yes            |[b,c]       |
|2   |No             |[b,c,d]     |
|3   |Yes            |[a]         |
|4   |No             |[c,d]       |
|5   |No             |[d,e]       |
|6   |No             |[a,f]       |
|7   |Yes            |[c]         |
|8   |Yes            |[a,d,e]     |
|9   |Yes            |[a]         |
+----+---------------+------------+
</code></pre>
<p>I want to get counts based on 4 different scenarios for each of the distinct diagnosis:</p>
<p>Case1 = counts where patients were prescribed and diagnosed</p>
<p>Case2 = counts where patients were prescribed and not diagnosed</p>
<p>Case3 = counts where patients were not prescribed and diagnosed</p>
<p>Case4 = counts where patients were not prescribed and not diagnosed</p>
<p>I know that if I do <code>groupBy('diagnosis','prescr_testdrug').count()</code> after I do an <code>explode()</code> on diagnosis, I can basically get the counts for Case1 and Case 3 (the freq of Yes and No for each diagnosis). However I can't wrap my head around how to go about getting the values for the other two cases.</p>
<p>This is basically what I want my final dataframe to look like:</p>
<pre><code>+---------+------+------+------+------+
|diagnosis|Case1 |Case2 |Case3 |Case4 |
+---------+------+------+------+------+
|a        |     4|     2|     1|     3|
|b        |     2|     4|     1|     3|
|c        |     3|     3|     2|     2|
|d        |     1|     5|     2|     2|
|e        |     1|     5|     1|     3|
|f        |     0|     6|     1|     3|
+---------+------+------+------+------+
</code></pre>
<p>For example, for the first row, 4 patients were prescribed the drug AND had diagnosis 'a'; 2 patients were also prescribed the drug AND did not have diagnosis 'a'; 1 patient was not prescribed the drug AND had diagnosis 'a'; 3 patients were not prescribed with the drug AND did not have diagnoses 'a'</p>
<p>It feels so simple but I've just been banging my head over this for a while.</p>
<p>What is the best way to go about doing this?</p>
</div>
<div class="post-text" itemprop="text">
<p>Fisrt, you may try to write a UDF to generate not diagnosis set</p>
<p><strong>ICD10 codes total - diagnosis = not diagnosis</strong></p>
<pre><code>+----+---------------+------------+-------------+
|Id  |prescr_testdrug|diagnosis   |not diagnosis|
+---------+----------+------------+-------------+
|0   |Yes            |[a,b,c]     |[d,e]        |
|1   |Yes            |[b,c]       |[a,d,e]      |
|2   |No             |[b,c,d]     |.            |
|3   |Yes            |[a]         |.            |
|4   |No             |[c,d]       |.            |
|5   |No             |[d,e]       |.            |
|6   |No             |[a,f]       |.            |
|7   |Yes            |[c]         |.            | 
|8   |Yes            |[a,d,e]     |.            |
|9   |Yes            |[a]         |.            |
+----+---------------+------------+-------------+
</code></pre>
<p>explode() by diagnosis you can get case 1 and case 3
explode() by not diagnosis you can get case 2 and case 4 </p>
<p>Update1:</p>
<p>When you expose and group by diagnosis you can get the following form, but I don't know how to distint between case2 &amp; case4. </p>
<p>We can get count by 
<strong>total patient - prescr_testdrug Yes count - prescr_testdrug No count = case2 + case 4</strong></p>
<pre><code>+----------+-------------------+-------------------+-------------+
|diagnosis |prescr_testdrug Yes| prescr_testdrug No| case2/case4 |
+----------+-------------------+-------------------+-------------+
|a         |[0,3,8,9]          |[6]                |             |
|b         |[0,1]              |[2]                |             |
|c         |[0,1,7]            |[2,4]              |             |
|d         |[8]                |[4]                |             |
</code></pre>
</div>
<span class="comment-copy">each Id represent one patient ? Do you know all diagnosis type before?</span>
<span class="comment-copy">@howie yes, the id just basically shows the distinct patients. So in the example dataframe that I show , for each patient, it shows whether or not the drug in question was prescribed(yes or no), and the list of diseases (diagnosis) that they may have been diagnosed with. I just used 'a,b,c' for simplification, but in my dataset they are actually ICD10 codes. I just don't know how to properly be able to display the counts that I want based on the 4 scenarios (Case1/2/3/4) that I outlined above.</span>
<span class="comment-copy">I forgot to mention that my dataset has thousands of diagnosis, so if I try to create a not diagnosis set, it will be huge for each patient...</span>
<span class="comment-copy">Spark is meant to process huge data, so it not a problem. But still we can try to find a better way. I will update in my answer</span>
