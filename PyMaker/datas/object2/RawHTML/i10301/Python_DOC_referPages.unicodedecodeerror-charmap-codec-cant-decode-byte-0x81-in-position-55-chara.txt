<div class="post-text" itemprop="text">
<p>I am new to Python and am hoping that someone could please explain to me what the error message means. </p>
<p>To be specific, I have some code of Python and SPSS combined together saved in Atom, which was created by a former colleague. Now since the former colleague is not here anymore, I need to run the code now. What I did was I ran the code below from SPSS22. </p>
<pre><code>    begin program.
    import spss,spssaux,imp
    abcvalid = imp.load_source('abcvalid', "I:/VALIDITY CHECK/Python Library/2016/abcvalid2016.py") 
    import abcvalid
    abcvalid.fullprocess("9_26_2016","M:/Users/Yli\2016 SURVEY/DOWNLOADS/9_26_2016/","M:/Users/Yli/2016 SURVEY/Legacy15.sav")
    end program.
</code></pre>
<p>Then I got the following from the output.</p>
<pre><code>    Traceback (most recent call last):
      File "&lt;string&gt;", line 5, in &lt;module&gt;
      File "I:/VALIDITY CHECK/Python Library/2016/abcnvalid2016.py", line 2067, in fullprocess
        dataprep(date,filepath,legacypath)
      File "I:/VALIDITY CHECK/Python Library/2016/abcvalid2016.py", line 2006, in dataprep
        emailslower(date,filepath)
      File "I:/VALIDITY CHECK/Python Library/2016/abcvalid2016.py", line 1635, in emailslower
        DATASET ACTIVATE comment_data.""".format(date,filepath))
      File "C:\PROGRA~1\IBM\SPSS\STATIS~1\22\Python\Lib\site-packages\spss\spss.py", line 1494, in Submit
        cmdList = spssutil.CheckStr(cmdList)
      File "C:\PROGRA~1\IBM\SPSS\STATIS~1\22\Python\Lib\site-packages\spss\spssutil.py", line 166, in CheckStr
        s1 = unicode(mystr,locale.getlocale(locale.LC_CTYPE)[1])
      File "C:\Program Files\IBM\SPSS\Statistics\22\Python\lib\encodings\cp1252.py", line 15, in decode
        return codecs.charmap_decode(input,errors,decoding_table)
    UnicodeDecodeError: 'charmap' codec can't decode byte 0x81 in position 55: character maps to &lt;undefined&gt;
</code></pre>
<p>I know there are similar questions on this site, but the questions and answers were too hard for me to comprehend. If someone could please help me, I'd really appreciate it!</p>
<p>Thank you in advance!</p>
</div>
<div class="post-text" itemprop="text">
<p>It's hard to be sure about what is going on here as there is a lot of code off stage, but the error message is telling you that there is an invalid character in the input stream.  Code x81 is undefined in code page 1252, which is the code page in effect.  That's the western Europe/US default code page.  The program is trying to convert a presumed code-page string to Unicode, so that fails.</p>
<p>My guess is that the input is actually not encoded with cp 1252.  Something is messed up in in the Statistics current code page or with Unicode mode.  You might need to set the SPSS Statistics locale to something different or to turn Unicode mode on or off.  See SET LOCALE and SET UNICODE in the Command Syntax Reference on how to do this.</p>
<p>If you can say more about your locale and what this code is doing, we might be able to provide more information.</p>
</div>
<div class="post-text" itemprop="text">
<p>First, here is a minimal example reproducing your error on Windows:</p>
<pre><code>import subprocess

with subprocess.Popen("cmd /c echo ü", stdout=subprocess.PIPE, text=True) as Process:
    for Line in Process.stdout:
        print(Line)
</code></pre>
<p>To my understanding, the problem is this (I put together some information and examples which I have found, but am not certain everything is correct. I welcome corrections.)</p>
<ul>
<li>The <code>ü</code> character is code point 252 = 0xfc in Unicode, <a href="https://unicode-table.com/en/00FC/" rel="nofollow noreferrer">https://unicode-table.com/en/00FC/</a>).</li>
<li>Python correct passes the <code>ü</code> character to the console, as you can test using this example (be sure to save the file as UTF-8):</li>
</ul>
<pre><code>import subprocess

print(ord('ü'))
subprocess.call("cmd /c echo ü")
</code></pre>
<p>I am not sure why this is working in the first place. (This answer may be why: <a href="https://stackoverflow.com/a/32176732/880783">https://stackoverflow.com/a/32176732/880783</a>)</p>
<ul>
<li>The console uses something else than Unicode internally. For example, in the <a href="http://www.asciitable.com/" rel="nofollow noreferrer">ASCII table</a>, the <code>ü</code> character is at position 129 = 0x81 (sounds familiar?).</li>
<li>So when the console returns that character, Python thinks its a Unicode codepoint, but <a href="https://unicodelookup.com/#0x81" rel="nofollow noreferrer">0x81 is not defined</a>. Hence the error.</li>
</ul>
<p>The key is to make Python understand that how what it gets from the process is encoded. In my example (Windows console), I have tried a couple of encodings (see the <a href="https://docs.python.org/3/library/codecs.html" rel="nofollow noreferrer">list here</a>) like this:</p>
<pre><code>import subprocess

Encoding = 'cp850'
with subprocess.Popen("cmd /c echo ü", stdout=subprocess.PIPE, text=True, encoding=Encoding) as Process:
    for Line in Process.stdout:
        print(Line)
</code></pre>
<ul>
<li><code>'ascii'</code> fails with an <code>ordinal not in range(128)</code> error (probably does not cover extended ASCII).</li>
<li><code>'cp1252'</code> fails with <code>character maps to &lt;undefined&gt;</code></li>
<li><code>'latin_1'</code> works, but outputs a box character (``) on my debug console in VS Code.</li>
<li><code>'cp850'</code> seem to works, outputting a <code>ü</code> character.</li>
</ul>
<p>So I will stick with <code>'cp850'</code> for now and see how it goes.</p>
</div>
<span class="comment-copy">Thank you so much for the detailed explanation! I'll see if I can fix it. Thank you!!!</span>
