<div class="post-text" itemprop="text">
<p>I am trying to reproduce <a href="https://vega.github.io/vega-lite/examples/facet_bullet.html" rel="nofollow noreferrer">this Vega-lite chart</a> in Altair, but encountering some issues. Here's what I have so far:</p>
<pre><code># data import and prep
import json
import altair as alt
import pandas as pd

df = pd.read_json("""[{"title":"Revenue","subtitle":"US$, in thousands","ranges":[150,225,300],"measures":[220,270],"markers":250},
{"title":"Profit","subtitle":"%","ranges":[20,25,30],"measures":[21,23],"markers":26},
{"title":"Order Size","subtitle":"US$, average","ranges":[350,500,600],"measures":[100,320],"markers":550},
{"title":"New Customers","subtitle":"count","ranges":[1400,2000,2500],"measures":[1000,1650],"markers":2100},
{"title":"Satisfaction","subtitle":"out of 5","ranges":[3.5,4.25,5],"measures":[3.2,4.7],"markers":4.4}]""")

df[['measure1','measure2']] = pd.DataFrame(df.measures.values.tolist(), index=df.index)

df[['low', 'medium', 'high']] = pd.DataFrame(df.ranges.values.tolist())

# chart
base = alt.Chart(df).encode(row = 'title:O')
m1 = base.mark_bar().encode(x='measure1:Q')
m2 = base.mark_tick().encode(x='measure2:Q')
</code></pre>
<p>So far so good. When I try to layer the two charts, however:</p>
<pre><code>m1 + m2

SchemaValidationError: Invalid specification

    altair.vegalite.v2.api.LayerChart-&gt;layer-&gt;items, validating 'anyOf'

    {'data': {'name': 'data-58353a9bcf31ee710e2a5cb2da21a143'}, 'mark': 'bar', 'encoding': {'row': {'type': 'nominal', 'field': 'title'}, 'x': {'type': 'quantitative', 'field': 'measure1'}}} is not valid under any of the given schemas
</code></pre>
<p>Note that this works if I specify a <code>y</code> encoding in both layers and facet at the end, however that defeats the purpose of having facets (all the Y axis marks are repeated in all facets. If I specify neither the <code>row</code> encoding in the base chart nor the <code>y</code> encoding, only one bar gets plotted (the largest one).</p>
<p>The reason I want facets is so I can specify independent x scales given the different domain of the data (see original example).</p>
<p>Thanks for your help!</p>
</div>
<div class="post-text" itemprop="text">
<p>In both Altair and vega-lite, it is invalid to layer two faceted charts (in general, there is no guarantee that two faceted charts will line up when layering). If you look closely at the vega-lite chart, you'll see that instead of layering faceted charts, it facets a layered chart.</p>
<p>The same can be accomplished in Altair this way:</p>
<pre><code>import altair as alt
import pandas as pd

df = pd.DataFrame.from_records([
    {"title":"Revenue","subtitle":"US$, in thousands","ranges":[150,225,300],"measures":[220,270],"markers":[250]},
    {"title":"Profit","subtitle":"%","ranges":[20,25,30],"measures":[21,23],"markers":[26]},
    {"title":"Order Size","subtitle":"US$, average","ranges":[350,500,600],"measures":[100,320],"markers":[550]},
    {"title":"New Customers","subtitle":"count","ranges":[1400,2000,2500],"measures":[1000,1650],"markers":[2100]},
    {"title":"Satisfaction","subtitle":"out of 5","ranges":[3.5,4.25,5],"measures":[3.2,4.7],"markers":[4.4]}
])

alt.layer(
    alt.Chart().mark_bar(color='#eee').encode(alt.X("ranges[2]:Q", scale=alt.Scale(nice=False), title=None)),
    alt.Chart().mark_bar(color='#ddd').encode(x="ranges[1]:Q"),
    alt.Chart().mark_bar(color='#ccc').encode(x="ranges[0]:Q"),
    alt.Chart().mark_bar(color='lightsteelblue', size=10).encode(x='measures[1]:Q'),
    alt.Chart().mark_bar(color='steelblue', size=10).encode(x='measures[0]:Q'),
    alt.Chart().mark_tick(color='black').encode(x='markers[0]:Q'),
    data=df
).facet(
    row="title:O"
).resolve_scale(
    x='independent'
)
</code></pre>
<p><a href="https://i.stack.imgur.com/HAjYp.png" rel="nofollow noreferrer"><img alt="enter image description here" src="https://i.stack.imgur.com/HAjYp.png"/></a></p>
<p>Some of the style/configuration options from the original chart are missing, but this is the rough idea.</p>
</div>
<span class="comment-copy">thank you very much Jake! you're very kind.</span>
