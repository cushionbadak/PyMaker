<div class="post-text" itemprop="text">
<p>In Cython 0.25 the <code>no_gc</code> directive was added. The documentation for this new directive (as well as for a related <code>no_gc_clear</code> directive) can be found <a href="http://cython.readthedocs.io/en/latest/src/userguide/extension_types.html#controlling-cyclic-garbage-collection-in-cpython" rel="nofollow noreferrer" title="documentation">here</a>, but the only thing I really understand about it is that it can speed up your code be disabling certain aspects of garbage collection.</p>
<p>I am interested because I have some high performance Cython code which uses extension types, and I understand that <code>no_gc</code> can speed things up further. In my code, instances of extension types are always left alive until the very end when the program closes, which makes me think that disabling garbage collection for these might be OK.</p>
<p>I guess what I really need is an example where the usage of <code>no_gc</code> goes <strong>bad</strong> and leads to memory leaks, together with en explanation of exactly why that happens.</p>
</div>
<div class="post-text" itemprop="text">
<p>It's to do with circular references - when instance <code>a</code> holds a reference to a Python object that references <code>a</code> again then <code>a</code> can never be freed through reference counting so Python tries to detect the cycle.</p>
<p>A very trial example of a class that could cause issues is:</p>
<pre><code># Cython code:

cdef class A:
    cdef param

    def __init__(self):
        self.param = self
</code></pre>
<p>(and some Python code to run it)</p>
<pre><code>import cython_module
while True:
    cython_module.A()
</code></pre>
<p>This is fine as is (the cycles are detected and they get deallocated every so often) but if you add <code>no_gc</code> then you will run out of memory.</p>
<p>A more realistic example might be a parent/child pair that store a reference to each other.</p>
<hr/>
<p>It's worth adding that the performance gains likely to be small. The garbage collector is only run occasionally in situations when a lot of objects have been allocated and few have been freed (<a href="https://docs.python.org/3/library/gc.html" rel="nofollow noreferrer">https://docs.python.org/3/library/gc.html</a> - see <code>set_threshold</code>). It's hopefully unlikely that this describes your high performance code.</p>
<p>There's probably also a small performance cost on allocation and deallocation of your objects with GC, to add/remove them from the list of tracked objects (but again, hopefully you aren't allocating/deallocting huge numbers)</p>
<hr/>
<p>Finally, if your class never stores any references to Python objects then it's effectively <code>no_gc</code> anyway. Setting the option will do no harm but also do no good.</p>
</div>
