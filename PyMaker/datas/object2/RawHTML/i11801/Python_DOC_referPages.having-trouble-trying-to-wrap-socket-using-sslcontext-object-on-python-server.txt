<div class="post-text" itemprop="text">
<p>I'm trying to set attributes to my SSLContext object and then trying to wrap the socket, but it shows me that none of the attributes are used while wrapping it.</p>
<p>When I run it, the Cipher suites still have DH and it uses PROTOCOL_TLSv1 instead of the PROTOCOL_SSLv23 I'm trying to set it to. Can someone show me what I'm doing wrong here?</p>
<pre><code>from socket import * 
import ssl
serverSocket = socket(AF_INET, SOCK_STREAM)
serverSocket.bind(('', 3340))
serverSocket.listen(1)

while True: 
    print ('Ready to serve...' )

    (newSocket,addr) = serverSocket.accept()      

    context = ssl.SSLContext(ssl.PROTOCOL_SSLv23) #still uses TLSv1 
    context.load_cert_chain(certfile="server.crt", keyfile="server.key") 
    context.set_ciphers("ALL:!DH") #Trying to get only cipher suites without DH

    connectionSocket = context.wrap_socket(newSocket, server_side=True)
#################################
    try:
        message =  connectionSocket.recv(1024)

        filename = message.split()[1]
        f = open(filename[1:])

        outputdata = f.read()

        connectionSocket.send("HTTP/1.1 200 OK\r\n\r\n")

        for i in range(0, len(outputdata)): 
            connectionSocket.send(outputdata[i]) 

        connectionSocket.send("\r\n")
        connectionSocket.close() 
    except IOError: #Send response message for file not found 
        print ("IOError")
        connectionSocket.send('404 Not Found: Requested document not found')
        connectionSocket.close() 
serverSocket.close() 
</code></pre>
</div>
<div class="post-text" itemprop="text">
<blockquote>
<pre><code>context = ssl.SSLContext(ssl.PROTOCOL_SSLv23) #still uses TLSv1 
</code></pre>
</blockquote>
<p>PROTOCOL_SSLv23 means that it uses a SSLv2 compatible handshake. It still will do TLS 1.x. See <a href="https://docs.python.org/3/library/ssl.html#socket-creation" rel="nofollow">the documentation</a> where it is clearly listed what protocols are supported in this case, namely all of SSLv2, SSLv3 and TLSv1.x. </p>
<p>The protocol actually used in the handshake depends on what the client offers and what the server accepts and supports. In the case of SSLv23 the server accepts everything so it fully depends on the client. To deny the use of specific protocols better use the <code>OPENSSL_NO_*</code> flags.</p>
<blockquote>
<pre><code>context.set_ciphers("ALL:!DH") #Trying to get only cipher suites without DH
</code></pre>
</blockquote>
<p>This is correct and this also works. I have no idea how you tested and determined  that it does not work. The idea of ciphers is the same as with the protocol: the client offers a number of ciphers and the server accepts one of these if this is supported on the server side. In this case the connection would fail if the client offers only DH ciphers. </p>
<p>Note that as it is currently the code would fail when the client tries offers only DH ciphers no matter if you explicitly deny DH or not because you did not fully setup DH support. To do this you would need to load a DH file with <code>context.load_dh_params(dhfile)</code>.</p>
<p>Apart from that <code>ALL:!DH</code> is a bad choice since you include all the weak and anonymous ciphers with <code>ALL</code> which makes it really insecure. A safer choice would be <code>DEFAULT:!DH</code>.</p>
</div>
