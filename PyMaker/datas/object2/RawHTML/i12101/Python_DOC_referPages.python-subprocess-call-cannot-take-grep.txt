<div class="post-text" itemprop="text">
<p>Python subprocess call is supposed to run as command as is, but it is complaining if there is a pipe in it. Here is my code:</p>
<pre><code>#!/usr/bin/python

import sys
import subprocess
import time
service_name= "mysrvc"
state ="STOPPED"
mycmd ="sc query " + service_name + " " + "|" + " findstr" + " " + state 
print(mycmd)
if subprocess.call(mycmd)==0:
  print("Service stopped successfully")
</code></pre>
<p>The Error I get is : </p>
<pre><code>ERROR: Invalid Option; Would you like to see help for the QUERY and QUERYEX commands? [ y | n ]:
</code></pre>
<p>If I change the command to just </p>
<pre><code>mycmd = "sc query " + service_name 
</code></pre>
<p>I am able to run the script successfully. It is just the pipe and the arguments following it which is a problem. If I run <code>sc query mysvrc | findstr STOPPED</code> directly on command line it works fine.</p>
<p>How can I get this to work? Note that I run this python script using jython2.7. I wasn't successful in using win32serviceutil because it couldn't find the module win32serviceutil.</p>
</div>
<div class="post-text" itemprop="text">
<p>As already stated, <a href="https://docs.python.org/3/library/subprocess.html#frequently-used-arguments" rel="nofollow"><code>subprocess</code> can't handle single <code>str</code> inputs and shell metacharacters like <code>|</code> unless <code>shell=True</code></a>. But in this case, you really don't need a pipe anyway. You can have Python do the filtering and avoid the pipe to <code>findstr</code> completely:</p>
<pre><code># sc query command only, as list which gets better safety/performance
mycmd = ["sc", "query", service_name]

# Open command to run asynchronously, capturing output
proc = subprocess.Popen(mycmd, stdout=subprocess.PIPE)

# Wait for process to complete while slurping output
stdout, _ = proc.communicate()

# Check if expected output was seen and process exited successfully
if state in stdout and proc.returncode == 0:
    print("Service stopped successfully")
</code></pre>
</div>
<div class="post-text" itemprop="text">
<p>I'm not sure about <code>jython</code> specifically, but the <a href="https://docs.python.org/2/library/subprocess.html" rel="nofollow"><code>subprocess</code></a> documentation suggests that your command needs to be a list, not a string, unless you set the <code>shell</code> variable to <code>True</code>. Your code should work if you change your call to be <code>subprocess.call(mycmd, shell=True)</code>, but please be sure to read the warnings in the documentation about the security risks inherent in setting <code>shell</code> to <code>True</code>.</p>
<p>If you don't want to set <code>shell=True</code>, you won't be able to use the pipe directly in your command, but there is a section in the documentation, <a href="https://docs.python.org/2/library/subprocess.html#replacing-shell-pipeline" rel="nofollow">replacing shell pipeline</a> on how to mimic the functionality of the pipe using <code>subprocess.Popen</code>.</p>
</div>
<span class="comment-copy">Please copy-paste the entire error message into your question. See <a href="https://stackoverflow.com/help/mcve">Minimal, Complete, and Verifiable example</a> for more info.</span>
<span class="comment-copy">The Error I get is : ERROR:  Invalid Option; Would you like to see help for the QUERY and QUERYEX commands? [ y | n ]:</span>
<span class="comment-copy">Please <a href="https://stackoverflow.com/posts/35732673/edit">edit</a> your question to include the error message --- it will get buried down here in the comments.</span>
<span class="comment-copy">Hi! What is "state" in the code? Am getting the following error:                    if state in stdout and proc.returncode == 0: NameError: name 'state' is not defined</span>
<span class="comment-copy">Sorry.. I understaood what the state is. I added an else to "if state in stdout and proc.returncode==0" to print error. When I execute it, it is always going to the else part . I think it is not evaluating state in stdout.</span>
<span class="comment-copy">I printed stdout and found that state is "STOP PENDING". Thats why it is failing. I will write a while do loop to keep querying until this changes to STOPPED. That should help</span>
<span class="comment-copy">@user1164061: Glad you figured it out. :-) Wasn't at a computer to see your comments until just now.</span>
<span class="comment-copy">Thank you very much for helping me.</span>
