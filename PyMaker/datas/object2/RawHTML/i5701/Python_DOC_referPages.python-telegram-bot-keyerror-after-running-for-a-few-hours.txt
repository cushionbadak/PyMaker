<div class="post-text" itemprop="text">
<p>I wrote a Telegram bot in Python, which is running on my Raspberry Pi (Raspbian). I eventually see an error after the bot has been running for a few hours.</p>
<p>Before I post the complete code, could someone please help me understand the error? I would like to run the bot indefinitely, or at least for multiple days, before I need to restart it.</p>
<p>The error is as follows:</p>
<pre><code>Traceback (most recent call last):
  File "/home/pi/Schreibtisch/StreamrPreisBot/telepot/loop.py", line 37, in run_forever
    self._handle(msg)
  File "/home/pi/Schreibtisch/StreamrPreisBot/streamrinfobot.py", line 32, in handle
    command = msg['text']
KeyError: 'text'
</code></pre>
<p>Edit:
Following code is used:</p>
<pre><code>def handle(msg):
    chat_id = msg['chat']['id']
    command = msg['text']
</code></pre>
<p>Might this code solve the problem?</p>
<pre><code>def handle(msg):
    chat_id = msg['chat']['id']
    command = msg.get('text')
</code></pre>
</div>
<div class="post-text" itemprop="text">
<p>Error says there is no <code>text</code> key inside <code>msg</code> dict. Maybe it's some special telegram message that has no text or there is a bug in you code that delete <code>text</code> key in some cases. You could use</p>
<pre><code>command = msg.get('text')
</code></pre>
<p>To get <code>None</code> when there is no text. Or</p>
<pre><code>command = msg.get('text', '')
</code></pre>
<p>To get empty string (i.e. <code>''</code>) when there is no text.</p>
<p>You could also check that there is a <code>text</code> inside <code>msg</code> or not with <code>in</code> operator:</p>
<pre><code>if 'text' not in msg:
    logger.error('bad message received!')
    return
</code></pre>
<hr/>
<p>If you want to your service to be always up you should add some mechanism for automatic restart. </p>
<p>like in Python to restart after any error:</p>
<pre><code>while True:
    try:
        logger.info("Starting bot")
        run_bot()
    except Exception:
        logger.exception("Something bad happened. Restarting")
</code></pre>
<p>I also suggest to log errors in a file or services such as <a href="https://sentry.io/" rel="nofollow noreferrer">Sentry</a> to investigate why there is no text afterwards.</p>
</div>
<div class="post-text" itemprop="text">
<p>A <code>KeyError</code> is raised when a value is requested from a <code>dict</code> but the key does not exist in the dictionary.</p>
<p>So, in your case, the <code>msg</code> dictionary does not have the key <code>text</code>.</p>
<p>You should inspect your code to ensure that the <code>msg</code> dictionary contains a value associated with the key <code>text</code>. Or, if you expect that <code>msg</code> will sometimes not contain the key <code>text</code>, you should instead access the dictionary with the <code>get</code> method, which never raises a <code>KeyError</code>. See <a href="https://docs.python.org/3/library/stdtypes.html#dict.get" rel="nofollow noreferrer">the docs</a> for more information.</p>
</div>
<span class="comment-copy">you should also post the code that produces this error.</span>
<span class="comment-copy">I'd be happy to help track down the cause of the error if you at least post the code for <code>_handle(msg)</code> in <code>loop.py</code>.</span>
<span class="comment-copy">@SurvivorX Before deciding to use the <code>get</code> method, you need to determine why the dictionary doesn't contain the <code>text</code> key. If you expect it to always contain the <code>text</code> key, then your bug is actually somewhere else. It just happens to be manifesting in this way. So, please tell me, do you expect the <code>text</code> key to <i>always</i> be there?</span>
<span class="comment-copy">Since the bot has permissions to read every single message in the groups it is used, the text key actually should always be given, I guess</span>
<span class="comment-copy">@SurvivorX I see. So then it sounds like the source of your bug is elsewhere. Therefore, I would avoid the <code>get</code> method for now because it will silence the exception. Instead, try to track down the reason why the <code>text</code> key does not exist in the <code>msg</code>.</span>
<span class="comment-copy">Actually the program is working perfectly fine, it just gives me that error (multiple times), after a few hours of runtime, and gets slower and slower. If silencing this Error helps, that would be enough already. I will let it run and check it tomorrow and respond here how it worked. Thanks!</span>
<span class="comment-copy">@SurvivorX Any luck?</span>
