<div class="post-text" itemprop="text">
<p>Python runs out of memory when starting a multiprocessing application inside a for loop. The allocated memory grows bigger with each additional loop. How do I fix this problem?</p>
<p>I am performing large Monte Carlo simulations with thousands of simulations each. To get a performance boost, I am using the <code>multiprocessing</code> module and run the individual simulations parallel on 10 cores. Every Monte Carlo simulation uses the same model, but different model inputs. I am basically looping over an input list and start a new Monte Carlo simulation with the next models inputs after the previous Monte Carlo simulation finished.</p>
<p>The weird thing is, that the allocated memory from the previous Monte Carlo simulation is not released after it finished. The allocated memory simply grows bigger with each additional Monte Carlo simulation until python runs out of memory. Every python object from the previous Monte Carlo simulation is overwritten by the the object from the next Monte Carlo simulation. Deleting the objects at the end of the loop using <code>del</code> or calling <code>gc.collect()</code> is not helping.</p>
<p>My current solution: realization of the for loop in a bash script which calls python with every loop.</p>
<p>The code is very large consisting of several different classes. Basically this is whats happening:</p>
<pre class="lang-py prettyprint-override"><code>from monte_carlo import mc_class

input_list = [input1, input2, ...]
model_parameters = ...

for inpt in input_list:
    mc = mc_class(model_parameters=model_parameters, model_inputs=inpt)
    mc.run()
    mc.save_results()
    mc.generate_plots()
    del mc
</code></pre>
<p><code>mc.run()</code> starts the Monte Carlo simulation. This call creates several processes, runs them and collects the results. The code is basically identical to <a href="https://github.com/lbl-srg/EstimationPy/blob/master/estimationpy/fmu_utils/fmu_pool.py" rel="nofollow noreferrer">https://github.com/lbl-srg/EstimationPy/blob/master/estimationpy/fmu_utils/fmu_pool.py</a></p>
<p>I expected the memory to be released after <code>multiprocessing</code> finished. I thought python will garbage collect, especially after <code>del mc</code>.</p>
</div>
<div class="post-text" itemprop="text">
<p>The garbage collector does its work independently from the code. While <code>del</code> deletes an object, it does not invoke the garbage collector. </p>
<p>You can <code>import gc</code> to get a quite extensive API to the garbage collector, including running the garbage collector explicitly (e.g. after your <code>del mc</code>) and tools for debugging leaky programs.</p>
<p>See: <a href="https://docs.python.org/3/library/gc.html" rel="nofollow noreferrer">https://docs.python.org/3/library/gc.html</a></p>
</div>
<div class="post-text" itemprop="text">
<p><code>del</code> will only remove the binding assignment between the variable (identifier) and the object, so the object will still exist in memory.</p>
<p>Try <code>mc=None</code> instead of <code>del mc</code></p>
</div>
<span class="comment-copy">I already tried <code>gc.collect()</code> after <code>del mc</code>, but the result is the same. The memory is not released.</span>
