<div class="post-text" itemprop="text">
<p>I'm trying to make a function where that returns the name of the logged in user if one can be identified or None if not. i want to do this by finding the session id from the cookie in the Bottle request if present, and using it to look up the user in the sessions table.</p>
<p>My code so far:</p>
<pre><code>def session_user(db):
    """try to
    retrieve the user from the sessions table
    return usernick or None if no valid session is present
    """
    cursor = db.cursor()
    sessionid = bottle.request.get_cookie(COOKIE_NAME)
    usernick = None
    if sessionid:
        cursor.execute("SELECT usernick FROM sessions WHERE sessionid=?", (sessionid,))
        usernick = cursor.fetchall()
    return usernick
</code></pre>
<p>The table in database:</p>
<pre><code>DROP TABLE IF EXISTS sessions;
CREATE TABLE sessions (
            sessionid text unique primary key,
            usernick text,
            FOREIGN KEY(usernick) REFERENCES users(nick)
);
</code></pre>
<p>When i use the current code in my function i get a unit test error:</p>
<pre><code>line 125, in test_session_user
    self.assertEqual(nick_from_cookie, None, "Expected None in case with invalid session id, got %s" % str(nick_from_cookie))
AssertionError: [] != None : Expected None in case with invalid session id, got []
</code></pre>
</div>
<div class="post-text" itemprop="text">
<p>See the <a href="https://docs.python.org/3/library/sqlite3.html#sqlite3.Cursor.fetchall" rel="nofollow"><code>cursor.fetchall</code> documentation</a>:</p>
<blockquote>
<p>Fetches all (remaining) rows of a query result, returning a list. Note that the cursorâ€™s arraysize attribute can affect the performance of this operation. <em>An empty list is returned when no rows are available.</em></p>
</blockquote>
<p>Since an empty list in Python is a false-y expression this normally works out well - when not doing explicit compares with False/None. Always returning <em>a</em> list also makes code that iterates the result set (or checks the length) easier because no special case for None has to be done.</p>
<p>Use the aptly named <a href="https://docs.python.org/3/library/sqlite3.html#sqlite3.Cursor.fetchone" rel="nofollow"><code>fetchone</code></a> to get a <em>single</em> result <em>record</em>, or None.</p>
</div>
<span class="comment-copy">is the rest of my code right ? sorry i'm not too good with python and SQLite</span>
<span class="comment-copy">when using fetchone i know get: line 138, in test_session_user     self.assertEqual(nick_from_cookie, nick) AssertionError: ('Bobalooba',) != 'Bobalooba'. I'm guessing because its retreiving a tuple?</span>
<span class="comment-copy">A tuple is not the same as a string.</span>
<span class="comment-copy">is it possible to convert it to a string so that i can make the comparison or is there a better way ?</span>
<span class="comment-copy">You could get the first element of the returned tuple (corresponding to the first column in the result set). In this case you need to make sure that there was a result first.</span>
