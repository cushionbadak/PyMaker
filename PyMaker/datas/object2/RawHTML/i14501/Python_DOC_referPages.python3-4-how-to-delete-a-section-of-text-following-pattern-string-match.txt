<div class="post-text" itemprop="text">
<p>I have a file I need to remove a section of text following a string pattern match.</p>
<p>text from file:</p>
<pre><code>zone "domain1.com" {
        type slave;
        masters {10.10.10.1;};
        allow-notify{10.10.10.1;};
        allow-transfer {trusted;};
        key-directory "/usr/local/etc/namedb/";
        file "/usr/local/etc/namedb/domain1.com.external.signed";
};
zone "domain2.com" {
        type slave;
        masters {10.10.10.1;};
        allow-notify{10.10.10.1;};
        allow-transfer {trusted;};
        key-directory "/usr/local/etc/namedb/";
        file "/usr/local/etc/namedb/domain2.com.external.signed";
};
</code></pre>
<p>How do I search for domain2, then delete that line plus the next 7 lines below it?
There will be many domains.</p>
</div>
<div class="post-text" itemprop="text">
<p>You can write to a <a href="https://docs.python.org/3.4/library/tempfile.html#tempfile.NamedTemporaryFile" rel="nofollow">NamedTemporaryFile</a>, skipping 7 lines every time  <code>"domain2.com"</code> is in the line with <a href="https://docs.python.org/3.4/library/itertools.html#itertools.islice" rel="nofollow">itertool.islice</a>, using <a href="https://docs.python.org/3/library/shutil.html#shutil.move" rel="nofollow">shutil.move</a> to replace the original file at the end: </p>
<pre><code>from tempfile import NamedTemporaryFile
from itertools import islice
from shutil import move

with open("test.txt") as f, NamedTemporaryFile("w",dir=".", delete=False) as temp:   
    for line in f:
        if '"domain2.com"' in line:
            list(islice(f, 7))   
        else:
            temp.write(line)

move(temp.name,"test.txt")
</code></pre>
<p>Output:</p>
<pre><code> zone "domain1.com" {
    type slave;
    masters {10.10.10.1;};
    allow-notify{10.10.10.1;};
    allow-transfer {trusted;};
    key-directory "/usr/local/etc/namedb/";
    file "/usr/local/etc/namedb/domain1.com.external.signed";
};
</code></pre>
<p><code>delete=False</code> means the file won't be deleted, if the process is interrupted then nothing will be written to the original, finally we use <code>move(temp.name,"test.txt")</code> to overwrite the original.</p>
</div>
<div class="post-text" itemprop="text">
<p>If you know it will always be 7 line the following regex selects them:</p>
<pre><code>[^\n]*domain2([^\n]*\n){7}
</code></pre>
<p>I don't know how to do that in python, but I think it will be easy to figure out if you know python.</p>
</div>
<div class="post-text" itemprop="text">
<pre><code>import re
p = re.compile(ur'zone.*?\bdomain2\b.*?{[\s\S]*?\n};')
test_str = u"zone \"domain1.com\" {\n type slave;\n masters {10.10.10.1;};\n allow-notify{10.10.10.1;};\n allow-transfer {trusted;};\n key-directory \"/usr/local/etc/namedb/\";\n file \"/usr/local/etc/namedb/domain1.com.external.signed\";\n};\nzone \"domain2.com\" {\n type slave;\n masters {10.10.10.1;};\n allow-notify{10.10.10.1;};\n allow-transfer {trusted;};\n key-directory \"/usr/local/etc/namedb/\";\n file \"/usr/local/etc/namedb/domain2.com.external.signed\";\n};"
subst = u""

result = re.sub(p, subst, test_str)
</code></pre>
</div>
<div class="post-text" itemprop="text">
<p>If you want to use a regex on a larger file, use <a href="https://docs.python.org/2/library/mmap.html" rel="nofollow noreferrer">mmap</a>.</p>
<pre><code>import mmap
import re
from tempfile import NamedTemporaryFile

with open(ur_fn, 'r+') as tgt, NamedTemporaryFile(dir='/tmp', delete=False) as out:
    mm=mmap.mmap(tgt.fileno(), 0)
    fn=out.name
    pat=re.compile(r'^(\s*zone "domain.*?)(?=^\s*zone|\Z)', flags=re.S | re.M)
    for i, block, span in ((n, m.group(1), m.span()) for n,m in enumerate(pat.finditer(mm))):
        if "domain2.com" in block:
            continue
        else:
            out.write(block)

with open(fn) as inf:
    print(inf.read())   # replace this with copying the file onto orig, etc    
</code></pre>
<p>Then copy the temp file onto your original. </p>
<p>If your file has the absolute pattern of 7 lines after the target -- Padraic Cunningham's <a href="https://stackoverflow.com/a/30033342/298607">solution</a> is better. If you have variable line blocks or something better described with a regex, this approach is handy.    </p>
<hr/>
<p>For what you are working on, try:</p>
<pre><code>import mmap
import re
from tempfile import NamedTemporaryFile

name="new_domain2.com"

template='''\
zone "%s" {
   type slave;
   masters {108.61.190.64;};
   allow-notify{108.61.190.64;};
   allow-transfer {trusted;};
   key-directory "/usr/local/etc/namedb/";
   file "/usr/local/etc/namedb/nyctelecomm.com.external.signed";
};
'''

with open('/tmp/dms.txt', 'r+') as tgt, NamedTemporaryFile(dir='/tmp', delete=False) as out:
    mm=mmap.mmap(tgt.fileno(), 0)
    fn=out.name
    pat=re.compile(r'^(\s*zone "domain.*?)(?=^\s*zone|\Z)', flags=re.S | re.M)
    for i, block, span in ((n, m.group(1), m.span()) for n,m in enumerate(pat.finditer(mm))):
        if re.match(r'zone "domain2\.com', block):
            out.write(template % name)
        else:
            out.write(block)
</code></pre>
</div>
<span class="comment-copy">Please check <a href="https://regex101.com/r/wU4xF3/2" rel="nofollow noreferrer">regex101.com/r/wU4xF3/2</a>. I think you need to match the line with "domain2" and up to the line that starts with optional whitespace + <code>};</code> or the end of string.</span>
<span class="comment-copy">I am was trying to avoid a system() command</span>
