<div class="post-text" itemprop="text">
<p>How do I convert the output of <code>os.listdir</code> to a list of <code>bytes</code> (from a list of Unicode <code>str</code>s)? It has to work even if the filename is invalid UTF-8, for example:</p>
<pre><code>$ locale
LANG=
LANGUAGE=
LC_CTYPE=en_US.UTF-8
LC_NUMERIC="POSIX"
LC_TIME="POSIX"
LC_COLLATE="POSIX"
LC_MONETARY="POSIX"
LC_MESSAGES="POSIX"
LC_PAPER="POSIX"
LC_NAME="POSIX"
LC_ADDRESS="POSIX"
LC_TELEPHONE="POSIX"
LC_MEASUREMENT="POSIX"
LC_IDENTIFICATION="POSIX"
LC_ALL=
$ python3
Python 3.4.0 (default, Apr 11 2014, 13:05:11) 
[GCC 4.8.2] on linux
Type "help", "copyright", "credits" or "license" for more information.
&gt;&gt;&gt; import os
&gt;&gt;&gt; open(b'\x80', 'w')
&lt;_io.TextIOWrapper name=b'\x80' mode='w' encoding='UTF-8'&gt;
&gt;&gt;&gt; os.listdir('.')
['\udc80']
&gt;&gt;&gt; import sys
&gt;&gt;&gt; [fn.encode(sys.getfilesystemencoding()) for fn in os.listdir('.')]
Traceback (most recent call last):
  File "&lt;stdin&gt;", line 1, in &lt;module&gt;
  File "&lt;stdin&gt;", line 1, in &lt;listcomp&gt;
UnicodeEncodeError: 'utf-8' codec can't encode character '\udc80' in position 0: surrogates not allowed
&gt;&gt;&gt; [... for fn in os.listdir('.')]
[b'\x80']
</code></pre>
<p>So what do I need to write to the <code>...</code> above to make it work?</p>
<p>Please note that it's not an option to rename the file, to use Python 2.x, or to use ASCII-only filenames in this case. I'm not looking for workarounds, I'm looking for the code in place of the <code>...</code>s.</p>
</div>
<div class="post-text" itemprop="text">
<p>Use an error handler; in this case the <code>surrogateescape</code> error handler looks appropriate:</p>
<blockquote>
<p><strong>Value:</strong> <code>'surrogateescape'</code><br/>
<strong>Meaning:</strong> <code>On decoding, replace byte with individual surrogate code ranging from</code>U+DC80<code>to</code>U+DCFF<code>. This code will then be turned back into the same byte when the</code>'surrogateescape'` error handler is used when encoding the data. (See <a href="http://www.python.org/dev/peps/pep-0383" rel="nofollow">PEP 383</a> for more.)</p>
</blockquote>
<p>The <a href="https://docs.python.org/3/library/os.html#os.fsencode" rel="nofollow"><code>os.fsencode()</code> utility function</a> uses the latter option; it encodes to <code>sys.getfilesystemencoding()</code> using the surrogate escape error handler when applicable for your OS:</p>
<blockquote>
<p>Encode filename to the filesystem encoding with <code>'surrogateescape'</code> error handler, or <code>'strict'</code> on Windows; return <code>bytes</code> unchanged.</p>
</blockquote>
<p>In reality it'll use <code>'strict'</code> only when the filesystem encoding is <code>mbcs</code>, see the <a href="https://hg.python.org/cpython/file/c9650423c336/Lib/os.py#l752" rel="nofollow"><code>os</code> module source</a>, a codec only available on Windows.</p>
<p>Demo:</p>
<pre><code>&gt;&gt;&gt; import sys
&gt;&gt;&gt; ld = ['\udc80']
&gt;&gt;&gt; [fn.encode(sys.getfilesystemencoding()) for fn in ld]
Traceback (most recent call last):
  File "&lt;stdin&gt;", line 1, in &lt;module&gt;
  File "&lt;stdin&gt;", line 1, in &lt;listcomp&gt;
UnicodeEncodeError: 'utf-8' codec can't encode character '\udc80' in position 0: surrogates not allowed
&gt;&gt;&gt; [fn.encode(sys.getfilesystemencoding(), 'surrogateescape') for fn in ld]
[b'\x80']
&gt;&gt;&gt; import os
&gt;&gt;&gt; [os.fsencode(fn) for fn in ld]
[b'\x80']
</code></pre>
</div>
<div class="post-text" itemprop="text">
<pre><code>&gt;&gt;&gt; [os.fsencode(fn) for fn in os.listdir('.')]
[b'\x80']
</code></pre>
<p>There is also a corresponding <code>os.fsdecode</code> for conversion in the other direction.</p>
<p>Docs here: <a href="https://docs.python.org/3/library/os.html#os.fsencode" rel="nofollow">https://docs.python.org/3/library/os.html#os.fsencode</a></p>
</div>
<div class="post-text" itemprop="text">
<p>If you just want the filenames from <code>os.listdir</code> in bytes, it has that option.  From the <a href="https://docs.python.org/3.3/library/os.html#os.listdir" rel="nofollow">docs</a>:</p>
<blockquote>
<p><em>path</em> may be either of type <code>str</code> or of type <code>bytes</code>. If <em>path</em> is of type <code>bytes</code>, the filenames returned will also be of type <code>bytes</code>; in all other circumstances, they will be of type <code>str</code>.</p>
</blockquote>
</div>
<span class="comment-copy">have you tried to get bytes in the first place: <code>os.listdir(os.fsencode(os.curdir))</code>?</span>
<span class="comment-copy">Or just <code>os.listdir(b'.')</code>...</span>
<span class="comment-copy">Thank you, <code>surrogateescape</code> indeed works (and <code>surrogatepass</code> doesn't give the result I expect) on my machine.</span>
<span class="comment-copy"><code>os.listdir()</code> uses <code>os.fsdecode()</code> internally therefore <code>os.fsencode()</code> should be used. As @pts said: surrogatepass-based approach produces a wrong result here.</span>
<span class="comment-copy">@J.F.Sebastian: right, removed the <code>surrogatepass</code> option altogether.</span>
