<div class="post-text" itemprop="text">
<p>I am using <code>unittest</code> to test a function that makes a call to AWS using <code>boto3</code>.</p>
<p>The function looks like this:</p>
<pre><code>import boto3


def my_function():
    client = boto3.client('athena')
    res = client.start_query_exeuction(
        QueryString='SELECT * FROM logs',
        ResultConfiguration={'OutputLocation': 's3://mybucket'}
    )

    return res['QueryExecutionId']
</code></pre>
<p>I am using botocore stubber to stub this request in my unit tests like this:</p>
<pre><code>from botocore.stub import Stubber
import botocore.session

def test_my_function():    
    client = botocore.session.get_session().create_client('athena')
    client_res = {'QueryExecutionId': 'testid'}
    exp_params = {
        'QueryString': 'SELECT * FROM logs',
        'ResultConfiguration': {
            'OutputLocation': 's3://mybucket'
        }
    }
    with Stubber(client) as stubber:
        stubber.add_response('start_query_execution', client_res, exp_params)
        res = my_function()

    self.assertEqual(res, 'testid')
</code></pre>
<p>This test is failing with </p>
<blockquote>
<p>botocore.exceptions.ClientError: An error occurred
  (UnrecognizedClientException) when calling the StartQueryExecution
  operation: The security token included in the request is invalid.</p>
</blockquote>
<p>Why would this be failing? Is it because I am creating a new client in <code>my_function()</code> which is different from the client used in the stubber? If so, how can I test this?</p>
<p>Any help is much appreciated.</p>
</div>
<div class="post-text" itemprop="text">
<p>Currently, <code>my_function()</code> is creating a new client, and using that instead of <code>stubber</code>.</p>
<p>One option would be to alter <code>my_function</code> to take <code>_client</code> as an argument.</p>
<pre><code>def my_function(_client=None):
    if _client is not None:
        client = _client
    else:
        client = boto3.client('athena')
    res = client.start_query_exeuction(
        QueryString='SELECT * FROM logs',
        ResultConfiguration={'OutputLocation': 's3://mybucket'}
    )

    return res['QueryExecutionId']
</code></pre>
<p>Then pass <code>stubber</code> to <code>my_function</code>.</p>
<pre><code>with Stubber(client) as stubber:
    stubber.add_response('start_query_execution', client_res, exp_params)
    res = my_function(_client=stubber)
</code></pre>
<p>Another option would be to use <a href="https://docs.python.org/3/library/unittest.mock.html" rel="nofollow noreferrer">mock</a> to patch <code>boto.client</code> to return your stubber.</p>
</div>
