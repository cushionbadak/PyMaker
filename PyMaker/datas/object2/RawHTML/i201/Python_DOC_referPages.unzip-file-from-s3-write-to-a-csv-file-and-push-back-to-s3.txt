<div class="post-text" itemprop="text">
<p>I have built a lambda that collect logs from a EC2 instance and uploads them to a S3 buckets on a daily basis. The logs are stored as .gz files, and now I want to build another lambda that collects the most recently uploaded log file, unzips it, writes it to a CSV file and then pushes it back up to the s3. </p>
<p>I've managed to collect a log file, unzip it and push it back up but I would like some directions how to target the most recent file in the s3 bucket, and how to write it to a CSV before pushing it back up.</p>
<p>I'm using Python for my lambda, and this is how my code looks like right now:</p>
<pre><code>def lambda_handler(event, context):
s3 = boto3.client('s3', use_ssl = False)

s3.upload_fileobj(
    Fileobj = gzip.GzipFile(
        None,
        'rb',
        fileobj = BytesIO(
            s3.get_object(Bucket='bucketName', Key='key')['Body'].read())),
            Bucket ='bucketName',
            Key ='key')
</code></pre>
</div>
<div class="post-text" itemprop="text">
<p>You don't need to worry about querying the latest object in S3. Just use a <a href="https://docs.aws.amazon.com/AmazonS3/latest/dev/NotificationHowTo.html" rel="nofollow noreferrer">S3 Event</a> that triggers your Lambda function.</p>
<p>This means that whenever you Lambda in invoked, it will be invoked with the last inserted object on S3, therefore the most recent.</p>
</div>
<span class="comment-copy">Didn't think about that, but it makes sense. Thanks! Do you have any suggestions how to write the fetched log to a CSV file and then push the CSV back up to the S3 bucket?</span>
<span class="comment-copy">You can use <a href="https://docs.python.org/3/library/csv.html" rel="nofollow noreferrer">docs.python.org/3/library/csv.html</a>. So you read the buffer from your S3 file via s3.Object using boto3, map it to the CSV file you want and then push it back using the s3.put (just make sure you configure your prefix/suffix correctly or push it to a different bucket so you don't get into an infinite loop by triggering another s3 Event)</span>
<span class="comment-copy">@Andpej did it work in the end?</span>
<span class="comment-copy">Been busy with other work lately so I haven’t tried yet. Will keep you updated when I’ve tried it!</span>
