<div class="post-text" itemprop="text">
<p>I get a weird error while trying to push file to remote ftp server using FTP over SSL/TLS. I found no trace of solution online :/ 
Please help.</p>
<p>Here's my code:</p>
<pre><code>from ftplib import FTP_TLS
import sys, os
root = "\\home\\user\\test.txt"
dest = "/Destdir"
ftps = FTP_TLS('xxx.xxx.xxx.xxx')
ftps.set_debuglevel(1)
ftps.set_pasv(False)
ftps.connect(port=21, timeout=80)
ftps.login('user', 'pass')
ftps.prot_p()
ftps.ccc()
try:
    ftps.cwd(dest)
except Exception as e:
    print(e)
try:
    file = open('test.txt', 'rb')
    ftps.storbinary('STOR test.txt', file)
    file.close()
except Exception as e:
    print(e)
ftps.close()
</code></pre>
<p>And here's the output of the script:</p>
<pre><code>*resp* '220 nas FTP server ready.'
*cmd* 'AUTH TLS'
*resp* '234 AUTH TLS command successful.'
*cmd* 'USER user'
*resp* '331 Password required for user.'
*cmd* 'PASS **********'
*resp* '230 User user logged in.'
*cmd* 'PBSZ 0'
*resp* '200 PBSZ command successful (PBSZ=0).'
*cmd* 'PROT P'
*resp* '200 Protection level set to Private.'
*cmd* 'CCC'
*resp* '200 Clearing control channel protection.'
*cmd* 'CWD /Destdir'
*resp* '250 CWD command successful.'
*cmd* 'TYPE I'
*resp* '200 Type set to I.'
*cmd* 'PORT 10,10,99,11,220,211'
*resp* '200 PORT command successful.'
*cmd* 'STOR test.txt'
*resp* "150 Opening BINARY mode data connection for 'test.txt'."
_ssl.c:704: The handshake operation timed out
</code></pre>
<p>As connection to remote FTP server is fine then I suppose it is not a firewall issue.</p>
<p>Note:
Remote FTP server is a Synology NAS, with up to date OS.</p>
<p><strong>EDIT_0:</strong></p>
<p>Another try with passive mode gave that result:</p>
<pre><code>*resp* '220 nas FTP server ready.'
*cmd* 'AUTH TLS'
*resp* '234 AUTH TLS command successful.'
*cmd* 'USER user'
*resp* '331 Password required for user.'
*cmd* 'PASS **********'
*resp* '230 User user logged in.'
*cmd* 'PBSZ 0'
*resp* '200 PBSZ command successful (PBSZ=0).'
*cmd* 'PROT P'
*resp* '200 Protection level set to Private.'
*cmd* 'CCC'
*resp* '200 Clearing control channel protection.'
*cmd* 'CWD /Destdir'
*resp* '250 CWD command successful.'
*cmd* 'TYPE I'
*resp* '200 Type set to I.'
*cmd* 'PASV'
*resp* '227 Entering Passive Mode (xxx,xxx,xxx,xxx,216,241)'
*cmd* 'STOR test.txt'
*resp* "150 Opening BINARY mode data connection for 'test.txt'."
_ssl.c:704: The handshake operation timed out
</code></pre>
<p>I also tried extended passive mode now but it didn't help too:</p>
<pre><code>*resp* '250 CWD command successful.'
*cmd* 'TYPE I'
*resp* '200 Type set to I.'
*cmd* 'EPSV'
*resp* '229 Entering Extended Passive Mode (|||55536|)'
*cmd* 'STOR test.txt'
*resp* "150 Opening BINARY mode data connection for 'test.txt'."
_ssl.c:704: The handshake operation timed out
</code></pre>
<p><strong>EDIT_1:</strong>
So the script works partially, it's able to open connection, starts transfer of the file. File get's created on the remote server but it doesn't contain the same data as source file. Destination file ends up wih 1KB size and just some random chars (file is ANSII encoded, while source file is UTF8.
In the meanwhile I am able to upload a file succesfully using WinSCP.</p>
</div>
<div class="post-text" itemprop="text">
<p>You use FTP active mode:</p>
<pre><code>ftps.set_pasv(False)
</code></pre>
<p>And from your comments, it does not look like you have a good reason to do so.</p>
<p>FTP active mode usually does not work, as it requires the client to be able to accept incoming connections. That's typically not possible without opening a local (both Windows and local network) firewall and/or configuring NAT. Do not even try to use the active mode, unless you have a very specific reason to do so. Use the passive mode. Simply remove the <a href="https://docs.python.org/3/library/ftplib.html#ftplib.FTP.set_pasv" rel="nofollow noreferrer"><code>ftps.set_pasv</code></a> call. The passive mode is the default mode in ftplib.</p>
<p>See my article on <a href="https://winscp.net/eng/docs/ftp_modes" rel="nofollow noreferrer">FTP connection modes</a> for details.</p>
</div>
<div class="post-text" itemprop="text">
<p>It is likely to be a firewall problem. FTP is rather special because it uses a different connection per transfer. The connection that currently works according to your trace is the <em>command</em> connection which is established by the client and targeted to the server FTP port (normally 21).</p>
<p>The data connection is an independant connection. In active mode, it is established by the server, originating from the FTP-DATA port (20) and targetting the port sent by the client in its <code>PORT</code> command. In passive mode, the server sends the port where it will listen for the data connection in its response to the PASV command, and the client try to open a new connection to that (almost random) port.</p>
<p>That means that unless large address ranges are allowed by the firewall, or the firewall software implements special processing to dynamically allow the addresses passed in FTP commands, a firewall can allow the command connection, and then block any data connection.</p>
<p>Refs: </p>
<ul>
<li><a href="https://fr.wikipedia.org/wiki/File_Transfer_Protocol" rel="nofollow noreferrer">File Transfer Protocol on Wikipedia</a></li>
<li><a href="https://tools.ietf.org/html/rfc959" rel="nofollow noreferrer">RFC 959 - File Transfer Protocol</a></li>
</ul>
</div>
<span class="comment-copy">Why are you using <b>active</b> mode? Did you try <b>passive</b>?</span>
<span class="comment-copy">Hi @MartinPrikryl, I didn't try that. I must admit that this is my first approach to FTPS script so I'm a total n00b ;)</span>
<span class="comment-copy">Unfortunately passive mode did not help here :(</span>
<span class="comment-copy">Can you upload the file using any standalone (GUI) FTP client running on the same machine as your Python code? Show us its log file.</span>
<span class="comment-copy">I am able to upload a file using FTPS in WinSCP, log added to the question.</span>
<span class="comment-copy">I do not see any WinSCP log in the question.</span>
<span class="comment-copy">Weird thing. I logged into target FTPS server and the file was uploaded by the script anyway. O_o</span>
