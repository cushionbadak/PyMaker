<div class="post-text" itemprop="text">
<p>I'm using <a href="https://github.com/mkleehammer/pyodbc" rel="nofollow noreferrer"><code>pyodbc</code></a> together with <a href="http://qodbc.com/" rel="nofollow noreferrer"><code>QODBC</code></a> to construct an ODBC query. </p>
<p>I'm having trouble inserting datestamp parameters. Here you can see the escalation starting from the literal version (1) to string-format version (2) to error-state versions. (<strong>Note <code>DateFrom</code> &amp; <code>DateTo</code></strong>):</p>
<ol>
<li><p><code>sql = "sp_report ProfitAndLossStandard show Amount_Title, Text, Label, Amount parameters DateFrom = {d'2018-02-12'}, DateTo = {d'2018-02-18'}, SummarizeColumnsBy='TotalOnly', ReturnRows='All'"</code></p></li>
<li><p><code>sql = "sp_report ProfitAndLossStandard show Amount_Title, Text, Label, Amount parameters DateFrom = %s, DateTo = %s, SummarizeColumnsBy='TotalOnly', ReturnRows='All'" % (q_startdate, q_enddate)</code></p></li>
</ol>
<p>Subsequent attempts with the insertion syntax <code>?</code>, <code>cursor.execute(sql, (q_startdate), (q_enddate))</code> and the variables:</p>
<pre><code>q_startdate = ("{d'%s'}" % dates[0])
q_enddate = ("{d'%s'}" % dates[1])
</code></pre>
<ol start="3">
<li><code>sql = "sp_report ProfitAndLossStandard show Amount_Title, Text, Label, Amount parameters DateFrom = ?, DateTo = ?, SummarizeColumnsBy='TotalOnly', ReturnRows='All'"</code></li>
</ol>
<p><code>&gt;&gt;&gt; ('HY004', '[HY004] [Microsoft][ODBC Driver Manager] SQL data type out of range (0) (SQLBindParameter)')</code></p>
<pre><code>q_startdate = (dates[0])
q_enddate = (dates[1])
</code></pre>
<ol start="4">
<li><code>sql = "sp_report ProfitAndLossStandard show Amount_Title, Text, Label, Amount parameters DateFrom = {d'?'}, DateTo = {d'?'}, SummarizeColumnsBy='TotalOnly', ReturnRows='All'"</code></li>
</ol>
<p><code>&gt;&gt;&gt; ('42000', "[42000] [QODBC] [sql syntax error] Expected lexical element not found: = {d'?'} (11015) (SQLPrepare)")</code></p>
<p>Reading the <code>pyodbc</code> <a href="https://github.com/mkleehammer/pyodbc/wiki/Getting-started#inserting-data" rel="nofollow noreferrer">Wiki page on inserting data</a>, I don't read about any speed bumps with insertion strings. This must have something to do with how pyodbc processes (escapes) the datestamp.</p>
<p>How do you parameterize datestamp--Especially with the <code>qodbc</code> <a href="https://support.flexquarters.com/esupport/index.php?/knowledgebase/article/View/2203/0/qodbc-desktop-how-are-dates-formatted-in-sql-queries-when-using-the-quickbooks-generated-timestamps" rel="nofollow noreferrer">flavor of datestamp</a>.</p>
</div>
<div class="post-text" itemprop="text">
<p>It is almost never necessary to use ODBC escape sequences like <code>{d'2018-02-12'}</code> in a pyodbc parameterized query. If the parameter value is a true Python <a href="https://docs.python.org/3/library/datetime.html#date-objects" rel="nofollow noreferrer">date</a> object </p>
<pre class="lang-python prettyprint-override"><code>q_startdate = date(2018, 2, 12)
</code></pre>
<p>then pyodbc will inform the ODBC driver that the parameter value is a <code>SQL_TYPE_DATE</code> as shown in the ODBC trace log</p>
<pre class="lang-none prettyprint-override"><code>[ODBC][2984][1532535987.825823][SQLBindParameter.c][217]
        Entry:
            Statement = 0x1f1a6b0
            Param Number = 1
            Param Type = 1
            C Type = 91 SQL_C_TYPE_DATE
            SQL Type = 91 SQL_TYPE_DATE
            Col Def = 10
            Scale = 0
            Rgb Value = 0x1f3ac78
            Value Max = 0
            StrLen Or Ind = 0x1f3ac58
</code></pre>
<p>and we can just use a bare parameter placeholder in our SQL command text</p>
<pre class="lang-sql prettyprint-override"><code>... parameters DateFrom = ?, ...
</code></pre>
</div>
<span class="comment-copy">Does your query work if your parameter values are true Python <a href="https://docs.python.org/3/library/datetime.html#date-objects" rel="nofollow noreferrer">date</a> values (e.g., <code>q_startdate = date(2018, 2, 12)</code>) and you simply use <code>... DateFrom = ?</code> ...?</span>
<span class="comment-copy">That works. Thanks. If you want, make that an answer and I'll give you the correct answer points.</span>
