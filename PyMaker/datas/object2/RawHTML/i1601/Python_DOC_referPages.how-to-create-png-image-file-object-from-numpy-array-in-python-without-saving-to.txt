<div class="post-text" itemprop="text">
<p>I need to submit PNG-images to a blackbox server with a http request. I use python3 to generate images in a numpy 64x64x3 array. What I currently do is:</p>
<ol>
<li>Generate image</li>
<li>Save image with scipy.misc.toimage to disk</li>
<li>Open saved image file from disk</li>
<li>Use requests module to send http requests with the image opened image file object in it</li>
</ol>
<p>This works perfectly fine, but I want to get rid of step 2 and 3, so I do not need to save my object to disk first and then load it again. Instead I would like to convert my numpy array in a file-object that is compatible with the http server and send it directly. (Like one you get from open() )</p>
<p>I know it is easy to convert from numpy array to PNG-image with PIL for example, but I only find how to do that combined with saving to disk in one function.</p>
<p>Thank you very much for any help!</p>
<p>This is my code so far:</p>
<pre><code>import numpy as np
import requests
from scipy.misc import toimage

arr = generate64x64x3ImageWithNumpy()
toimage(arr, cmin=0.0, cmax=255.0).save('tmp.png')
d = {'key':API_KEY}
f= {'image': open('tmp.png', 'rb')}
result = requests.post(SERVER_URL, files=f, data=d)
</code></pre>
<p>I want this:</p>
<pre><code>arr = generate64x64x3ImageWithNumpy()

not_on_disk = numpyArrayToPNGImageWithoutSavingOnDisk(arr)

d = {'key':API_KEY}
f = {'image': not_on_disk}
result = requests.post(SERVER_URL, files=f, data=d)
</code></pre>
</div>
<div class="post-text" itemprop="text">
<p>You can use an in memory iostream with savefig (<a href="https://docs.python.org/3/library/io.html#io.BytesIO" rel="nofollow noreferrer">https://docs.python.org/3/library/io.html#io.BytesIO</a>)</p>
<pre><code>import io
tmpFile = io.BytesIO()
savefig(tmpFile, format='png')
</code></pre>
<p>To verify that this worked <code>tmpFile</code> can be compared with the actual file as saved to disk.</p>
<pre><code># Get contents of tmpFile
tmpFile.seek(0)
not_on_disk = tmpFile.read(-1)

# Save to and load from disk
fname = 'tmp.png'
savefig(fname)
on_disk = open(fname, 'rb').read(-1)

&gt;&gt;&gt;not_on_disk == on_disk
True
</code></pre>
<p><strong>Edit</strong> You're looking at using scipy and pil rather than matplotlib but the answer should work the same, including the <code>format</code> keyword for saving.</p>
</div>
<span class="comment-copy">Thank you very much for your fast response! :) But what variable do I need to pass to my http request? Is it tmpFile or not_on_disk? with open(...) I have type _io.BufferedReader, so this is what I want. tmpFile is of type BytesIO and not_on_disk is of type _bytes. Any way to convert? Also if I try to open not_on_disk I get "embedded null byte"-error. If I use PIL to open I get PngImageFile object has no attribute read when I make the request. Sorry for my little understanding.</span>
<span class="comment-copy">It looks like the <code>requests.post</code> takes a file handle, so you would want to pass <code>tmpFile</code> (after calling <code>tmpFile.seek(0)</code> to set the beginning of the file).</span>
