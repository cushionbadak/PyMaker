<div class="post-text" itemprop="text">
<p>My script runs into a recursive loop on Python3, I have tried replacing <code>iteritems</code> with <code>items</code> but it doesn't fix the issue, Python2 runs fine.. is there some change to <code>__getattribute__</code> I am unaware of?</p>
<pre><code>class Map(object):    
    def __init__(self, *args, **kwargs):
        for arg in args:
            if isinstance(arg, dict):
                for k, v in arg.items():
                    self.__dict__[k] = v
                    self.__dict__['_' + k] = v

        if kwargs:
            for k, v in kwargs.items():
                self.__dict__[k] = v
                self.__dict__['_' + k] = v

    def __getattribute__(self, attr):
        if hasattr(self, 'get_' + attr):
            return object.__getattribute__(self, 'get_' + attr)()
        else:
            return object.__getattribute__(self, attr)

    def get(self, key):
        try:
            return self.__dict__.get('get_' + key)()
        except (AttributeError, TypeError):
            return self.__dict__.get(key)


Map(**{'hello': 'world', 'foo': 'bar'})  # infinite recursion
</code></pre>
<p>When run, this produces:</p>
<pre><code>Traceback (most recent call last):
  File "demo.py", line 29, in &lt;module&gt;
    Map(**{'hello': 'world', 'foo': 'bar'})  # recursive loop
  File "demo.py", line 13, in __init__
    self.__dict__[k] = v
  File "demo.py", line 17, in __getattribute__
    if hasattr(self, 'get_' + attr):
  File "demo.py", line 17, in __getattribute__
    if hasattr(self, 'get_' + attr):
[...]
RecursionError: maximum recursion depth exceeded
</code></pre>
</div>
<div class="post-text" itemprop="text">
<p>You have infinite recursion here because your <code>__getattribute__</code> is calling <code>hasattr()</code> which <a href="https://docs.python.org/3/library/functions.html?highlight=hasattr#hasattr" rel="nofollow noreferrer">the documentation</a> states works by calling <code>getattr()</code> (thus calling your class's <code>__getattribute__</code>).</p>
<p>You must not call <code>hasattr()</code> in your <code>__getattribute__</code>.</p>
<p>The <a href="https://docs.python.org/3/reference/datamodel.html?highlight=__getattribute__#object.__getattribute__" rel="nofollow noreferrer">documentation for <code>__getattribute__</code></a> notes this potential for infinite recursion and provides guidance on the solution:</p>
<blockquote>
<p>In order to avoid infinite recursion in this method, its implementation should always call the base class method with the same name to access any attributes it needs, for example, object.<strong>getattribute</strong>(self, name).</p>
</blockquote>
</div>
<span class="comment-copy">Could you supply some test code that reproduces your problem?</span>
<span class="comment-copy">@cdarke it seems hasattr(self, 'get_' + attr): causes the problem in PY3 fixed by using try/except clause with AttributeError instead</span>
