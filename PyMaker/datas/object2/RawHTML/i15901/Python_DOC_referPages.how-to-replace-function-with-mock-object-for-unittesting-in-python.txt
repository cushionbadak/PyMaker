<div class="post-text" itemprop="text">
<p>How do you replace all references to a function with a mock object in Python?</p>
<p>I'm trying to write some unittests for a Fabric script. Specifically, I want to replace <code>fabric.api.run</code> with a mock version that logs the command instead of executing. However, I want to do this in a way so I don't have to rewrite all code that references fabric.</p>
<p>I've tried doing:</p>
<pre><code>import fabric.api
_run = fabric.api.run
fabric.api.run = my_mock_run_function
</code></pre>
<p>but since I can't guarantee this will run before any other modules import fabric.api, a lot of code is still using the real <code>run</code> function.</p>
</div>
<div class="post-text" itemprop="text">
<p>If your code uses:</p>
<pre><code>from fabric.api import run
</code></pre>
<p>you will have to patch the local reference your module has of the run function:</p>
<pre><code>@patch('yourmodule.run')
def test_method(self, run):
    pass
</code></pre>
<p>If your code uses:</p>
<pre><code>import fabric.api
...
api.run(...)
</code></pre>
<p>you will be able to patch the original copy:</p>
<pre><code>@patch('fabric.api.run')
def test_method(self, run):
    pass
</code></pre>
<p>See <a href="http://alexmarandon.com/articles/python_mock_gotchas/" rel="nofollow">this nice explanation</a>.</p>
</div>
<div class="post-text" itemprop="text">
<p>use <a href="https://docs.python.org/3/library/unittest.mock.html#unittest.mock.patch" rel="nofollow"><code>unittest.mock.patch</code></a></p>
<pre><code>import fabric.api
import unittest
from unittest.mock import Mock, patch

class TestCases(unittest.TestCase):
    @patch('fabric.api.run')
    def test_test(self):
        self.assertTrue(True)
</code></pre>
</div>
<span class="comment-copy">Note that <code>mock</code> is a <a href="http://www.voidspace.org.uk/python/mock/index.html" rel="nofollow noreferrer">third-party module</a> prior to Python 3.3. The OP would probably also want <code>new=my_mock_run_function</code> as a keyword argument to <code>patch</code> given the sample code he provided.</span>
<span class="comment-copy">I was able to patch <code>fabric.api</code> using your solution, but the native <code>fabric.api.run</code> function is still called and tries to connect via ssh in the middle of the test. How can I avoid this?</span>
<span class="comment-copy">I have the same problem with <code>fabric.api.local</code>, this solution does not work.</span>
