<div class="post-text" itemprop="text">
<p>I got the following code from <a href="https://stackoverflow.com/questions/4617291/how-do-i-get-a-raw-compiled-sql-query-from-a-sqlalchemy-expression">How do I get a raw, compiled SQL query from a SQLAlchemy expression?</a> and it worked fine until we moved from Python 2.7 to Python 3.4. I've made a few changes though I'm stuck on </p>
<pre><code>return (comp.string.encode(enc) % params).decode(enc)
</code></pre>
<p>with the error unsupported operand type(s) for %: 'bytes' and 'dict'</p>
<pre><code>def compile_query(query):
    dialect = query.session.bind.dialect
    statement = query.statement
    comp = compiler.SQLCompiler(dialect, statement)
    comp.compile()
    enc = dialect.encoding
    params = {}
    for k,v in comp.params.iteritems():
        if isinstance(v, unicode):
            v = v.encode(enc)
        params[k] = sqlescape(v)
    return (comp.string.encode(enc) % params).decode(enc)
</code></pre>
</div>
<div class="post-text" itemprop="text">
<p>Thanks to the comments, I ported it to python 3</p>
<pre><code>def compile_query(query):
    dialect = query.session.bind.dialect
    statement = query.statement
    comp = compiler.SQLCompiler(dialect, statement)
    comp.compile()
    enc = dialect.encoding
    params = {}
    for k,v in comp.params.items():
        if isinstance(v, str):
            v = v.encode(enc)
        params[k] = sqlescape(v)
    return (comp.string % params)
</code></pre>
</div>
<span class="comment-copy">In Python 2, strings were ASCII but in Python 3, they're Unicode. As a consequence, you shouldn't need to do manual encode() and decode() in most cases. More info on Python 3 Unicode support here: <a href="https://docs.python.org/3/howto/unicode.html" rel="nofollow noreferrer">docs.python.org/3/howto/unicode.html</a></span>
<span class="comment-copy">@dylrei This did it thank you</span>
