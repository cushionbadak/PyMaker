<div class="post-text" itemprop="text">
<p>Lets say you wrote a C++ (or C) extension to python, called <code>module</code>. It returns an array of arrays. What should  the returned array, and its arrays, have as reference counts?</p>
<p>The python code would be something like</p>
<pre><code>import my_module
from sys import getrefcount as g      # will use to check reference count

def use_module():
   x = my_module.func()
   print 'x =', x
   print 'g(x) =', g(x)
   print 'g(x[0]) =', g(x[0])
   test = 'some random thing'
   print 'should be', g(test), '?'

use_module()
&gt;&gt;&gt; x = ( (1,2,3,4) , [2,3] , {'one':1} )
&gt;&gt;&gt; g(x) = 3
&gt;&gt;&gt; g(x[0]) = 3
&gt;&gt;&gt; should be 2 ?
</code></pre>
<p>I would expect <code>g(x)</code> to be <code>2</code>, not <code>3</code>. (after adding one for <code>g</code> to reference <code>x</code>)</p>
<p>In my C++ extension, I have made sure that the array and all its sub-collections and their elements have reference counts of <code>1</code> before being returned to python, so I'm not sure how it shot up to <code>3</code> so quickly? Perhaps returned <code>PyObject*</code>'s should have <code>0</code> as its reference count?</p>
<p>Edit: sorry, I'm an idiot. I was making another reference without knowing it.</p>
</div>
<div class="post-text" itemprop="text">
<p>If no other references to the returned object exist, the refcount should be 1. If the refcount were 0, the object would get deallocated.</p>
</div>
<span class="comment-copy">To be clearer, <a href="https://docs.python.org/3/c-api/intro.html#reference-count-details" rel="nofollow noreferrer">docs.python.org/3/c-api/intro.html#reference-count-details</a> tells exactly when the refcount stuff has to happen, i. e. it tells about reference receiving, borrowing, stealing etc.</span>
