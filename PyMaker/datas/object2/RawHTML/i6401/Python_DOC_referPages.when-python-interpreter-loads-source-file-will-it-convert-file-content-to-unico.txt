<div class="post-text" itemprop="text">
<p>Say, I have a source file encoded in utf8, when python interpreter loads that source file, will it convert file content to unicode in memory and then try to evaluate source code in unicode?</p>
<p>If I have a string with non ASCII char in it, like</p>
<blockquote>
<p>astring = '中文'</p>
</blockquote>
<p>and the file is encoded in gbk.</p>
<p>Running that file with python 2, I found that string actually is still in raw gbk bytes. </p>
<p>So I dboubt, python 2 interpret does not convert source code to unicode. Beacause if so, the string content will be in unicode(I heard it is actually UTF16)</p>
<p>Is that right? And if so, how about python 3 interpreter? Does it convert source code to unicode format?</p>
<p>Acutally, I know how to define unicode and raw string in both Python2 and 3. </p>
<p>I'm just curious about one detail when the interpreter loads source code.  </p>
<p>Will it convert the WHOLE raw source code (encoded bytes) to unicode at very beginning and then try to interpret unicode format source code piece by piece? </p>
<p>Or instead, it just loads raw source piece by piece, and only decodes what it think should. For example,  when it hits the statement u'中文'  , OK, decode to unicode. While it hits statment  b'中文', OK, no need to decode.  </p>
<p>Which way the interpreter will go?</p>
</div>
<div class="post-text" itemprop="text">
<p>If your source file is encoded with GBK, put this line at the top of the file (first or second line):</p>
<pre><code># coding: gbk
</code></pre>
<p>This is required for both Python 2 and 3.
If you omit this encoding declaration, the interpreter will assume ASCII in the case of Python 2, and UTF-8 for Python 3.</p>
<p>The encoding declaration controls how the interpreter reads the bytes of the source file. This is mainly relevant for string literals (like in your example), but theoretically also applies to comments and even identifiers (it's probably not a good idea to use non-ASCII in identifiers, though).</p>
<p>As for the question whether you get byte strings or unicode strings: this depends on the syntax, not on the choice and declaration of encoding.
As pointed out in Ignacio's answer, if you want to have unicode strings in Python 2, you need to use the <code>u'...'</code> notation.</p>
<p>In Python 3, the <code>u</code> prefix is optional.
So, with a correct encoding declaration in the file header, it is sufficient to write <code>astring = '中文'</code> to get a correct unicode string in Python 3.</p>
<h3>Update</h3>
<p>By comment, the OP asks about the interpretation of <code>b'中文'</code>.
In Python 3, this isn't allowed (byte strings can only contain ASCII characters), but you can test this yourself in Python 2.x:</p>
<pre><code># coding: gbk
x = b'中文'
y = u'中文'
print repr(x)
print repr(y)
</code></pre>
<p>This will produce:</p>
<pre><code>'\xd6\xd0\xce\xc4'
u'\u4e2d\u6587'
</code></pre>
<p>The first line reflects the actual bytes contained in the source file (if you saved it with GBK, of course).
So there seems to be no decoding happening for b'中文'.</p>
<p>However, I don't know how the interpreter internally represents the source code with respect to encoding (that seems to be your question).
This is implementation-dependent anyway, so the answer might even be different for cPython, Jython, IronPython etc.</p>
</div>
<div class="post-text" itemprop="text">
<blockquote>
<p>So I dboubt, python 2 interpret does not convert source code to unicode.</p>
</blockquote>
<p>It never does. If you want to use Unicode rather than bytes then you need to use a <code>unicode</code> instead.</p>
<pre><code>astring = u'中文'
</code></pre>
</div>
<div class="post-text" itemprop="text">
<p><del>Python source is only plain ASCII, meaning that</del> the actual encoding does not matter <em>except for</em> litteral strings, be them unicode strings or byte strings. Identifiers can use non ascii characters (IMHO it would be a very bad practice), but their meaning is normally internal to the Python interpreter, so the way it reads them is not really important</p>
<p>Byte strings are always left unchanged. That means that normal strings in Python 2 and byte litteral strings in Python 3 are never converted.</p>
<p>Unicode strings are always converted:</p>
<ul>
<li>if the special string <code>coding: charset_name</code> exists in a comment on first or second line, the original byte string is converted as it would be with <code>decode(charset_name)</code></li>
<li>if not encoding is specified, Python 2 will assume ASCII and Python 3 will assume utf8</li>
</ul>
</div>
<span class="comment-copy">See <a href="https://docs.python.org/2/howto/unicode.html#unicode-literals-in-python-source-code" rel="nofollow noreferrer">docs.python.org/2/howto/…</a> (python2) and <a href="https://docs.python.org/3/howto/unicode.html#unicode-literals-in-python-source-code" rel="nofollow noreferrer">docs.python.org/3/howto/…</a> (python3)</span>
<span class="comment-copy">thanks.  Acutally, I know how to define unicode and raw string in both Python2 and 3.  I'm just curious about one detail when the interpreter load  source code.  will it convert WHOLE raw source code (encoded bytes) to unicode at very beginning and then try to interpret it line by line? Or instead, it just loads a piece of raw source, and only decodes what it think needed. For example,  when it hits statement u'中文'  , OK, decode to unicode, while it hit statment  b'中文', OK, no need to decode.  Which way, the interpreter will go?</span>
<span class="comment-copy">@jcyrss maybe have a look at <a href="https://mail.python.org/pipermail/python-dev/2015-November/142159.html" rel="nofollow noreferrer">this conversation on the Python-Dev mailing list</a>. It might give you an idea how the Python interpreter deals with source encoding. (I think I read somewhere there that all code is decoded before being passed to the tokenizer, which means that byte-string literals need to be re-encoded – contradicting what I claimed in my answer.)</span>
<span class="comment-copy">python3 interpreter does not do that converting, either?</span>
<span class="comment-copy">Well, you're allowed to use non-ASCII letters in identifiers. I'm not saying it's a good idea to do that, but I think you can't officially say Python source is "only plain ASCII", can you?</span>
<span class="comment-copy">@lenz You are right. It hurts so much my mind that I could not think of non ascii characters in identifiers but it is legal Python. Sigh... I'll change my answer in a while.</span>
<span class="comment-copy">It looks like you think the interpret go the second way in my question, right?</span>
