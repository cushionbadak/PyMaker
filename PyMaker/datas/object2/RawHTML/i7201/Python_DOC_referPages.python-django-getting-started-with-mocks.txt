<div class="post-text" itemprop="text">
<p>I have the following code that I'm attempting to create a test (still work in progress):</p>
<pre><code>from core.tests import BaseTestCase                                                                          
from core.views import get_request                                                                           

from entidades.forms import InstituicaoForm                                                                  
from mock import patch                                                                                       


class InstituicaoFormTestCase(BaseTestCase):                                                                 

    def setUp(self):                                                                                         
        super(InstituicaoFormTestCase, self).setUp()                                                         

    @patch('get_request', return_value={'user': 'usuario_qualquer'})                                         
    def test_salva_instituicao_quando_informaram_convenio():                                                    
        import pdb                                                                                              
        pdb.set_trace()                                                                                         
        form = InstituicaoForm()
</code></pre>
<p>it fails because when I try to create a InstituicaoForm, a get_request is called:</p>
<pre><code>def get_request():
    return getattr(THREAD_LOCAL, 'request', None)
</code></pre>
<p>and it trows this error</p>
<pre><code>entidades/tests.py:11: in &lt;module&gt;
    class InstituicaoFormTestCase(BaseTestCase):
entidades/tests.py:16: in InstituicaoFormTestCase
    @patch('get_request', return_value={'user': 'usuario_qualquer'})
.tox/unit/local/lib/python2.7/site-packages/mock/mock.py:1670: in patch
    getter, attribute = _get_target(target)
.tox/unit/local/lib/python2.7/site-packages/mock/mock.py:1522: in _get_target
    (target,))
E   TypeError: Need a valid target to patch. You supplied: 'get_request'
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; entering PDB &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;
&gt; /home/vinicius/telessaude/.tox/unit/local/lib/python2.7/site-packages/mock/mock.py(1522)_get_target()
-&gt; (target,))
</code></pre>
<p>What am I doing wrong? How should mock this get_request() method?</p>
</div>
<div class="post-text" itemprop="text">
<p>I think the specific thing you're trying to do can be done like this:</p>
<pre><code>@patch('core.views.get_request', return_value={'user': 'usuario_qualquer'})
</code></pre>
<p>But you should also look at the <a href="https://docs.djangoproject.com/en/1.11/topics/testing/" rel="nofollow noreferrer">Django testing documentation</a>, if you haven't already. You can use the testing client to fake the web request.</p>
<p>If you want to experiment with mock tests that don't access a database, check out <a href="https://github.com/stphivos/django-mock-queries" rel="nofollow noreferrer">Django Mock Queries</a>. (I'm a small contributor to that project.) I've also tried mocking views, but it's fiddly.</p>
</div>
<span class="comment-copy">See the mock docs on <a href="https://docs.python.org/3/library/unittest.mock.html#where-to-patch" rel="nofollow noreferrer">where to patch</a>. Note that using threadlocals is generally considered a bad idea, and there is rarely a need to do so in Django code.</span>
