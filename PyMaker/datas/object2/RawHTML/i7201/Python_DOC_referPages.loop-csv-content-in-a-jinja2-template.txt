<div class="post-text" itemprop="text">
<p>i am trying to build an output based on a jinj2 template using a csv as input. I've search through and couldnt find much information to build a solution. </p>
<p>So far i have the following code:</p>
<pre><code>import sys, os
import jinja2
import csv

in_file="csv_file.csv"
jinja_template = "test.j2"
env = jinja2.Environment(loader=jinja2.FileSystemLoader(searchpath="."))

with open(in_file, "rb") as FD:
    reader = csv.DictReader(FD)
    for vals in reader:
        gen_template = env.get_template(jinja_template)
        output = gen_template.render(vals)
        print output
</code></pre>
<p>My csv file looks like this:</p>
<pre><code>country,city
UK,London
UK,Manchester
UK,Liverpool
US,Chicago
US,Denver
US,Atlanta
</code></pre>
<p>And my jinja2 template looks like this:</p>
<pre><code>country: {{country}} has cities {{city}}
</code></pre>
<p>Following is the output i am trying to achieve:</p>
<pre><code>country: UK has cities: London, Manchester, Liverpool
country: US has cities: Chicago, Denver, Atlanta
</code></pre>
<p>I believe i need to run for loop within the j2 template in order to build the city names next to the country.</p>
<p>When i run the code above i actually get the individual country &lt;&gt; city names as seperately like this:</p>
<pre><code>country: UK has cities London
country: UK has cities Manchester
country: UK has cities Liverpool
country: US has cities Chicago
country: US has cities Denver
country: US has cities Atlanta
</code></pre>
<p>Appreciate if someone can provide some pointers on how i can achieve this.</p>
</div>
<div class="post-text" itemprop="text">
<p>assuming your input csv is sorted by country, <a href="https://docs.python.org/3/library/itertools.html?#itertools.groupby" rel="nofollow noreferrer"><code>itertools.groupby</code></a> can help:</p>
<pre><code>from io import StringIO
from jinja2 import Template
from itertools import groupby
from operator import itemgetter
from csv import DictReader


csv_data = '''country,city
UK,London
UK,Manchester
UK,Liverpool
US,Chicago
US,Denver
US,Atlanta
'''

tmpl = 'country: {{country}} has cities {{cities}}'
template = Template(tmpl)

with StringIO(csv_data) as file:
    rows = DictReader(file)
    for country, groups in groupby(rows, key=itemgetter('country')):
        cities = ', '.join(row['city'] for row in groups)
        output = template.render(country=country, cities=cities)
        print(output)
</code></pre>
<p>which prints</p>
<pre><code>country: UK has cities London, Manchester, Liverpool
country: US has cities Chicago, Denver, Atlanta
</code></pre>
<hr/>
<p>if you prefer to do the <code>join</code> inside jinja, this is an option:</p>
<pre><code>tmpl = 'country: {{country}} has cities {{cities | join(", ")}}'
template = Template(tmpl)

with StringIO(csv_data) as file:
    rows = DictReader(file)
    for country, groups in groupby(rows, key=itemgetter('country')):
        cities = (row['city'] for row in groups)
        output = template.render(country=country, cities=cities)
</code></pre>
<hr/>
<p>if you need to be able to append a header, you need to collect all the data from your file first (done here using an OrderedDict):</p>
<pre><code>from collections import OrderedDict

tmpl = '''Countries and cities:
{%-for country, cities in grouped.items()%}
country: {{coutry}} has cities {{cities | join(", ")}}
{%-endfor%}'''
template = Template(tmpl)

with StringIO(csv_data) as file:
    rows = DictReader(file)
    grouped = OrderedDict()
    for country, groups in groupby(rows, key=itemgetter('country')):
        grouped[country] = [item['city'] for item in groups]
    output = template.render(grouped=grouped)
    print(output)
</code></pre>
<p>which then yields:</p>
<pre><code>Countries and cities:
country:  has cities London, Manchester, Liverpool
country:  has cities Chicago, Denver, Atlanta
</code></pre>
</div>
<span class="comment-copy">looks great, i am gonna read more about itertools. One question though, if i add another piece of text say even a heading to the template file it actually will print as many times as we have contents in csv file. How can i prevent that</span>
<span class="comment-copy">this is how it looks like if i add a heading in the template file:   <code>This is the heading of the file:</code> <code>country: UK has cities: London, Manchester, Liverpool</code> <code>This is the heading of the file:</code> <code>country: US has cities: Chicago, Denver, Atlanta</code></span>
<span class="comment-copy">ok, tried something. hope that is what you need...</span>
<span class="comment-copy">this is very nice. thank you. I have one question, i am interested about the itertool and its grouping features.  for example will the grouping also works with multiple columns,  so for example if i had a csv file that has data like this:  <code>country_a, city_a,country_b,city_b</code>  Would i be able to group say country_a in one iteration and country_b in one iteration?</span>
<span class="comment-copy">that depends on what you want in the end... you are pretty free what you use as <code>key</code> in <code>groupby</code>. any function can be used. without the actual data and an example of what you want it's hard to tell...</span>
