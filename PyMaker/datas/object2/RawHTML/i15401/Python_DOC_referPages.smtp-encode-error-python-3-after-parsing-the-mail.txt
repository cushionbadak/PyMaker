<div class="post-text" itemprop="text">
<p>First: I've read these:</p>
<ul>
<li><a href="https://stackoverflow.com/questions/8329741/issue-with-smtplib-sending-mail-with-unicode-characters-in-python-3-1">Issue with smtplib sending mail with unicode characters in Python 3.1</a></li>
<li><a href="https://stackoverflow.com/questions/5910104/python-how-to-send-utf-8-e-mail">Python - How to send utf-8 e-mail?</a></li>
<li><a href="https://stackoverflow.com/questions/1429147/python-3-smtplib-send-with-unicode-characters">Python 3 smtplib send with unicode characters</a></li>
</ul>
<p>Now after reading these I know how to create and send utf8 mails. But I want to forward mails. My (simplified) code looks like this:</p>
<pre><code>msg = email.parser.Parser().parse(sys.stdin)
# I also tried reading from a file, makes no difference
# left out some code adding ascii-only headers to the mail
with smtplib.SMTP(conf.smtp_server, conf.smtp_port) as s:
    s.starttls()
    s.ehlo()
    s.login(conf.smtp_user, conf.smtp_password)
    s.send_message(msg, conf.smtp_srcadr, destinations)
</code></pre>
<p>What I get is this:</p>
<pre><code>File "./mailer.py", line 38, in send_mail
s.send_message(msg, conf.smtp_srcadr, destinations)
  File "/package/host/localhost/python-3.3/lib/python3.3/smtplib.py", line 822, in send_message
    g.flatten(msg_copy, linesep='\r\n')
  File "/package/host/localhost/python-3.3/lib/python3.3/email/generator.py", line 112, in flatten
    self._write(msg)
  File "/package/host/localhost/python-3.3/lib/python3.3/email/generator.py", line 164, in _write
    self._dispatch(msg)
  File "/package/host/localhost/python-3.3/lib/python3.3/email/generator.py", line 190, in _dispatch
    meth(msg)
  File "/package/host/localhost/python-3.3/lib/python3.3/email/generator.py", line 407, in _handle_text
    super(BytesGenerator,self)._handle_text(msg)
  File "/package/host/localhost/python-3.3/lib/python3.3/email/generator.py", line 220, in _handle_text
    self.write(payload)
  File "/package/host/localhost/python-3.3/lib/python3.3/email/generator.py", line 381, in write
    self._fp.write(s.encode('ascii', 'surrogateescape'))
UnicodeEncodeError: 'ascii' codec can't encode characters in position 505-506: ordinal not in range(128)
</code></pre>
<p>My problem is: I don't know how the input mail is structured. I can't just encode it correctly. I would have to be prepared for all kinds of multipart possibilities. Any ideas?</p>
<p>Note:</p>
<pre><code>msg.as_string()
</code></pre>
<p>works fine and includes the unicode characters as expected.</p>
</div>
<div class="post-text" itemprop="text">
<p>Okay. I found a hacky solution:
Instead of the email.Message-based <code>send_message</code> I use the bytes-based <code>sendmail</code>.</p>
<pre><code>s.sendmail(conf.smtp_srcadr, destinations, msg.as_string().encode('utf-8'))
</code></pre>
<p>I would really prefer a solution based on a <a href="https://docs.python.org/3/library/email.generator.html" rel="nofollow" title="email.generator pydoc">(Bytes-)Generator</a> or other email tools from the Python standard library.</p>
</div>
<span class="comment-copy">related: <a href="http://stackoverflow.com/a/9274387/4279">How can I send email using Python?</a> provides code example that shows how to send e-mail with non-ascii characters on both Python 2 and 3. Here's another <a href="http://stackoverflow.com/a/20787826/4279">Unicode-email code example</a></span>
