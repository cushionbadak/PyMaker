<div class="post-text" itemprop="text">
<pre><code>#!/usr/bin/env python
# encoding: utf-8

import re
import subprocess
import time
import json


def get_temperatures(disks):
    sensors = subprocess.check_output(["sensors"])
    temperatures = {match[0]: float(match[1]) for match in re.findall("^(.*?)\:\s+\+?(.*?)°C", 
                                            sensors, re.MULTILINE)}
    for disk in disks:
        output = subprocess.check_output(["smartctl", "-A", disk])
        temperatures[disk] = int(re.search("Temperature.*\s(\d+)\s*(?:\([\d\s]*\)|)$", 
                                            output, re.MULTILINE).group(1))
    return temperatures


def main():
    while True:
        print json.dumps(get_temperatures(("/dev/sda2", "/dev/sdb1")))
        time.sleep(20)


if __name__ == '__main__':
    main()
</code></pre>
<p>This is small script to monitor temperatures in Python, using smartmontools and lm-sensors. But when i try to run it i have a error</p>
<pre><code>subprocess.CalledProcessError: Command '['smartctl', '-A', '/dev/sda2']' returned non-zero exit status 2
</code></pre>
<p>But when i try this command manually in terminal they work great.</p>
<p>Some info: </p>
<pre><code>uname -a 
</code></pre>
<p>Linux LME 4.0.0-040000-generic #201504121935 SMP Sun Apr 12 23:36:33 UTC 2015 x86_64 x86_64 x86_64 GNU/Linux</p>
</div>
<div class="post-text" itemprop="text">
<p>A <code>CalledProcessError</code> will be raised if any non-zero exit code is returned by your called process.  On the command line, you should <code>echo $?</code> to get the last return code and see if it really does return 2.  I suspect it will.</p>
<p>If that is okay in your python code, you can except the <code>CalledProcessError</code> and get any information from within its attributes especially the <code>output</code> attribute. (Look up this error in the <a href="https://docs.python.org/3/library/subprocess.html" rel="nofollow noreferrer">python docs</a> for more information.)</p>
<p>Example:</p>
<pre><code>import subprocess
output = None
try:
    output = subprocess.check_output(["smartctl", "-A", "/dev/sda2"])
except subprocess.CalledProcessError as e:
    output = e.output
</code></pre>
</div>
<div class="post-text" itemprop="text">
<p>Return code of 2 from <code>smartctl</code> means it failed to open the device.  Make sure that the user who is running the Python code has permission to open all of the disks you want it to check.</p>
<p>From the RETURN VALUES section of smartctl's man page:</p>
<blockquote>
<p>Bit 1: Device open failed, or device did not return an IDENTIFY  DEVICE structure</p>
</blockquote>
<p>So I suspect this is really a permissions problem.  I verified this on my system.  If I run <code>subprocess.check_output( [ 'smartctl', '-A', '/dev/sda2' ] )</code> I get the error with it returning 2, but if I run <code>subprocess.check_output( [ 'sudo', 'smartctl', '-A', '/dev/sda2' ] )</code> it works and I see the output of the command.</p>
</div>
<span class="comment-copy">What do you mean "they work great?"  What is their exit code when they return?</span>
<span class="comment-copy">if i type smartctl -A /dev/sda in terminal, this work perfectly</span>
<span class="comment-copy">And if you run <code>echo $?</code> right after, does it print <code>0</code>?</span>
<span class="comment-copy">Yes, just 0, you have any idea?</span>
<span class="comment-copy">Are you running both as the same user?  Perhaps the user running the Python does not have permission to open /dev/sda2?</span>
<span class="comment-copy">➜  ~  echo $?                       1 I change code like you say and now i have     AttributeError: 'NoneType' object has no attribute 'group'</span>
<span class="comment-copy">Interesting that you are getting different return values.  Regardless, your <code>NoneType</code> error is almost certainly from getting a return value of <code>None</code> from your <code>re.search()</code> call, which might not be within the scope of this question anymore.</span>
<span class="comment-copy">See: <a href="https://docs.python.org/3.4/library/re.html#re.search" rel="nofollow noreferrer">docs.python.org/3.4/library/re.html#re.search</a></span>
<span class="comment-copy">@DavidArenburg Nice catch. Fixed.</span>
<span class="comment-copy">Now after running AttributeError: 'NoneType' object has no attribute 'group'</span>
<span class="comment-copy">That suggests that you are now getting output, but your regex is not matching anything.</span>
<span class="comment-copy">I noticed a couple of things about the regex that you might want to look at.  After Temperature.* you just look for <code>\s</code> but you might want to look for <code>\s+</code>.  After that, you'll have to compare to your own output, because I don't have any lines that have only digits and spaces followed by a close <code>)</code> and a <code>|</code> at the end of the line, in fact, <code>smartctl -A</code> for me doesn't have any <code>|</code>s at all, nor any parens.</span>
<span class="comment-copy">You'll have to be using sudo on this python script to begin with, right?  (Great answer btw. +1)</span>
<span class="comment-copy">You could conceivably use sudo inside the script, but if so you would probably want to set it up so the user running it does not require a password to execute the smartctl command.</span>
