<div class="post-text" itemprop="text">
<p>After a few days of search and trying to use pytz and other tools, I am unable to find a solution. </p>
<p>When a user creates a Medication print-out list in GNU Health an error is given:                     </p>
<pre><code>====== ERROR=======================                 
Traceback (most recent call last):
File "/trytond/protocols/jsonrpc.py", line 150, in _marshaled_dispatch
 response['result'] = dispatch_method(method, params)
 File "/trytond/protocols/jsonrpc.py", line 179, in _dispatch
res = dispatch(*args)
File "/trytond/protocols/dispatcher.py", line 161, in dispatch
result = rpc.result(meth(*c_args, **c_kwargs))
 File "/trytond/report/report.py", line 144, in execute
type, data = cls.parse(action_report, records, data, {})
File "/trytond/modules/health/report/health_report.py", line 62, in            parse
localcontext['print_date'] = get_print_date()
File "/trytond/modules/health/report/health_report.py", line 42, in get_print_date
return datetime.astimezone((dt.replace(tzinfo=None))
TypeError: astimezone() argument 1 must be datetime.tzinfo, not None                  
============END================= 
</code></pre>
<p>I am not sure how to rectify this issue</p>
</div>
<div class="post-text" itemprop="text">
<p>Here's <a href="http://hg.savannah.gnu.org/hgweb/health/file/cd2e0a905425/tryton/health/report/health_report.py" rel="nofollow">the current code for <code>get_print_date()</code></a>:</p>
<pre><code>def get_print_date():
    Company = Pool().get('company.company')

    timezone = None
    company_id = Transaction().context.get('company')
    if company_id:
        company = Company(company_id)
        if company.timezone:
            timezone = pytz.timezone(company.timezone)

    dt = datetime.now()
    return datetime.astimezone(dt.replace(tzinfo=pytz.utc), timezone)
</code></pre>
<p>It seems it tries (incorrectly unless <code>TZ=UTC</code> -- you should submit a bug report) to do the following:</p>
<pre><code>import tzlocal # $ pip install tzlocal

def get_print_date():
    Company = Pool().get('company.company')
    company_id = Transaction().context.get('company')
    company = company_id and Company(company_id)
    timezone = company and company.timezone and pytz.timezone(company.timezone)
    return datetime.now(timezone or tzlocal.get_localzone())
</code></pre>
<p>i.e., it either returns the current time in the <code>company</code>'s timezone or in your local timezone.</p>
</div>
<div class="post-text" itemprop="text">
<p>Have you set up your institution / company timezone ?</p>
<p>You can check / set  your company timezone in  Party -&gt; Configuration -&gt; Companies -&gt; Timezone </p>
</div>
<span class="comment-copy">what is <code>datetime.astimezone((dt.replace(tzinfo=None))</code> supposed to be doing?</span>
<span class="comment-copy">@PadraicCunningham: I would understand if it were to raise: <code>ValueError: astimezone() cannot be applied to a naive datetime</code> then it it would be equivalent to <code>dt.replace(tzinfo=None).astimezone()</code> but <code>TypeError</code> suggests  <code>datetime.now(timezone.utc).astimezone(tz=None)</code>like code (before Python 3.3+ where empty argument is interperted as a local timezone: <a href="https://docs.python.org/3/library/datetime.html#datetime.datetime.astimezone" rel="nofollow noreferrer"><code>.astimezone(tz)</code>: <i>Changed in version 3.3: tz now can be omitted</i></a>. Anyway, it is a bad style to use <code>klass.method(obj, *args)</code> instead of <code>obj.method(*args)</code>.</span>
<span class="comment-copy">This makes sense, I could not follow what was happening at all in the traceback.</span>
