<div class="post-text" itemprop="text">
<p>I have a ANPR (automated number plate reading) system. Essentially a few cameras configured. These make HTTP POSTs to locations we configure. Our cocktail of problems are such:</p>
<ul>
<li>Our script needs to send this data onto multiple, occasionally slow places.</li>
<li>The camera locks up while it's POSTing.</li>
</ul>
<p>So if my script takes 15 seconds to complete —it can— we might miss a read.</p>
<p>Here's the cut down version of my script at the moment. Apologies for the 3.4 syntax, we've got some old machines on site.</p>
<pre><code>@asyncio.coroutine
def handle_plate_read(request):
    post_data = yield from request.post()
    print(post_data)

    # slow stuff!

    return web.Response()

app = web.Application()
app.router.add_post('/', handle_plate_read)
web.run_app(app, port=LISTEN_PORT)
</code></pre>
<p>This is functional but can I push back the 200 to the camera early (and disconnect it) and carry on processing the data, or otherwise easily defer that step until after the camera connection is handled?</p>
</div>
<div class="post-text" itemprop="text">
<p>If I understood your question correctly, you can of course carry on processing the data right after response or deffer it to process even later.</p>
<p>Here's how simple solution can look like:</p>
<ol>
<li><p>Instead of doing slow stuff before response, add data needed to
do it to some <a href="https://docs.python.org/3/library/asyncio-queue.html#asyncio.Queue" rel="nofollow noreferrer">Queue</a> with unlimited size and return response
imideately.</p></li>
<li><p>Run some <a href="https://docs.python.org/3/library/asyncio-task.html#task" rel="nofollow noreferrer">Task</a> in background to process slow job that would
grab data from queue. Task itself runs parallely with other
coroutines and doesn't block them. (<a href="https://stackoverflow.com/a/37345564/1113207">more info</a>)</p></li>
<li><p>Since "slow stuff" is probably something CPU-related, you would
need to use <a href="https://docs.python.org/3/library/asyncio-eventloop.html#executor" rel="nofollow noreferrer">run_in_executor</a> with <code>ProcessPoolExecutor</code> to do
slow stuff in other process(es). (<a href="https://stackoverflow.com/a/44488915/1113207">more info</a>)</p></li>
</ol>
<p>This should work in basic case.</p>
<p>But you should also think over how will it work under heavy load. For example if you grab data for slow stuff quicky, but process it much slower your queue will grow and you'll run out of RAM. </p>
<p>In that case it makes sense to store your data in DB other then in queue (you would probably need to create separate task to store your data in DB without blocking response). <code>asyncio</code> has drivers for many DB, <a href="https://github.com/MagicStack/asyncpg" rel="nofollow noreferrer">for example</a>. </p>
</div>
