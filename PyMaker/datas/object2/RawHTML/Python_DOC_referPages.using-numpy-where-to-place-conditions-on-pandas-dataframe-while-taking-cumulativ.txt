<div class="post-text" itemprop="text">
<p>I am trying to place a condition on one of the columns in Pandas Dataframe and based on that condition I want to take cumulative sum of another column in the Dataframe. To be more clear here is the example: Suppose my DataFrame <code>df</code> as:</p>
<pre><code>+-----------+--------------+-----+-------------+
|   Date    | daily_return | dir | size_return |
+-----------+--------------+-----+-------------+
| 2/25/2015 |    -0.000681 |  -1 |   -0.000681 |
| 2/26/2015 |      -0.0015 |  -1 |    -0.00218 |
| 2/27/2015 |    -0.003022 |  -1 |   -0.005203 |
| 3/2/2015  |     0.005776 |   1 |    0.005776 |
| 3/3/2015  |    -0.003772 |  -1 |   -0.003772 |
| 3/4/2015  |     -0.00436 |  -1 |    -0.00755 |
+-----------+--------------+-----+-------------+
</code></pre>
<p>I've placed a condition on the column <code>dir</code> as long as the value in <code>dir</code> is equal to <code>dir.shift(1)</code> I want to take cumulative sum of column <code>daily_return</code> until <code>dir</code> is not equal <code>dir.shift(1)</code> and when they are not equal I want <code>daily_return</code> equal to <code>size_return</code>.
The code that I used to generate the above table is as follows:</p>
<pre><code>df['size_return'] = np.where(df.dir == df.dir.shift(1), 
                             df.daily_return.cumsum(axis=0), df.daily_return)
</code></pre>
<p><strong>The problem with the above table is that I can't figure out why in the last two rows if I sum using above line of code <code>daily_return</code> the result is <code>-0.00755</code>, I should be getting <code>-0.00813</code> (<code>-0.003772 + -0.00436</code>).</strong></p>
<p>There must be an error in my logic written in above code, I can't figure out my mistake?</p>
<p>Second, I do not want value in every row of <code>size_return</code> only last row of filtered data frame based on the condition. To be more clear this is how the final table should be looking:</p>
<pre><code>+-----------+--------------+-----+-------------+
|   Date    | daily_return | dir | size_return |
+-----------+--------------+-----+-------------+
| 2/25/2015 |    -0.000681 |  -1 |             |
| 2/26/2015 |      -0.0015 |  -1 |             |
| 2/27/2015 |    -0.003022 |  -1 |   -0.005203 |
| 3/2/2015  |     0.005776 |   1 |    0.005776 |
| 3/3/2015  |    -0.003772 |  -1 |             |
| 3/4/2015  |     -0.00436 |  -1 |   -0.008132 |
+-----------+--------------+-----+-------------+
</code></pre>
</div>
<div class="post-text" itemprop="text">
<p>Check with <code>groupby</code> and <code>cumsum</code> </p>
<pre><code>df.groupby((df.dir==df.dir.shift()).eq(0).cumsum()).daily_return.cumsum()
0   -0.000681
1   -0.002181
2   -0.005203
3    0.005776
4   -0.003772
5   -0.008132
Name: daily_return, dtype: float64
</code></pre>
<p>If only keep the last one ,using <code>duplicated</code> </p>
<pre><code>s=(df.dir==df.dir.shift()).eq(0).cumsum()
df['New']=df.groupby(s).daily_return.cumsum().mask(s.duplicated(keep='last'),'')
df
        Date  daily_return  dir  size_return       New
0  2/25/2015     -0.000681   -1    -0.000681          
1  2/26/2015     -0.001500   -1    -0.002180          
2  2/27/2015     -0.003022   -1    -0.005203 -0.005203
3   3/2/2015      0.005776    1     0.005776  0.005776
4   3/3/2015     -0.003772   -1    -0.003772          
5   3/4/2015     -0.004360   -1    -0.007550 -0.008132
</code></pre>
</div>
<span class="comment-copy">The <code>cumsum</code> argument is evaluated (in full) before being passed to the <code>where</code>.  Remember this is python, not some custom language.</span>
