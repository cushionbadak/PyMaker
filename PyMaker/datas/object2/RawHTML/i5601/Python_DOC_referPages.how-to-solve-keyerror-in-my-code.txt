<div class="post-text" itemprop="text">
<p>I have the following code piece:</p>
<pre><code>weights = [0.1, 0.2]

ranks = {}
for product,Rank in myDictionary1.items():
    ranks[product] = {}
    for p2,score2 in Rank:
        p2 = int(p2)
        product = int(product)
        if product!=p2:
            ranks[product][p2] = score2*weights[0]
for product,Rank in myDictionary2.items():
    for p2,score2 in Rank:
        p2 = int(p2)
        product = int(product)
        if product!=p2:
            ranks[product][p2] = score2*weights[1]
</code></pre>
<p>I get the error <code>KeyError: 655</code> at this line of my code:</p>
<pre><code>ranks[product][p2] = score2*weights[1]
</code></pre>
<p>However, there is no other detail about the error.</p>
<p>If I correctly understand the error, it means that the key <code>product</code> or <code>p2</code> do not exist in <code>ranks</code>, right? </p>
<p>How can I add the value <code>score2*weights[1]</code> to <code>ranks[product][p2]</code> if <code>product</code> or <code>p2</code> do not yet exist in <code>ranks</code>?</p>
</div>
<div class="post-text" itemprop="text">
<p>You alter <code>product</code> via <code>product = int(product)</code> between </p>
<pre><code>ranks[product] = {}
</code></pre>
<p>and </p>
<pre><code>ranks[product][p2] = score2*weights[0]
</code></pre>
<p>So the new integer <code>product</code> is no longer guaranteed to be a key in <code>ranks</code>. Move that conversion line all the way up to the beginning of the loop:</p>
<pre><code>product = int(product)
ranks[product] = {}
# rest
</code></pre>
<p>In the second loop you take no measures to check if those products are even present in <code>ranks</code>. Generally, you could ease your life using a <a href="https://docs.python.org/3/library/collections.html#collections.defaultdict" rel="nofollow noreferrer"><code>defaultdict</code></a> and a function in order to avoid repeating yourself:</p>
<pre><code>from collections import defaultdict

weights = [0.1, 0.2]
ranks = defaultdict(dict)

def process(dct, wght):
    for product, Rank in dct.items():
        product = int(product)  # convert here
        for p2, score2 in Rank:
            p2 = int(p2)
            if product != p2:
                ranks[product][p2] = score2 * wght

process(myDictionary1, weights[0])
process(myDictionary2, weights[1])
</code></pre>
</div>
<span class="comment-copy"><code>ranks[product] = dict(p2=score2*weights[1])</code></span>
<span class="comment-copy">@GarbageCollector: Basically, I want to check if the key exists. If it does not exist, I want to run <code>ranks[product] = {}</code> before <code>ranks[product][p2] = score2*weights[1]</code>. How can I do it?</span>
<span class="comment-copy">I have two for each loops. In each of these loops I might find different <code>product</code>. I'm not sure that I understand correctly your proposal. Could you please post my code with your updates?</span>
<span class="comment-copy">Can I use <code>ranks[product] = ranks.get(product,{})</code> instead of <code>if product not in ranks: ranks[product] = {}</code>?</span>
<span class="comment-copy">Yup, that's just as good.</span>
<span class="comment-copy">@Markus <code>ranks.setdefault(product, {})</code></span>
