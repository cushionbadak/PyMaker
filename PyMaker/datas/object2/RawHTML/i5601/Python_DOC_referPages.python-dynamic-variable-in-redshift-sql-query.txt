<div class="post-text" itemprop="text">
<p>I'm developing in a python environment and I want to call an sql query using <code>psycopg2</code></p>
<p>Lets say I have the following UNLOAD command in an .sql file:</p>
<pre><code>UNLOAD 
(
'
Some SQL Query
'
)
TO 's3://%PATH%'
...
</code></pre>
<p>In the sql file the <code>%PATH%</code> should be explicit like: <code>'folder1/folder3/file_name'</code>. </p>
<p>But I want the python program to set this <code>%PATH%</code> in runtime. which means that the .sql file containts something like <code>%PATH%</code> and will be set only in runtime.</p>
<p>Any idea of how to do it?</p>
</div>
<div class="post-text" itemprop="text">
<p>You simply specify a <a href="https://docs.python.org/3/library/string.html#format-string-syntax" rel="nofollow noreferrer">replacement field</a> in your SQL file, and the use a format command. </p>
<p>Create your file like this</p>
<pre><code>UNLOAD ('Some SQL Query')
TO 's3://{bucket}/{key}'
</code></pre>
<p>And use this file in python like</p>
<pre><code>template = open('file1.sql', 'r').read()
query = template.format(bucket='mybucket', key='folder/file.csv')
</code></pre>
</div>
<div class="post-text" itemprop="text">
<p>Implementing it this way will give you a tough time. </p>
<p>The best way to do is to dump the file at a static location:</p>
<pre><code>UNLOAD 
(
'
Some SQL Query
'
)
TO 's3://path/to/static/s3_bucket'
...
</code></pre>
<p>and then use (via a shellscript / or opt for a suitable command for any other script)</p>
<p><code>aws s3 mv $source $destination</code></p>
<p>Here, you may pass any value for  <code>$destination</code> which can be easily populated during run-time.</p>
<blockquote>
<p>In short, you've dumped the file in s3 at a fixed location (using
  UNLOAD) and moved it to the location of your choice or a location
  populated at run time (using aws s3 mv...)</p>
</blockquote>
</div>
<div class="post-text" itemprop="text">
<p>You would not be able to set up the UNLOAD path dynamically at runtime, however you could put your SQL statement in a something like a shell/python script where you can create variables with the path you'd like and then pass them into the query.</p>
<p><a href="https://github.com/awslabs/amazon-redshift-utils/blob/master/src/UnloadCopyUtility/redshift-unload-copy.py" rel="nofollow noreferrer">This</a> UNLOAD utility by AWS will get you started if you decide to go with a python script.</p>
</div>
<span class="comment-copy">why not just concat the query using the static part as string and the filename from the external variable? then you're able to assign this variable from command line parameter</span>
<span class="comment-copy">I would hope for a more structured solution. For when I open and read the sql file I just write something like '%PATH% = python_var' and its over.</span>
<span class="comment-copy">That's exactly what I wanted. Alas I've already implemented the other solution. But when I refactor I will certainly change it to the "replacement field" solution. Thanks.</span>
<span class="comment-copy">How exactly do I run <code>aws s3 mv $source $destination</code> from python ?</span>
<span class="comment-copy">Install an aws cli on your machine. You can find some help at: <a href="https://stackoverflow.com/questions/24536583/bash-script-to-install-aws-cli-tools" title="bash script to install aws cli tools">stackoverflow.com/questions/24536583/â€¦</a> This'll help you to work with your s3 buckets from cli.</span>
<span class="comment-copy">Well I took your idea, to just copy and delete. used boto3 though.</span>
