<div class="post-text" itemprop="text">
<p>I'm learning python multiprocessing module and I've found <a href="http://sebastianraschka.com/Articles/2014_multiprocessing_intro.html" rel="nofollow">this</a> example (this is a bit modified version):</p>
<pre><code>#!/bin/env python
import multiprocessing as mp
import random
import string
import time

# Define an output queue
output = mp.Queue()

# define a example function
def rand_string(length, output):
    time.sleep(1)
    """ Generates a random string of numbers, lower- and uppercase chars. """
    rand_str = ''.join(random.choice(
                    string.ascii_lowercase
                    + string.ascii_uppercase
                    + string.digits)
               for i in range(length))
    result = (len(rand_str), rand_str)
    print result
    time.sleep(1)
    output.put(result)


def queue_size(queue):
    size = int(queue.qsize())
    print size


# Setup a list of processes that we want to run
processes = [mp.Process(target=rand_string, args=(x, output)) for x in range(1,10)]


# Run processes
for p in processes:
    p.start()


# Exit the completed processes
for p in processes:
    p.join()


# Get process results from the output queue
results = [output.get() for p in processes]
print(results)
</code></pre>
<p>The output of this is following:</p>
<pre><code>(3, 'amF')
(1, 'c')
(6, '714CUg')
(4, '10Qg')
(5, 'Yns6h')
(7, 'wsSXj3Z')
(9, 'KRcDTtVZA')
(2, 'Qy')
(8, '50LpMzG9')
[(3, 'amF'), (1, 'c'), (6, '714CUg'), (4, '10Qg'), (5, 'Yns6h'), (9, 'KRcDTtVZA'), (2, 'Qy'), (7, 'wsSXj3Z'), (8, '50LpMzG9')]
</code></pre>
<p>I understand that processes are not called in order which they was created (using <code>processes = [mp.Process(target=rand_string, args=(x, output)) for x in range(1,10)]</code>) this is mentioned in referred article. What I do not understand (or I'm not sure if understand correct) is why the order of <code>result</code> does not corresponds with the order in which print outputs the <code>result</code> to STDOUT? My understanding of this is that those three operations are not atomic (I mean that they can be separated by process switch):</p>
<pre><code>    print result
    time.sleep(1)
    output.put(result)
</code></pre>
<p>Basically what happens here is that in the moment when process <code>print</code> the <code>results</code> to STDOUT it is switched to another process which writes to <code>results</code>. Something like that:</p>
<pre><code>Time 
------------------------------------------------------------------------------------------------------------------&gt;
Process1: print results |               |                                    | time.sleep(1) | output.put(result) |
Process2:               | print results | time.sleep(1) | output.put(result) |               |                    |
</code></pre>
<p>In this case the output on STDOUT would be:</p>
<pre><code>(1, 'c')
(2, 's5')
</code></pre>
<p>But the actual content of <code>results</code> will be:</p>
<p><code>[ (2, 's5') (1, 'c')]</code></p>
<p>And for the same reason the processes are not stared in order as they ware created.</p>
<p>Am I right?</p>
</div>
<div class="post-text" itemprop="text">
<p>You're right. The operating system <a href="https://en.wikipedia.org/wiki/Kernel_(operating_system)" rel="nofollow">kernel</a> can and will perform context switches however and whenever it pleases to do so. The Python interpreter (or Just-In-Time compiler or whatever) is an <a href="https://en.wikipedia.org/wiki/User_space" rel="nofollow">userspace</a> program, thus being totally controlled by the kernel.</p>
<p>This "kernel/user slavery" thus is passed "from father to child", or in other words, the Python program is in merced of the interpreter, which is in turn in merced of the kernel.</p>
<p>As such, the only way a userspace program (such as a Python application) can assure synchronization is by the use of locking primitives, such as <a href="https://docs.python.org/2/library/mutex.html" rel="nofollow">mutex</a>es or other <a href="https://docs.python.org/3/library/asyncio-sync.html" rel="nofollow">synchronization primitives</a>.</p>
<p>Now, in real world, what usually causes a context switch in a write to a file (such as stdout, as done by <code>print</code> by default), a <em>lot</em> of expensive operations shall be done, such as <a href="https://en.wikipedia.org/wiki/System_call" rel="nofollow">system calls</a>, complex memory remappings and black-magic-ies, and loopback mechanisms (such as when <code>stdout</code> refers to a <a href="https://en.wikipedia.org/wiki/Pseudoterminal" rel="nofollow">pseudo-terminal</a>, which is the most common case today).</p>
</div>
<div class="post-text" itemprop="text">
<p>Yes, you are right -- processes do not execute in lock-step.  Modern OSes use sophisticated algorithms to decide when to switch from one process to another, but those algorithms do not impart any sort of guarantee to any process about how it will progress vs another process of the same priority (and usually only limited guarantees about processes of different priorities).</p>
<p>Typically, a process is blocked when it is waiting on the OS, or when the current timeslice (based off a hardware tick interrupt) expires.  These occur periodically, but the amount of time a foreground task receives during a tick varies substantially depending on what is going on in the background, and when exactly the process was switched in (perhaps because another process was switched out because it blocked on I/O).</p>
<p>It is quite likely that if you re-run your test with different system loading, you will get different results.  (And the more work each process has to do, the more likely you will see different results, as well.)</p>
</div>
<span class="comment-copy">You are right that there is no guarantee of order or atomicity.  So what is the question?</span>
<span class="comment-copy">This was the question :), I was not sure If I understand it correctly.</span>
<span class="comment-copy">Tank you very much. I've up-voted your answer.</span>
<span class="comment-copy">Tank you very much. I've up-voted your answer.</span>
