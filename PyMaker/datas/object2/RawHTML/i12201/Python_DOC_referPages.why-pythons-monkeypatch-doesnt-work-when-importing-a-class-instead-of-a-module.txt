<div class="post-text" itemprop="text">
<p>I was having issues while using the code of the accepted answer <a href="https://stackoverflow.com/questions/20503373/how-to-monkeypatch-pythons-datetime-datetime-now-with-py-test">here</a>.</p>
<p><em>The code works depending on how I do the import of datetime.</em> Why is that? Is it possible to mock it so it works both ways?</p>
<p>I am using <code>Python 3.4</code>. The following code illustrates the problem:</p>
<pre><code>import pytest
from datetime import datetime

mockdate = datetime(2000, 1, 1, 0, 0, 0)

@pytest.fixture(autouse=True)
def patch_datetime_now(monkeypatch):
    class mydatetime:
        @classmethod
        def now(cls):
            return mockdate

    monkeypatch.setattr('datetime.datetime', mydatetime)

def test_doesnt_work():
    assert datetime.now() == mockdate

def test_works():
    import datetime
    assert datetime.datetime.now() == mockdate
</code></pre>
</div>
<div class="post-text" itemprop="text">
<p>Even if you aren't using <a href="https://docs.python.org/3/library/unittest.mock.html" rel="noreferrer"><code>mock</code></a> framework you should take a look to <a href="https://docs.python.org/3/library/unittest.mock.html#where-to-patch" rel="noreferrer"><em>where to patch</em></a> chapter. By writing</p>
<pre><code>from datetime import datetime
</code></pre>
<p>You are creating a new reference to <code>datetime.datetime</code> in your test module and call it <code>datetime</code>. That is the reference that you use in <code>test_doesnt_work()</code> test.</p>
<p>By writing</p>
<pre><code>monkeypatch.setattr('datetime.datetime', mydatetime)
</code></pre>
<p>You are patching <code>datetime</code>'s absolute reference in <code>datetime</code> module: the one used in <code>test_works()</code>.</p>
</div>
<div class="post-text" itemprop="text">
<p>@Michele d'Amico's answer explains why it doesn't work. This is how to make it work if you want to use "from datetime import datetime" instead of just "import datetime"</p>
<pre><code>monkeypatch.setattr(__name__ + '.datetime', mydatetime)
</code></pre>
</div>
<span class="comment-copy">Thanks, that's useful. So, would you know of any way to make it work with "from datetime import datetime" instead of "import datetime"?</span>
<span class="comment-copy">Sure you should patch <code>yourmodule.datetime</code> instead. Take a look to mock framework: you can fine <code>patch</code> very useful.</span>
<span class="comment-copy">I have created a new answer with the solution, but I still think it's fair I mark your answer as accepted. Cheers!</span>
