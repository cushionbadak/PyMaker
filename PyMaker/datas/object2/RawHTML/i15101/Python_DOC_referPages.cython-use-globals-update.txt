<div class="post-text" itemprop="text">
<p>I am writing a Python bytecode optimizer for a module that previously had a Cython tool-chain. While that may be deprecated by now, I encountered something strange while fiddling with it. Consider this simple piece of code:</p>
<pre><code>from opcode import opmap

globals().update(opmap)

print(STORE_GLOBAL)
</code></pre>
<p>This should print 97, as <code>STORE_GLOBAL</code> is defined in <code>opmap</code> with its opcode(which is 97). Cython will tell me that <code>STORE_GLOBAL</code> is not defined, though:</p>
<pre><code>Error compiling Cython file:
------------------------------------------------------------
...
from opcode import opmap

globals().update(opmap)

print(STORE_GLOBAL)
                 ^
------------------------------------------------------------

test.py:5:18: undeclared name not builtin: STORE_GLOBAL
</code></pre>
<p>The reason for that is pretty easy, I guess. I assume that it doesn't update the globals, so it does not know about <code>STORE_GLOBAL</code> now being a variable. </p>
<p>Is there a unhacky way to overcome this problem?</p>
<p>Cheers</p>
</div>
<div class="post-text" itemprop="text">
<p>The reason is that while cython modules have a global namespace that is exposed in python, this is namespace is only used to export python visible variables.</p>
<p>However, most variables are not visible to python. These variables are declared at compile time and are statically typed. It is assumed that any variable referenced that is not declared in the module is an error, rather hoping the variable will be added later to the module globals.</p>
<p>The only way to circumvent this is to refer to such variables via the modules globals. Not very elegant.</p>
<pre><code>print(globals()["STORE_GLOBAL"])
</code></pre>
<p>The best alternatives are to import <code>opmap</code> and refer to the relevant values through that. Or to write out the values in opmap verbatim in your module.</p>
</div>
<div class="post-text" itemprop="text">
<p>I don't know if this is documented anywhere, but I've found that if a name is declared in a <a href="https://docs.python.org/3/reference/simple_stmts.html#the-global-statement" rel="nofollow noreferrer"><code>global</code></a> statement in any function in a Cython module, then in addition to the standard Python meaning of "this name should be read and written as a global variable in <em>this</em> function", it also has the side effect of allowing the name to be <em>read</em> as a global variable everywhere else in the module, suppressing the error in the question.</p>
</div>
<span class="comment-copy">Yeah, that is what I thought, too. Thanks for your clarification.</span>
