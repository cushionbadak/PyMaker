<div class="post-text" itemprop="text">
<p>I have a script for controlling some instruments during an experiment that looks like this:</p>
<pre><code>camera = Camera()
stage = Stage()
results = []
# loads of other initialization

for n in steps:
    stage.move(n)
    img = camera.capture()
    # loads of other function/method calls
    results.append(img)

results = np.array(results)
np.savetxt('data.txt',results)

camera.close()
stage.close()
</code></pre>
<p>If an Exception occurs inside the loop (e.g. some hardware problem for the camera or the stage), then I want to go save the <code>results</code> and close the instruments. If an Exception occurs before the loop, then I just want to close the instruments. How to do this? I can put many <code>try/except</code> statements, but are there other better methods?</p>
</div>
<div class="post-text" itemprop="text">
<p>You have several options. You could register <a href="https://docs.python.org/3/library/atexit.html" rel="nofollow noreferrer">atexit</a> handlers as needed (first, one that would close the instruments), then before the loop, one that would save results. Though, meh.</p>
<p>Using two try/except:</p>
<pre><code>try:
    camera = Camera()
    stage = Stage()
    results = []
    # loads of other initialization

    try:
        for n in steps:
            stage.move(n)
            img = camera.capture()
            # loads of other function/method calls
            results.append(img)
    finally:
         results = np.array(results)
         np.savetxt('data.txt',results)
finally:
    camera.close()
    stage.close()
</code></pre>
<p>Maybe:</p>
<pre><code>try:
    do_save = False
    camera = Camera()
    stage = Stage()
    results = []
    # loads of other initialization

    do_save = True
    for n in steps:
        stage.move(n)
        img = camera.capture()
        # loads of other function/method calls
        results.append(img)
finally:
    if do_save:
        results = np.array(results)
        np.savetxt('data.txt',results)
    camera.close()
    stage.close()
</code></pre>
</div>
<div class="post-text" itemprop="text">
<p>You can use a <code>try-finally</code> statement.</p>
<pre><code>camera = Camera()
stage = Stage()
try:
  # do stuff
finally:
  camera.close()
  stage.close()
</code></pre>
</div>
<span class="comment-copy">Possible duplicate of <a href="https://stackoverflow.com/questions/3850261/doing-something-before-program-exit">Doing something before program exit</a></span>
